"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CsiDriverProviderAws = void 0;
const cdk = require("aws-cdk-lib");
const yaml_utils_1 = require("../../utils/yaml-utils");
const ts_deepmerge_1 = require("ts-deepmerge");
const helm_addon_1 = require("../helm-addon");
class CsiDriverProviderAws {
    constructor(props) {
        this.props = props;
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let values = {
            grpcSupportedProviders: 'aws'
        };
        if (typeof (this.props.rotationPollInterval) === 'string') {
            values.enableSecretRotation = 'true';
            values.rotationPollInterval = this.props.rotationPollInterval;
        }
        if (this.props.syncSecrets === true) {
            values.syncSecret = {
                enabled: 'true'
            };
        }
        values = (0, ts_deepmerge_1.default)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        const helmChartOptions = {
            chart: this.props.chart,
            repository: this.props.repository,
            namespace: this.props.namespace,
            release: this.props.release,
            version: this.props.version,
            wait: true,
            timeout: cdk.Duration.minutes(15),
            values,
        };
        helm_addon_1.HelmAddOn.validateVersion({
            chart: helmChartOptions.chart,
            repository: helmChartOptions.repository,
            version: helmChartOptions.version
        });
        const secretStoreCSIDriverHelmChart = cluster.addHelmChart('SecretsStoreCSIDriver', helmChartOptions);
        const manifestUrl = this.props.ascpUrl;
        const manifest = (0, yaml_utils_1.loadExternalYaml)(manifestUrl);
        const secretProviderManifest = clusterInfo.cluster.addManifest('SecretsStoreCsiDriverProviderAws', ...manifest);
        secretProviderManifest.node.addDependency(secretStoreCSIDriverHelmChart);
        return secretProviderManifest;
    }
}
exports.CsiDriverProviderAws = CsiDriverProviderAws;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NpLWRyaXZlci1wcm92aWRlci1hd3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL3NlY3JldHMtc3RvcmUvY3NpLWRyaXZlci1wcm92aWRlci1hd3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBRW5DLHVEQUEwRDtBQUcxRCwrQ0FBaUM7QUFDakMsOENBQTBDO0FBRzFDLE1BQWEsb0JBQW9CO0lBRS9CLFlBQW9CLEtBQTZCO1FBQTdCLFVBQUssR0FBTCxLQUFLLENBQXdCO0lBQUcsQ0FBQztJQUVyRCxNQUFNLENBQUMsV0FBd0I7O1FBQzdCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFXcEMsSUFBSSxNQUFNLEdBQWdCO1lBQ3hCLHNCQUFzQixFQUFFLEtBQUs7U0FDOUIsQ0FBQztRQUVGLElBQUksT0FBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDeEQsTUFBTSxDQUFDLG9CQUFvQixHQUFHLE1BQU0sQ0FBQztZQUNyQyxNQUFNLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztTQUMvRDtRQUVELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEtBQUssSUFBSSxFQUFFO1lBQ25DLE1BQU0sQ0FBQyxVQUFVLEdBQUc7Z0JBQ2xCLE9BQU8sRUFBRSxNQUFNO2FBQ2hCLENBQUM7U0FDSDtRQUVELE1BQU0sR0FBRyxJQUFBLHNCQUFLLEVBQUMsTUFBTSxFQUFFLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLG1DQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRWhELE1BQU0sZ0JBQWdCLEdBQUc7WUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBTTtZQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFXO1lBQ2xDLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVU7WUFDaEMsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTztZQUMzQixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPO1lBQzNCLElBQUksRUFBRSxJQUFJO1lBQ1YsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxNQUFNO1NBQ1AsQ0FBQztRQUVKLHNCQUFTLENBQUMsZUFBZSxDQUFDO1lBQ3RCLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxLQUFLO1lBQzdCLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxVQUFVO1lBQ3ZDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxPQUFRO1NBQ3JDLENBQUMsQ0FBQztRQUVILE1BQU0sNkJBQTZCLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyx1QkFBdUIsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBRXRHLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBUSxDQUFDO1FBQ3hDLE1BQU0sUUFBUSxHQUEwQixJQUFBLDZCQUFnQixFQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sc0JBQXNCLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQztRQUNoSCxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDekUsT0FBTyxzQkFBc0IsQ0FBQztJQUNoQyxDQUFDO0NBQ0Y7QUExREQsb0RBMERDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBsb2FkRXh0ZXJuYWxZYW1sIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3lhbWwtdXRpbHNcIjtcbmltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgeyBTZWNyZXRzU3RvcmVBZGRPblByb3BzIH0gZnJvbSBcIi5cIjtcbmltcG9ydCBtZXJnZSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24gfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xuXG5cbmV4cG9ydCBjbGFzcyBDc2lEcml2ZXJQcm92aWRlckF3cyB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwcm9wczogU2VjcmV0c1N0b3JlQWRkT25Qcm9wcykge31cblxuICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogS3ViZXJuZXRlc01hbmlmZXN0IHtcbiAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcblxuICAgIHR5cGUgY2hhcnRWYWx1ZXMgPSB7XG4gICAgICBlbmFibGVTZWNyZXRSb3RhdGlvbj86IHN0cmluZyxcbiAgICAgIHJvdGF0aW9uUG9sbEludGVydmFsPzogc3RyaW5nLFxuICAgICAgc3luY1NlY3JldD86IHtcbiAgICAgICAgZW5hYmxlZDogc3RyaW5nXG4gICAgICB9LFxuICAgICAgZ3JwY1N1cHBvcnRlZFByb3ZpZGVyczogc3RyaW5nXG4gICAgfVxuXG4gICAgbGV0IHZhbHVlczogY2hhcnRWYWx1ZXMgPSB7XG4gICAgICBncnBjU3VwcG9ydGVkUHJvdmlkZXJzOiAnYXdzJ1xuICAgIH07XG5cbiAgICBpZiAodHlwZW9mKHRoaXMucHJvcHMucm90YXRpb25Qb2xsSW50ZXJ2YWwpID09PSAnc3RyaW5nJykge1xuICAgICAgdmFsdWVzLmVuYWJsZVNlY3JldFJvdGF0aW9uID0gJ3RydWUnO1xuICAgICAgdmFsdWVzLnJvdGF0aW9uUG9sbEludGVydmFsID0gdGhpcy5wcm9wcy5yb3RhdGlvblBvbGxJbnRlcnZhbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy5zeW5jU2VjcmV0cyA9PT0gdHJ1ZSkge1xuICAgICAgdmFsdWVzLnN5bmNTZWNyZXQgPSB7XG4gICAgICAgIGVuYWJsZWQ6ICd0cnVlJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcbiAgICBcbiAgICBjb25zdCBoZWxtQ2hhcnRPcHRpb25zID0ge1xuICAgICAgICBjaGFydDogdGhpcy5wcm9wcy5jaGFydCEsXG4gICAgICAgIHJlcG9zaXRvcnk6IHRoaXMucHJvcHMucmVwb3NpdG9yeSEsXG4gICAgICAgIG5hbWVzcGFjZTogdGhpcy5wcm9wcy5uYW1lc3BhY2UhLFxuICAgICAgICByZWxlYXNlOiB0aGlzLnByb3BzLnJlbGVhc2UsXG4gICAgICAgIHZlcnNpb246IHRoaXMucHJvcHMudmVyc2lvbixcbiAgICAgICAgd2FpdDogdHJ1ZSxcbiAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgICB2YWx1ZXMsXG4gICAgICB9O1xuXG4gICAgSGVsbUFkZE9uLnZhbGlkYXRlVmVyc2lvbih7XG4gICAgICAgIGNoYXJ0OiBoZWxtQ2hhcnRPcHRpb25zLmNoYXJ0LFxuICAgICAgICByZXBvc2l0b3J5OiBoZWxtQ2hhcnRPcHRpb25zLnJlcG9zaXRvcnksXG4gICAgICAgIHZlcnNpb246IGhlbG1DaGFydE9wdGlvbnMudmVyc2lvbiFcbiAgICB9KTtcblxuICAgIGNvbnN0IHNlY3JldFN0b3JlQ1NJRHJpdmVySGVsbUNoYXJ0ID0gY2x1c3Rlci5hZGRIZWxtQ2hhcnQoJ1NlY3JldHNTdG9yZUNTSURyaXZlcicsIGhlbG1DaGFydE9wdGlvbnMpO1xuXG4gICAgY29uc3QgbWFuaWZlc3RVcmwgPSB0aGlzLnByb3BzLmFzY3BVcmwhO1xuICAgIGNvbnN0IG1hbmlmZXN0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+W10gPSBsb2FkRXh0ZXJuYWxZYW1sKG1hbmlmZXN0VXJsKTtcbiAgICBjb25zdCBzZWNyZXRQcm92aWRlck1hbmlmZXN0ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdCgnU2VjcmV0c1N0b3JlQ3NpRHJpdmVyUHJvdmlkZXJBd3MnLCAuLi5tYW5pZmVzdCk7XG4gICAgc2VjcmV0UHJvdmlkZXJNYW5pZmVzdC5ub2RlLmFkZERlcGVuZGVuY3koc2VjcmV0U3RvcmVDU0lEcml2ZXJIZWxtQ2hhcnQpO1xuICAgIHJldHVybiBzZWNyZXRQcm92aWRlck1hbmlmZXN0O1xuICB9XG59Il19