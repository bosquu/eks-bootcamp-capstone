"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmpAddOn = void 0;
const aps = require("aws-cdk-lib/aws-aps");
const utils_1 = require("../../utils");
const adot_1 = require("../adot");
const kubectl_provider_1 = require("../helm-addon/kubectl-provider");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    workspaceName: 'blueprints-amp-workspace',
    deploymentMode: "deployment" /* DeploymentMode.DEPLOYMENT */,
    name: 'adot-collector-amp',
    namespace: 'default'
};
/**
 * Implementation of AMP add-on for EKS Blueprints. Installs ADOT Collector.
 */
class AmpAddOn {
    constructor(props) {
        this.ampAddOnProps = { ...defaultProps, ...props };
    }
    deploy(clusterInfo) {
        const cluster = clusterInfo.cluster;
        let doc;
        let cfnWorkspace;
        let cfnWorkspaceProps = {
            alias: this.ampAddOnProps.workspaceName,
            tags: this.ampAddOnProps.workspaceTags
        };
        if (typeof (this.ampAddOnProps.prometheusRemoteWriteURL) == 'undefined' || this.ampAddOnProps.prometheusRemoteWriteURL == null) {
            cfnWorkspace = new aps.CfnWorkspace(cluster.stack, this.ampAddOnProps.workspaceName + "-amp-workspace", cfnWorkspaceProps); /* all optional props */
            const ampUrlEndpoint = cfnWorkspace.attrPrometheusEndpoint;
            this.ampAddOnProps.prometheusRemoteWriteURL = ampUrlEndpoint + 'api/v1/remote_write';
        }
        // Applying manifest for configuring ADOT Collector for Amp.
        if (this.ampAddOnProps.deploymentMode == "daemonset" /* DeploymentMode.DAEMONSET */) {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp-daemonset.ytpl');
        }
        else {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp.ytpl');
        }
        const manifest = doc.split("---").map(e => (0, utils_1.loadYaml)(e));
        const values = {
            remoteWriteEndpoint: this.ampAddOnProps.prometheusRemoteWriteURL,
            awsRegion: cluster.stack.region,
            deploymentMode: this.ampAddOnProps.deploymentMode,
            namespace: this.ampAddOnProps.namespace,
        };
        const manifestDeployment = {
            name: this.ampAddOnProps.name,
            namespace: this.ampAddOnProps.namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        if (cfnWorkspace) {
            statement.node.addDependency(cfnWorkspace);
        }
        return Promise.resolve(statement);
    }
}
__decorate([
    (0, utils_1.dependable)(adot_1.AdotCollectorAddOn.name)
], AmpAddOn.prototype, "deploy", null);
exports.AmpAddOn = AmpAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FtcC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBMkM7QUFHM0MsdUNBQXFFO0FBQ3JFLGtDQUE2QztBQUc3QyxxRUFBcUY7QUFtRHJGOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsYUFBYSxFQUFFLDBCQUEwQjtJQUN6QyxjQUFjLDhDQUEyQjtJQUN6QyxJQUFJLEVBQUUsb0JBQW9CO0lBQzFCLFNBQVMsRUFBRSxTQUFTO0NBQ3ZCLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQWEsUUFBUTtJQUlqQixZQUFZLEtBQXFCO1FBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7UUFDM0IsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFJLEdBQVcsQ0FBQztRQUNoQixJQUFJLFlBQXdDLENBQUM7UUFFN0MsSUFBSSxpQkFBaUIsR0FBd0I7WUFDekMsS0FBSyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYTtZQUN2QyxJQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhO1NBQ3pDLENBQUM7UUFFRixJQUFJLE9BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLElBQUksV0FBVyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsd0JBQXdCLElBQUksSUFBSSxFQUFHO1lBQzVILFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsR0FBRyxnQkFBZ0IsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDLENBQUEsd0JBQXdCO1lBQ25KLE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQyxzQkFBc0IsQ0FBQztZQUMzRCxJQUFJLENBQUMsYUFBYSxDQUFDLHdCQUF3QixHQUFHLGNBQWMsR0FBRyxxQkFBcUIsQ0FBQztTQUN4RjtRQUVELDREQUE0RDtRQUM1RCxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyw4Q0FBNEIsRUFBRTtZQUMvRCxHQUFHLEdBQUcsSUFBQSx3QkFBZ0IsRUFBQyxTQUFTLEdBQUUsc0NBQXNDLENBQUMsQ0FBQztTQUM3RTthQUNJO1lBQ0QsR0FBRyxHQUFHLElBQUEsd0JBQWdCLEVBQUMsU0FBUyxHQUFHLDRCQUE0QixDQUFDLENBQUM7U0FDcEU7UUFFRCxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUEsZ0JBQVEsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELE1BQU0sTUFBTSxHQUFXO1lBQ25CLG1CQUFtQixFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsd0JBQXdCO1lBQ2hFLFNBQVMsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU07WUFDL0IsY0FBYyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYztZQUNqRCxTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTO1NBQ3pDLENBQUM7UUFFRixNQUFNLGtCQUFrQixHQUF1QjtZQUM1QyxJQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFLO1lBQzlCLFNBQVMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVU7WUFDeEMsUUFBUTtZQUNSLE1BQU07U0FDVCxDQUFDO1FBRUYsTUFBTSxlQUFlLEdBQUcsSUFBSSxrQ0FBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sU0FBUyxHQUFHLGVBQWUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNsRSxJQUFJLFlBQVksRUFBQztZQUNiLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQzlDO1FBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Q0FDSjtBQS9DRztJQURDLElBQUEsa0JBQVUsRUFBQyx5QkFBa0IsQ0FBQyxJQUFJLENBQUM7c0NBK0NuQztBQXZETCw0QkF3REMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhcHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcyc7XG5pbXBvcnQgeyBDZm5Xb3Jrc3BhY2VQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHMnO1xuaW1wb3J0IHsgQ2x1c3RlckFkZE9uLCBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgZGVwZW5kYWJsZSwgbG9hZFlhbWwsIHJlYWRZYW1sRG9jdW1lbnQgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCB7IEFkb3RDb2xsZWN0b3JBZGRPbiB9IGZyb20gXCIuLi9hZG90XCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENmblRhZyB9IGZyb20gXCJhd3MtY2RrLWxpYi9jb3JlXCI7XG5pbXBvcnQgeyBLdWJlY3RsUHJvdmlkZXIsIE1hbmlmZXN0RGVwbG95bWVudCB9IGZyb20gXCIuLi9oZWxtLWFkZG9uL2t1YmVjdGwtcHJvdmlkZXJcIjtcblxuLyoqXG4gKiBUaGlzIEFNUCBhZGQtb24gaW5zdGFsbHMgYW4gQURPVCBDb2xsZWN0b3IgZm9yIEFtYXpvbiBNYW5hZ2VkIFNlcnZpY2UgZm9yIFByb21ldGhldXMgXG4gKiAoQU1QKSBhbmQgY3JlYXRlcyBhbiBBTVAgd29ycHNhY2UgdG8gcmVjZWl2ZSBPVExQIG1ldHJpY3MgZnJvbSB0aGUgYXBwbGljYXRpb24gYW5kIFxuICogUHJvbWV0aGV1cyBtZXRyaWNzIHNjcmFwZWQgZnJvbSBwb2RzIG9uIHRoZSBjbHVzdGVyIGFuZCByZW1vdGUgd3JpdGVzIHRoZSBtZXRyaWNzIFxuICogdG8gQU1QIHJlbW90ZSB3cml0ZSBlbmRwb2ludCBvZiB0aGUgY3JlYXRlZCBvciBwYXNzZWQgQU1QIHdvcmtzcGFjZS5cbiAqL1xuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFtcEFkZE9uUHJvcHMge1xuICAgIC8qKlxuICAgICAqIE5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgYnkgdGhlIGFkZC1vbiB0byBjcmVhdGUgdGhlIFdvcmtzcGFjZVxuICAgICAqIEBkZWZhdWx0IGJsdWVwcmludHMtYW1wLXdvcmtzcGFjZVxuICAgICAqL1xuICAgIHdvcmtzcGFjZU5hbWU/OiBzdHJpbmc7XG4gICAgLyoqIFxuICAgICAqIFJlbW90ZSBXcml0ZSBVUkwgb2YgdGhlIEFNUCBXb3Jrc3BhY2UgdG8gYmUgdXNlZCBmb3Igc2V0dGluZyB1cCByZW1vdGUgd3JpdGUuXG4gICAgICovXG4gICAgIHByb21ldGhldXNSZW1vdGVXcml0ZVVSTD86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBUYWdzIHRvIHBhc3NlZCB3aGlsZSBjcmVhdGluZyBBTVAgd29ya3NwYWNlXG4gICAgICogQGRlZmF1bHQgUHJvamVjdFxuICAgICAqL1xuICAgICB3b3Jrc3BhY2VUYWdzPzogQ2ZuVGFnW107XG4gICAgLyoqXG4gICAgICogTW9kZXMgc3VwcG9ydGVkIDogYGRlcGxveW1lbnRgLCBgZGFlbW9uc2V0YCwgYHN0YXRlZnVsU2V0YCwgYW5kIGBzaWRlY2FyYFxuICAgICAqIEBkZWZhdWx0IGRlcGxveW1lbnRcbiAgICAgKi9cbiAgICAgZGVwbG95bWVudE1vZGU/OiBEZXBsb3ltZW50TW9kZTtcbiAgICAvKipcbiAgICAgKiBOYW1lc3BhY2UgdG8gZGVwbG95IHRoZSBBRE9UIENvbGxlY3RvciBmb3IgQU1QLlxuICAgICAqIEBkZWZhdWx0IGRlZmF1bHRcbiAgICAgKi9cbiAgICAgbmFtZXNwYWNlPzogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIE5hbWUgZm9yIGRlcGxveW1lbnQgb2YgdGhlIEFET1QgQ29sbGVjdG9yIGZvciBBTVAuXG4gICAgICogQGRlZmF1bHQgJ2Fkb3QtY29sbGVjdG9yLWFtcCdcbiAgICAgKi9cbiAgICAgbmFtZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IGVudW0gRGVwbG95bWVudE1vZGUge1xuICAgIERFUExPWU1FTlQgPSAnZGVwbG95bWVudCcsXG4gICAgREFFTU9OU0VUID0gJ2RhZW1vbnNldCcsXG4gICAgU1RBVEVGVUxTRVQgPSAnc3RhdGVmdWxzZXQnLFxuICAgIFNJREVDQVIgPSAnc2lkZWNhcidcbn1cblxuLyoqXG4gKiBEZWZhdWx0cyBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgICB3b3Jrc3BhY2VOYW1lOiAnYmx1ZXByaW50cy1hbXAtd29ya3NwYWNlJyxcbiAgICBkZXBsb3ltZW50TW9kZTogRGVwbG95bWVudE1vZGUuREVQTE9ZTUVOVCxcbiAgICBuYW1lOiAnYWRvdC1jb2xsZWN0b3ItYW1wJyxcbiAgICBuYW1lc3BhY2U6ICdkZWZhdWx0J1xufTtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiBBTVAgYWRkLW9uIGZvciBFS1MgQmx1ZXByaW50cy4gSW5zdGFsbHMgQURPVCBDb2xsZWN0b3IuXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBBZGRPbiBpbXBsZW1lbnRzIENsdXN0ZXJBZGRPbiB7XG5cbiAgICByZWFkb25seSBhbXBBZGRPblByb3BzOiBBbXBBZGRPblByb3BzO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM/OiBBbXBBZGRPblByb3BzKSB7XG4gICAgICAgIHRoaXMuYW1wQWRkT25Qcm9wcyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgIH1cblxuICAgIEBkZXBlbmRhYmxlKEFkb3RDb2xsZWN0b3JBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgbGV0IGRvYzogc3RyaW5nO1xuICAgICAgICBsZXQgY2ZuV29ya3NwYWNlOiBhcHMuQ2ZuV29ya3NwYWNlfHVuZGVmaW5lZDtcbiAgICAgICAgXG4gICAgICAgIGxldCBjZm5Xb3Jrc3BhY2VQcm9wcyA6IENmbldvcmtzcGFjZVByb3BzICA9IHtcbiAgICAgICAgICAgIGFsaWFzOiB0aGlzLmFtcEFkZE9uUHJvcHMud29ya3NwYWNlTmFtZSwgIFxuICAgICAgICAgICAgdGFnczogdGhpcy5hbXBBZGRPblByb3BzLndvcmtzcGFjZVRhZ3NcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodHlwZW9mKHRoaXMuYW1wQWRkT25Qcm9wcy5wcm9tZXRoZXVzUmVtb3RlV3JpdGVVUkwpID09ICd1bmRlZmluZWQnIHx8IHRoaXMuYW1wQWRkT25Qcm9wcy5wcm9tZXRoZXVzUmVtb3RlV3JpdGVVUkwgPT0gbnVsbCApIHtcbiAgICAgICAgICAgIGNmbldvcmtzcGFjZSA9IG5ldyBhcHMuQ2ZuV29ya3NwYWNlKGNsdXN0ZXIuc3RhY2ssIHRoaXMuYW1wQWRkT25Qcm9wcy53b3Jrc3BhY2VOYW1lICsgXCItYW1wLXdvcmtzcGFjZVwiLCBjZm5Xb3Jrc3BhY2VQcm9wcyk7LyogYWxsIG9wdGlvbmFsIHByb3BzICovIFxuICAgICAgICAgICAgY29uc3QgYW1wVXJsRW5kcG9pbnQgPSBjZm5Xb3Jrc3BhY2UuYXR0clByb21ldGhldXNFbmRwb2ludDtcbiAgICAgICAgICAgIHRoaXMuYW1wQWRkT25Qcm9wcy5wcm9tZXRoZXVzUmVtb3RlV3JpdGVVUkwgPSBhbXBVcmxFbmRwb2ludCArICdhcGkvdjEvcmVtb3RlX3dyaXRlJztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFwcGx5aW5nIG1hbmlmZXN0IGZvciBjb25maWd1cmluZyBBRE9UIENvbGxlY3RvciBmb3IgQW1wLlxuICAgICAgICBpZiAodGhpcy5hbXBBZGRPblByb3BzLmRlcGxveW1lbnRNb2RlID09IERlcGxveW1lbnRNb2RlLkRBRU1PTlNFVCkge1xuICAgICAgICAgICAgZG9jID0gcmVhZFlhbWxEb2N1bWVudChfX2Rpcm5hbWUgKycvY29sbGVjdG9yLWNvbmZpZy1hbXAtZGFlbW9uc2V0Lnl0cGwnKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoX19kaXJuYW1lICsgJy9jb2xsZWN0b3ItY29uZmlnLWFtcC55dHBsJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtYW5pZmVzdCA9IGRvYy5zcGxpdChcIi0tLVwiKS5tYXAoZSA9PiBsb2FkWWFtbChlKSk7XG4gICAgICAgIGNvbnN0IHZhbHVlczogVmFsdWVzID0ge1xuICAgICAgICAgICAgcmVtb3RlV3JpdGVFbmRwb2ludDogdGhpcy5hbXBBZGRPblByb3BzLnByb21ldGhldXNSZW1vdGVXcml0ZVVSTCxcbiAgICAgICAgICAgIGF3c1JlZ2lvbjogY2x1c3Rlci5zdGFjay5yZWdpb24sXG4gICAgICAgICAgICBkZXBsb3ltZW50TW9kZTogdGhpcy5hbXBBZGRPblByb3BzLmRlcGxveW1lbnRNb2RlLFxuICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLmFtcEFkZE9uUHJvcHMubmFtZXNwYWNlLFxuICAgICAgICAgfTtcbiAgICAgICAgIFxuICAgICAgICAgY29uc3QgbWFuaWZlc3REZXBsb3ltZW50OiBNYW5pZmVzdERlcGxveW1lbnQgPSB7XG4gICAgICAgICAgICBuYW1lOiB0aGlzLmFtcEFkZE9uUHJvcHMubmFtZSEsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMuYW1wQWRkT25Qcm9wcy5uYW1lc3BhY2UhLFxuICAgICAgICAgICAgbWFuaWZlc3QsXG4gICAgICAgICAgICB2YWx1ZXNcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBrdWJlY3RsUHJvdmlkZXIgPSBuZXcgS3ViZWN0bFByb3ZpZGVyKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgY29uc3Qgc3RhdGVtZW50ID0ga3ViZWN0bFByb3ZpZGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0RGVwbG95bWVudCk7XG4gICAgICAgIGlmIChjZm5Xb3Jrc3BhY2Upe1xuICAgICAgICAgICAgc3RhdGVtZW50Lm5vZGUuYWRkRGVwZW5kZW5jeShjZm5Xb3Jrc3BhY2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdGF0ZW1lbnQpO1xuICAgIH1cbn1cbiJdfQ==