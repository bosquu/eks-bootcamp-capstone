"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KarpenterAddOn = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const iam_1 = require("./iam");
const md5 = require("ts-md5");
const KARPENTER = 'karpenter';
const RELEASE = 'blueprints-addon-karpenter';
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: KARPENTER,
    namespace: KARPENTER,
    version: '0.14.0',
    chart: KARPENTER,
    release: RELEASE,
    repository: 'https://charts.karpenter.sh',
};
/**
 * Implementation of the Karpenter add-on
 */
class KarpenterAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        const endpoint = clusterInfo.cluster.clusterEndpoint;
        const name = clusterInfo.cluster.clusterName;
        const cluster = clusterInfo.cluster;
        const stackName = clusterInfo.cluster.stack.stackName;
        const region = clusterInfo.cluster.stack.region;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        const provisionerSpecs = this.options.provisionerSpecs || {};
        const subnetTags = this.options.subnetTags || {};
        const sgTags = this.options.securityGroupTags || {};
        const taints = this.options.taints || [];
        const amiFamily = this.options.amiFamily;
        // Set up Node Role
        const karpenterNodeRole = new iam.Role(cluster, 'karpenter-node-role', {
            assumedBy: new iam.ServicePrincipal(`ec2.${cluster.stack.urlSuffix}`),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSWorkerNodePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKS_CNI_Policy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEC2ContainerRegistryReadOnly"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMManagedInstanceCore"),
            ],
            //roleName: `KarpenterNodeRole-${name}` // let role name to be generated as unique
        });
        // Set up Instance Profile
        const instanceProfileName = md5.Md5.hashStr(stackName + region);
        const karpenterInstanceProfile = new iam.CfnInstanceProfile(cluster, 'karpenter-instance-profile', {
            roles: [karpenterNodeRole.roleName],
            instanceProfileName: `KarpenterNodeInstanceProfile-${instanceProfileName}`,
            path: '/'
        });
        // Map Node Role to aws-auth
        cluster.awsAuth.addRoleMapping(karpenterNodeRole, {
            groups: ['system:bootstrapper', 'system:nodes'],
            username: 'system:node:{{EC2PrivateDNSName}}'
        });
        // Create Namespace
        const ns = (0, utils_1.createNamespace)(KARPENTER, cluster, true, true);
        const karpenterPolicyDocument = iam.PolicyDocument.fromJson(iam_1.KarpenterControllerPolicy);
        const sa = (0, utils_1.createServiceAccount)(cluster, RELEASE, KARPENTER, karpenterPolicyDocument);
        sa.node.addDependency(ns);
        // Add helm chart
        (0, utils_1.setPath)(values, "clusterEndpoint", endpoint);
        (0, utils_1.setPath)(values, "clusterName", name);
        (0, utils_1.setPath)(values, "aws.defaultInstanceProfile", karpenterInstanceProfile.instanceProfileName);
        const saValues = {
            serviceAccount: {
                create: false,
                name: RELEASE,
                annotations: {
                    "eks.amazonaws.com/role-arn": sa.role.roleArn,
                }
            }
        };
        values = (0, ts_deepmerge_1.default)(values, saValues);
        const karpenterChart = this.addHelmChart(clusterInfo, values, false, true);
        karpenterChart.node.addDependency(ns);
        // (Optional) default provisioner
        if ((Object.keys(subnetTags).length > 0) && (Object.keys(sgTags).length > 0)) {
            const provisioner = cluster.addManifest('default-provisioner', {
                apiVersion: 'karpenter.sh/v1alpha5',
                kind: 'Provisioner',
                metadata: { name: 'default' },
                spec: {
                    requirements: this.convertToSpec(provisionerSpecs),
                    taints: taints,
                    provider: {
                        amiFamily: amiFamily,
                        subnetSelector: subnetTags,
                        securityGroupSelector: sgTags,
                    },
                    ttlSecondsAfterEmpty: 30,
                },
            });
            provisioner.node.addDependency(karpenterChart);
        }
        return Promise.resolve(karpenterChart);
    }
    /**
     * Helper function to convert a key-pair values of provisioner spec configurations
     * To appropriate json format for addManifest function
     * @param specs
     * @returns
     * */
    convertToSpec(specs) {
        const newSpecs = [];
        for (const key in specs) {
            const value = specs[key];
            const requirement = {
                "key": key,
                "operator": "In",
                "values": value
            };
            newSpecs.push(requirement);
        }
        return newSpecs;
    }
}
__decorate([
    (0, utils_1.dependable)('VpcCniAddOn'),
    (0, utils_1.conflictsWith)('ClusterAutoScalerAddOn')
], KarpenterAddOn.prototype, "deploy", null);
exports.KarpenterAddOn = KarpenterAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2thcnBlbnRlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBMkM7QUFFM0MsK0NBQWlDO0FBRWpDLHVDQUF5RztBQUN6Ryw4Q0FBOEU7QUFDOUUsK0JBQWtEO0FBQ2xELDhCQUE4QjtBQTJDOUIsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDO0FBQzlCLE1BQU0sT0FBTyxHQUFHLDRCQUE0QixDQUFDO0FBRTdDOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQW1CO0lBQ2pDLElBQUksRUFBRSxTQUFTO0lBQ2YsU0FBUyxFQUFFLFNBQVM7SUFDcEIsT0FBTyxFQUFFLFFBQVE7SUFDakIsS0FBSyxFQUFFLFNBQVM7SUFDaEIsT0FBTyxFQUFFLE9BQU87SUFDaEIsVUFBVSxFQUFFLDZCQUE2QjtDQUM1QyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFhLGNBQWUsU0FBUSxzQkFBUztJQUl6QyxZQUFZLEtBQTJCO1FBQ25DLEtBQUssQ0FBQyxFQUFDLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUlELE1BQU0sQ0FBQyxXQUF3Qjs7UUFDM0IsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUM7UUFDckQsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDN0MsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDdEQsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxD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U0FLSztJQUNLLGFBQWEsQ0FBQyxLQUFtQztRQUN2RCxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDcEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUM7WUFDcEIsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sV0FBVyxHQUFHO2dCQUNoQixLQUFLLEVBQUUsR0FBRztnQkFDVixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsUUFBUSxFQUFFLEtBQUs7YUFDbEIsQ0FBQztZQUNGLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDOUI7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUEzR0c7SUFGQyxJQUFBLGtCQUFVLEVBQUMsYUFBYSxDQUFDO0lBQ3pCLElBQUEscUJBQWEsRUFBQyx3QkFBd0IsQ0FBQzs0Q0F1RnZDO0FBakdMLHdDQXNIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgbWVyZ2UgZnJvbSAndHMtZGVlcG1lcmdlJztcbmltcG9ydCB7IENsdXN0ZXJJbmZvIH0gZnJvbSAnLi4vLi4vc3BpJztcbmltcG9ydCB7IGNvbmZsaWN0c1dpdGgsIGNyZWF0ZU5hbWVzcGFjZSwgY3JlYXRlU2VydmljZUFjY291bnQsIGRlcGVuZGFibGUsIHNldFBhdGgsIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Qcm9wcywgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSAnLi4vaGVsbS1hZGRvbic7XG5pbXBvcnQgeyBLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5IH0gZnJvbSAnLi9pYW0nO1xuaW1wb3J0ICogYXMgbWQ1IGZyb20gJ3RzLW1kNSc7XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmludGVyZmFjZSBLYXJwZW50ZXJBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcbiAgICAvKipcbiAgICAgKiBTcGVjcyBmb3IgYSBQcm92aXNpb25lciAoT3B0aW9uYWwpIC0gSWYgbm90IHByb3ZpZGVkLCB0aGUgYWRkLW9uIHdpbGxcbiAgICAgKiBkZXBsb3kgYSBQcm92aXNpb25lciB3aXRoIGRlZmF1bHQgdmFsdWVzLlxuICAgICAqL1xuICAgIHByb3Zpc2lvbmVyU3BlY3M/OiB7XG4gICAgICAgICdub2RlLmt1YmVybmV0ZXMuaW8vaW5zdGFuY2UtdHlwZSc/OiBzdHJpbmdbXSxcbiAgICAgICAgJ3RvcG9sb2d5Lmt1YmVybmV0ZXMuaW8vem9uZSc/OiBzdHJpbmdbXSxcbiAgICAgICAgJ2t1YmVybmV0ZXMuaW8vYXJjaCc/OiBzdHJpbmdbXSxcbiAgICAgICAgJ2thcnBlbnRlci5zaC9jYXBhY2l0eS10eXBlJz86IHN0cmluZ1tdLFxuICAgIH1cblxuICAgIHRhaW50cz86IFt7XG4gICAgICAgIGtleTogc3RyaW5nLFxuICAgICAgICB2YWx1ZTogc3RyaW5nLFxuICAgICAgICBlZmZlY3Q6IFwiTm9TY2hlZHVsZVwiIHwgXCJQcmVmZXJOb1NjaGVkdWxlXCIgfCBcIk5vRXhlY3V0ZVwiLFxuICAgIH1dXG5cbiAgICAvKipcbiAgICAgKiBUYWdzIG5lZWRlZCBmb3Igc3VibmV0cyAtIFN1Ym5ldCB0YWdzIGFuZCBzZWN1cml0eSBncm91cCB0YWdzIGFyZSByZXF1aXJlZCBmb3IgdGhlIHByb3Zpc2lvbmVyIHRvIGJlIGNyZWF0ZWRcbiAgICAgKi9cbiAgICBzdWJuZXRUYWdzPzoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmdcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUYWdzIG5lZWRlZCBmb3Igc2VjdXJpdHkgZ3JvdXBzIC0gU3VibmV0IHRhZ3MgYW5kIHNlY3VyaXR5IGdyb3VwIHRhZ3MgYXJlIHJlcXVpcmVkIGZvciB0aGUgcHJvdmlzaW9uZXIgdG8gYmUgY3JlYXRlZFxuICAgICAqL1xuICAgIHNlY3VyaXR5R3JvdXBUYWdzPzoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmdcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBTUkgRmFtaWx5OiBJZiBwcm92aWRlZCwgS2FycGVudGVyIHdpbGwgYXV0b21hdGljYWxseSBxdWVyeSB0aGUgYXBwcm9wcmlhdGUgRUtTIG9wdGltaXplZCBBTUkgdmlhIEFXUyBTeXN0ZW1zIE1hbmFnZXJcbiAgICAgKi9cbiAgICBhbWlGYW1pbHk/OiBcIkFMMlwiIHwgXCJCb3R0bGVyb2NrZXRcIiB8IFwiVWJ1bnR1XCJcbn1cblxuY29uc3QgS0FSUEVOVEVSID0gJ2thcnBlbnRlcic7XG5jb25zdCBSRUxFQVNFID0gJ2JsdWVwcmludHMtYWRkb24ta2FycGVudGVyJztcblxuLyoqXG4gKiBEZWZhdWx0cyBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wczogSGVsbUFkZE9uUHJvcHMgPSB7XG4gICAgbmFtZTogS0FSUEVOVEVSLFxuICAgIG5hbWVzcGFjZTogS0FSUEVOVEVSLFxuICAgIHZlcnNpb246ICcwLjE0LjAnLFxuICAgIGNoYXJ0OiBLQVJQRU5URVIsXG4gICAgcmVsZWFzZTogUkVMRUFTRSxcbiAgICByZXBvc2l0b3J5OiAnaHR0cHM6Ly9jaGFydHMua2FycGVudGVyLnNoJyxcbn07XG5cbi8qKlxuICogSW1wbGVtZW50YXRpb24gb2YgdGhlIEthcnBlbnRlciBhZGQtb25cbiAqL1xuZXhwb3J0IGNsYXNzIEthcnBlbnRlckFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcblxuICAgIHJlYWRvbmx5IG9wdGlvbnM6IEthcnBlbnRlckFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IEthcnBlbnRlckFkZE9uUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoey4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHN9KTtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gdGhpcy5wcm9wcztcbiAgICB9XG5cbiAgICBAZGVwZW5kYWJsZSgnVnBjQ25pQWRkT24nKVxuICAgIEBjb25mbGljdHNXaXRoKCdDbHVzdGVyQXV0b1NjYWxlckFkZE9uJylcbiAgICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSBjbHVzdGVySW5mby5jbHVzdGVyLmNsdXN0ZXJFbmRwb2ludDtcbiAgICAgICAgY29uc3QgbmFtZSA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXIuY2x1c3Rlck5hbWU7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBzdGFja05hbWUgPSBjbHVzdGVySW5mby5jbHVzdGVyLnN0YWNrLnN0YWNrTmFtZTtcbiAgICAgICAgY29uc3QgcmVnaW9uID0gY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjay5yZWdpb247XG4gICAgICAgIGxldCB2YWx1ZXMgPSB0aGlzLm9wdGlvbnMudmFsdWVzID8/IHt9O1xuXG4gICAgICAgIGNvbnN0IHByb3Zpc2lvbmVyU3BlY3MgPSB0aGlzLm9wdGlvbnMucHJvdmlzaW9uZXJTcGVjcyB8fCB7fTtcbiAgICAgICAgY29uc3Qgc3VibmV0VGFncyA9IHRoaXMub3B0aW9ucy5zdWJuZXRUYWdzIHx8IHt9O1xuICAgICAgICBjb25zdCBzZ1RhZ3MgPSB0aGlzLm9wdGlvbnMuc2VjdXJpdHlHcm91cFRhZ3MgfHwge307XG4gICAgICAgIGNvbnN0IHRhaW50cyA9IHRoaXMub3B0aW9ucy50YWludHMgfHwgW107XG4gICAgICAgIGNvbnN0IGFtaUZhbWlseSA9IHRoaXMub3B0aW9ucy5hbWlGYW1pbHk7XG5cbiAgICAgICAgLy8gU2V0IHVwIE5vZGUgUm9sZVxuICAgICAgICBjb25zdCBrYXJwZW50ZXJOb2RlUm9sZSA9IG5ldyBpYW0uUm9sZShjbHVzdGVyLCAna2FycGVudGVyLW5vZGUtcm9sZScsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKGBlYzIuJHtjbHVzdGVyLnN0YWNrLnVybFN1ZmZpeH1gKSxcbiAgICAgICAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICAgICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFtYXpvbkVLU1dvcmtlck5vZGVQb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTX0NOSV9Qb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUMyQ29udGFpbmVyUmVnaXN0cnlSZWFkT25seVwiKSxcbiAgICAgICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25TU01NYW5hZ2VkSW5zdGFuY2VDb3JlXCIpLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIC8vcm9sZU5hbWU6IGBLYXJwZW50ZXJOb2RlUm9sZS0ke25hbWV9YCAvLyBsZXQgcm9sZSBuYW1lIHRvIGJlIGdlbmVyYXRlZCBhcyB1bmlxdWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9maWxlTmFtZSA9IG1kNS5NZDUuaGFzaFN0cihzdGFja05hbWUrcmVnaW9uKTtcbiAgICAgICAgY29uc3Qga2FycGVudGVySW5zdGFuY2VQcm9maWxlID0gbmV3IGlhbS5DZm5JbnN0YW5jZVByb2ZpbGUoY2x1c3RlciwgJ2thcnBlbnRlci1pbnN0YW5jZS1wcm9maWxlJywge1xuICAgICAgICAgICAgcm9sZXM6IFtrYXJwZW50ZXJOb2RlUm9sZS5yb2xlTmFtZV0sXG4gICAgICAgICAgICBpbnN0YW5jZVByb2ZpbGVOYW1lOiBgS2FycGVudGVyTm9kZUluc3RhbmNlUHJvZmlsZS0ke2luc3RhbmNlUHJvZmlsZU5hbWV9YCxcbiAgICAgICAgICAgIHBhdGg6ICcvJ1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBNYXAgTm9kZSBSb2xlIHRvIGF3cy1hdXRoXG4gICAgICAgIGNsdXN0ZXIuYXdzQXV0aC5hZGRSb2xlTWFwcGluZyhrYXJwZW50ZXJOb2RlUm9sZSwge1xuICAgICAgICAgICAgZ3JvdXBzOiBbJ3N5c3RlbTpib290c3RyYXBwZXInLCAnc3lzdGVtOm5vZGVzJ10sXG4gICAgICAgICAgICB1c2VybmFtZTogJ3N5c3RlbTpub2RlOnt7RUMyUHJpdmF0ZUROU05hbWV9fSdcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIE5hbWVzcGFjZVxuICAgICAgICBjb25zdCBucyA9IGNyZWF0ZU5hbWVzcGFjZShLQVJQRU5URVIsIGNsdXN0ZXIsIHRydWUsIHRydWUpO1xuICAgICAgICBjb25zdCBrYXJwZW50ZXJQb2xpY3lEb2N1bWVudCA9IGlhbS5Qb2xpY3lEb2N1bWVudC5mcm9tSnNvbihLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5KTtcbiAgICAgICAgY29uc3Qgc2EgPSBjcmVhdGVTZXJ2aWNlQWNjb3VudChjbHVzdGVyLCBSRUxFQVNFLCBLQVJQRU5URVIsIGthcnBlbnRlclBvbGljeURvY3VtZW50KTtcbiAgICAgICAgc2Eubm9kZS5hZGREZXBlbmRlbmN5KG5zKTtcblxuICAgICAgICAvLyBBZGQgaGVsbSBjaGFydFxuICAgICAgICBzZXRQYXRoKHZhbHVlcywgXCJjbHVzdGVyRW5kcG9pbnRcIiwgZW5kcG9pbnQpO1xuICAgICAgICBzZXRQYXRoKHZhbHVlcywgXCJjbHVzdGVyTmFtZVwiLCBuYW1lKTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiYXdzLmRlZmF1bHRJbnN0YW5jZVByb2ZpbGVcIiwga2FycGVudGVySW5zdGFuY2VQcm9maWxlLmluc3RhbmNlUHJvZmlsZU5hbWUpO1xuICAgICAgICBjb25zdCBzYVZhbHVlcyA9IHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBSRUxFQVNFLFxuICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiZWtzLmFtYXpvbmF3cy5jb20vcm9sZS1hcm5cIjogc2Eucm9sZS5yb2xlQXJuLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHNhVmFsdWVzKTtcbiAgICAgICAgY29uc3Qga2FycGVudGVyQ2hhcnQgPSB0aGlzLmFkZEhlbG1DaGFydChjbHVzdGVySW5mbywgdmFsdWVzLCBmYWxzZSwgdHJ1ZSk7XG5cbiAgICAgICAga2FycGVudGVyQ2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KG5zKTtcblxuICAgICAgICAvLyAoT3B0aW9uYWwpIGRlZmF1bHQgcHJvdmlzaW9uZXJcbiAgICAgICAgaWYgKChPYmplY3Qua2V5cyhzdWJuZXRUYWdzKS5sZW5ndGggPiAwKSAmJiAoT2JqZWN0LmtleXMoc2dUYWdzKS5sZW5ndGggPiAwKSl7XG4gICAgICAgICAgICBjb25zdCBwcm92aXNpb25lciA9IGNsdXN0ZXIuYWRkTWFuaWZlc3QoJ2RlZmF1bHQtcHJvdmlzaW9uZXInLCB7XG4gICAgICAgICAgICAgICAgYXBpVmVyc2lvbjogJ2thcnBlbnRlci5zaC92MWFscGhhNScsXG4gICAgICAgICAgICAgICAga2luZDogJ1Byb3Zpc2lvbmVyJyxcbiAgICAgICAgICAgICAgICBtZXRhZGF0YTogeyBuYW1lOiAnZGVmYXVsdCcgfSxcbiAgICAgICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVpcmVtZW50czogdGhpcy5jb252ZXJ0VG9TcGVjKHByb3Zpc2lvbmVyU3BlY3MpLFxuICAgICAgICAgICAgICAgICAgICB0YWludHM6IHRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFtaUZhbWlseTogYW1pRmFtaWx5LFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VibmV0U2VsZWN0b3I6IHN1Ym5ldFRhZ3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eUdyb3VwU2VsZWN0b3I6IHNnVGFncyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgdHRsU2Vjb25kc0FmdGVyRW1wdHk6IDMwLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHByb3Zpc2lvbmVyLm5vZGUuYWRkRGVwZW5kZW5jeShrYXJwZW50ZXJDaGFydCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGthcnBlbnRlckNoYXJ0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIZWxwZXIgZnVuY3Rpb24gdG8gY29udmVydCBhIGtleS1wYWlyIHZhbHVlcyBvZiBwcm92aXNpb25lciBzcGVjIGNvbmZpZ3VyYXRpb25zXG4gICAgICogVG8gYXBwcm9wcmlhdGUganNvbiBmb3JtYXQgZm9yIGFkZE1hbmlmZXN0IGZ1bmN0aW9uXG4gICAgICogQHBhcmFtIHNwZWNzXG4gICAgICogQHJldHVybnNcbiAgICAgKiAqL1xuICAgIHByb3RlY3RlZCBjb252ZXJ0VG9TcGVjKHNwZWNzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdOyB9KTogYW55W10ge1xuICAgICAgICBjb25zdCBuZXdTcGVjcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBzcGVjcyl7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHNwZWNzW2tleV07XG4gICAgICAgICAgICBjb25zdCByZXF1aXJlbWVudCA9IHtcbiAgICAgICAgICAgICAgICBcImtleVwiOiBrZXksXG4gICAgICAgICAgICAgICAgXCJvcGVyYXRvclwiOiBcIkluXCIsXG4gICAgICAgICAgICAgICAgXCJ2YWx1ZXNcIjogdmFsdWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBuZXdTcGVjcy5wdXNoKHJlcXVpcmVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3U3BlY3M7XG4gICAgfVxufSJdfQ==