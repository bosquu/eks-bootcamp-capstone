"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ArgoCDAddOn = void 0;
const assert = require("assert");
const bcrypt = require("bcrypt");
const dot = require("dot-object");
const ts_deepmerge_1 = require("ts-deepmerge");
const __1 = require("..");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const application_1 = require("./application");
const manifest_utils_1 = require("./manifest-utils");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    namespace: "argocd",
    version: '4.10.5',
    chart: "argo-cd",
    release: "blueprints-addon-argocd",
    repository: "https://argoproj.github.io/argo-helm"
};
/**
 * Implementation of ArgoCD add-on and post deployment hook.
 */
class ArgoCDAddOn {
    constructor(props) {
        this.options = { ...defaultProps, ...props };
        helm_addon_1.HelmAddOn.validateVersion({
            chart: this.options.chart,
            version: this.options.version,
            repository: this.options.repository
        });
    }
    generate(clusterInfo, deployment, wave = 0) {
        const promise = clusterInfo.getScheduledAddOn('ArgoCDAddOn');
        if (promise === undefined) {
            throw new Error("ArgoCD addon must be registered before creating Argo managed add-ons for helm applications");
        }
        const manifest = new application_1.ArgoApplication(this.options.bootstrapRepo).generate(deployment, wave);
        const construct = clusterInfo.cluster.addManifest(deployment.name, manifest);
        promise.then(chart => {
            construct.node.addDependency(chart);
        });
        return construct;
    }
    /**
     * Implementation of the add-on contract deploy method.
    */
    async deploy(clusterInfo) {
        var _a, _b;
        const namespace = (0, utils_1.createNamespace)(this.options.namespace, clusterInfo.cluster, true);
        const sa = this.createServiceAccount(clusterInfo);
        sa.node.addDependency(namespace);
        const defaultValues = {};
        dot.set("server.serviceAccount.create", false, defaultValues);
        const secrets = [];
        if ((_a = this.options.bootstrapRepo) === null || _a === void 0 ? void 0 : _a.credentialsSecretName) {
            const repo = this.options.bootstrapRepo;
            secrets.push((0, manifest_utils_1.createSecretRef)(repo.credentialsType, repo.credentialsSecretName));
        }
        if (this.options.adminPasswordSecretName) {
            const adminSecret = await this.createAdminSecret(clusterInfo.cluster.stack.region);
            dot.set("configs.secret.argocdServerAdminPassword", adminSecret, defaultValues, true);
        }
        let secretProviderClass;
        if (secrets.length > 0) {
            secretProviderClass = new __1.SecretProviderClass(clusterInfo, sa, 'blueprints-secret', ...secrets);
            dot.set('server', secretProviderClass.getVolumeMounts('blueprints-secret-inline'), defaultValues, true);
        }
        if (this.options.bootstrapRepo) {
            const repo = this.options.bootstrapRepo;
            dot.set("configs.repositories.bootstrap", { url: repo.repoUrl }, defaultValues, true);
        }
        let values = (0, ts_deepmerge_1.default)(defaultValues, (_b = this.options.values) !== null && _b !== void 0 ? _b : {});
        this.chartNode = clusterInfo.cluster.addHelmChart("argocd-addon", {
            chart: this.options.chart,
            release: this.options.release,
            repository: this.options.repository,
            version: this.options.version,
            namespace: this.options.namespace,
            values: values
        });
        this.chartNode.node.addDependency(sa);
        if (secretProviderClass) {
            secretProviderClass.addDependent(this.chartNode);
        }
        return this.chartNode;
    }
    /**
     * Post deployment step is used to create a bootstrap repository if options are provided for the add-on.
     * @param clusterInfo
     * @param teams
     * @returns
     */
    postDeploy(clusterInfo, teams) {
        var _a, _b;
        assert(teams != null);
        const appRepo = this.options.bootstrapRepo;
        if (appRepo) {
            this.generate(clusterInfo, {
                name: (_a = appRepo.name) !== null && _a !== void 0 ? _a : "bootstrap-apps",
                namespace: this.options.namespace,
                repository: appRepo,
                values: (_b = this.options.bootstrapValues) !== null && _b !== void 0 ? _b : {}
            });
        }
        this.chartNode = undefined;
    }
    /**
     * @returns bcrypt hash of the admin secret provided from the AWS secret manager.
     */
    async createAdminSecret(region) {
        const secretValue = await (0, utils_1.getSecretValue)(this.options.adminPasswordSecretName, region);
        return bcrypt.hash(secretValue, 10);
    }
    /**
     * Creates a service account that can access secrets
     * @param clusterInfo
     * @returns
     */
    createServiceAccount(clusterInfo) {
        const sa = clusterInfo.cluster.addServiceAccount('argo-cd-server', {
            name: "argocd-server",
            namespace: this.options.namespace
        });
        return sa;
    }
}
exports.ArgoCDAddOn = ArgoCDAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FyZ29jZC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBaUM7QUFFakMsaUNBQWlDO0FBRWpDLGtDQUFrQztBQUNsQywrQ0FBaUM7QUFDakMsMEJBQXlDO0FBRXpDLHVDQUE4RDtBQUM5RCw4Q0FBOEQ7QUFDOUQsK0NBQWdEO0FBQ2hELHFEQUFtRDtBQStDbkQ7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBRztJQUNqQixTQUFTLEVBQUUsUUFBUTtJQUNuQixPQUFPLEVBQUUsUUFBUTtJQUNqQixLQUFLLEVBQUUsU0FBUztJQUNoQixPQUFPLEVBQUUseUJBQXlCO0lBQ2xDLFVBQVUsRUFBRSxzQ0FBc0M7Q0FDckQsQ0FBQztBQUdGOztHQUVHO0FBQ0gsTUFBYSxXQUFXO0lBTXBCLFlBQVksS0FBd0I7UUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUM7UUFDN0Msc0JBQVMsQ0FBQyxlQUFlLENBQUM7WUFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBTTtZQUMxQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFRO1lBQzlCLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVc7U0FDdkMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFFBQVEsQ0FBQyxXQUE0QixFQUFFLFVBQTJDLEVBQUUsSUFBSSxHQUFHLENBQUM7UUFDeEYsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTdELElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLDRGQUE0RixDQUFDLENBQUM7U0FDakg7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLDZCQUFlLENB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RSxNQUFNLENBQUMsQ0FBQztRQUN4RixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRDs7OztPQUlHO0lBQ08sb0JBQW9CLENBQUMsV0FBNEI7UUFDdkQsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxnQkFBZ0IsRUFBRTtZQUMvRCxJQUFJLEVBQUUsZUFBZTtZQUNyQixTQUFTLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTO1NBQ3BDLENBQUMsQ0FBQztRQUNILE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNKO0FBOUhELGtDQThIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgeyBIZWxtQ2hhcnQsIFNlcnZpY2VBY2NvdW50IH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tIFwiYmNyeXB0XCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgZG90IGZyb20gJ2RvdC1vYmplY3QnO1xuaW1wb3J0IG1lcmdlIGZyb20gXCJ0cy1kZWVwbWVyZ2VcIjtcbmltcG9ydCB7IFNlY3JldFByb3ZpZGVyQ2xhc3MgfSBmcm9tICcuLic7XG5pbXBvcnQgKiBhcyBzcGkgZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgY3JlYXRlTmFtZXNwYWNlLCBnZXRTZWNyZXRWYWx1ZSB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IEhlbG1BZGRPbiwgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSAnLi4vaGVsbS1hZGRvbic7XG5pbXBvcnQgeyBBcmdvQXBwbGljYXRpb24gfSBmcm9tICcuL2FwcGxpY2F0aW9uJztcbmltcG9ydCB7IGNyZWF0ZVNlY3JldFJlZiB9IGZyb20gJy4vbWFuaWZlc3QtdXRpbHMnO1xuXG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciBhZGQtb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXJnb0NEQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogTmFtZXNwYWNlIHdoZXJlIGFkZC1vbiB3aWxsIGJlIGRlcGxveWVkLiBcbiAgICAgKiBAZGVmYXVsdCBhcmdvY2RcbiAgICAgKi9cbiAgICBuYW1lc3BhY2U/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAqIEhlbG0gY2hhcnQgdmVyc2lvbiB0byB1c2UgdG8gaW5zdGFsbC5cbiAgICAqIEBkZWZhdWx0IDMuMzMuNVxuICAgICovXG4gICAgdmVyc2lvbj86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIElmIHByb3ZpZGVkLCB0aGUgYWRkb24gd2lsbCBib290c3RyYXAgdGhlIGFwcCBvciBhcHBzIGluIHRoZSBwcm92aWRlZCByZXBvc2l0b3J5LlxuICAgICAqIEluIGdlbmVyYWwsIHRoZSByZXBvIGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGFwcCBvZiBhcHBzLCB3aGljaCBjYW4gZW5hYmxlIHRvIGJvb3RzdHJhcCBhbGwgd29ya2xvYWRzLFxuICAgICAqIGFmdGVyIHRoZSBpbmZyYXN0cnVjdHVyZSBhbmQgdGVhbSBwcm92aXNpb25pbmcgaXMgY29tcGxldGUuIFxuICAgICAqL1xuICAgIGJvb3RzdHJhcFJlcG8/OiBzcGkuQXBwbGljYXRpb25SZXBvc2l0b3J5O1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgdmFsdWVzIGZvciB0aGUgYm9vdHN0cmFwIGFwcGxpY2F0aW9uLiBUaGVzZSBtYXkgY29udGFpbiB2YWx1ZXMgc3VjaCBhcyBkb21haW4gbmFtZWQgcHJvdmlzaW9uZWQgYnkgb3RoZXIgYWRkLW9ucywgY2VydGlmY2F0ZSwgYW5kIG90aGVyIHBhcmFtdGVycyB0byBwYXNzIFxuICAgICAqIHRvIHRoZSBhcHBsaWNhdGlvbnMuIFxuICAgICAqL1xuICAgIGJvb3RzdHJhcFZhbHVlcz86IHNwaS5WYWx1ZXMsXG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCBhZG1pbiBwYXNzd29yZCBzZWNyZXQgbmFtZSBhcyBkZWZpbmVkIGluIEFXUyBTZWNyZXRzIE1hbmFnZXIgKHBsYWludGV4dCkuXG4gICAgICogVGhpcyBhbGxvd3MgdG8gY29udHJvbCBhZG1pbiBwYXNzd29yZCBhY3Jvc3MgdGhlIGVudGVycHJpc2UuIFBhc3N3b3JkIHdpbGwgYmUgcmV0cmlldmVkIGFuZCBcbiAgICAgKiBzdG9yZWQgYXMgYSBub24tcmV2ZXJpc2JsZSBiY3J5cHQgaGFzaC4gXG4gICAgICogTm90ZTogYXQgcHJlc2VudCwgY2hhbmdlIG9mIHBhc3N3b3JkIG1heSByZXF1aXJlIG1hbnVhbCByZXN0YXJ0IG9mIGFyZ29jZCBzZXJ2ZXIuIFxuICAgICAqL1xuICAgIGFkbWluUGFzc3dvcmRTZWNyZXROYW1lPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVmFsdWVzIHRvIHBhc3MgdG8gdGhlIGNoYXJ0IGFzIHBlciBodHRwczovL2dpdGh1Yi5jb20vYXJnb3Byb2ovYXJnby1oZWxtL2Jsb2IvbWFzdGVyL2NoYXJ0cy9hcmdvLWNkL3ZhbHVlcy55YW1sLlxuICAgICAqL1xuICAgIHZhbHVlcz86IHNwaS5WYWx1ZXM7XG4gICAgXG59XG5cbi8qKlxuICogRGVmYXVsdHMgb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gICAgbmFtZXNwYWNlOiBcImFyZ29jZFwiLFxuICAgIHZlcnNpb246ICc0LjEwLjUnLFxuICAgIGNoYXJ0OiBcImFyZ28tY2RcIixcbiAgICByZWxlYXNlOiBcImJsdWVwcmludHMtYWRkb24tYXJnb2NkXCIsXG4gICAgcmVwb3NpdG9yeTogXCJodHRwczovL2FyZ29wcm9qLmdpdGh1Yi5pby9hcmdvLWhlbG1cIlxufTtcblxuXG4vKipcbiAqIEltcGxlbWVudGF0aW9uIG9mIEFyZ29DRCBhZGQtb24gYW5kIHBvc3QgZGVwbG95bWVudCBob29rLlxuICovXG5leHBvcnQgY2xhc3MgQXJnb0NEQWRkT24gaW1wbGVtZW50cyBzcGkuQ2x1c3RlckFkZE9uLCBzcGkuQ2x1c3RlclBvc3REZXBsb3kge1xuXG4gICAgcmVhZG9ubHkgb3B0aW9uczogQXJnb0NEQWRkT25Qcm9wcztcblxuICAgIHByaXZhdGUgY2hhcnROb2RlPzogSGVsbUNoYXJ0O1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM/OiBBcmdvQ0RBZGRPblByb3BzKSB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgICAgICBIZWxtQWRkT24udmFsaWRhdGVWZXJzaW9uKHtcbiAgICAgICAgICAgIGNoYXJ0OiB0aGlzLm9wdGlvbnMuY2hhcnQhLFxuICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5vcHRpb25zLnZlcnNpb24hLFxuICAgICAgICAgICAgcmVwb3NpdG9yeTogdGhpcy5vcHRpb25zLnJlcG9zaXRvcnkhXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdlbmVyYXRlKGNsdXN0ZXJJbmZvOiBzcGkuQ2x1c3RlckluZm8sIGRlcGxveW1lbnQ6IHNwaS5HaXRPcHNBcHBsaWNhdGlvbkRlcGxveW1lbnQsIHdhdmUgPSAwKTogQ29uc3RydWN0IHtcbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGNsdXN0ZXJJbmZvLmdldFNjaGVkdWxlZEFkZE9uKCdBcmdvQ0RBZGRPbicpO1xuXG4gICAgICAgIGlmIChwcm9taXNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFyZ29DRCBhZGRvbiBtdXN0IGJlIHJlZ2lzdGVyZWQgYmVmb3JlIGNyZWF0aW5nIEFyZ28gbWFuYWdlZCBhZGQtb25zIGZvciBoZWxtIGFwcGxpY2F0aW9uc1wiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtYW5pZmVzdCA9IG5ldyBBcmdvQXBwbGljYXRpb24odGhpcy5vcHRpb25zLmJvb3RzdHJhcFJlcG8pLmdlbmVyYXRlKGRlcGxveW1lbnQsIHdhdmUpO1xuICAgICAgICBjb25zdCBjb25zdHJ1Y3QgPSBjbHVzdGVySW5mby5jbHVzdGVyLmFkZE1hbmlmZXN0KGRlcGxveW1lbnQubmFtZSwgbWFuaWZlc3QpO1xuICAgICAgICBwcm9taXNlLnRoZW4oY2hhcnQgPT4ge1xuICAgICAgICAgICAgY29uc3RydWN0Lm5vZGUuYWRkRGVwZW5kZW5jeShjaGFydCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBjb25zdHJ1Y3Q7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIGFkZC1vbiBjb250cmFjdCBkZXBsb3kgbWV0aG9kLlxuICAgICovXG4gICAgYXN5bmMgZGVwbG95KGNsdXN0ZXJJbmZvOiBzcGkuQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSBjcmVhdGVOYW1lc3BhY2UodGhpcy5vcHRpb25zLm5hbWVzcGFjZSEsIGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIHRydWUpO1xuXG4gICAgICAgIGNvbnN0IHNhID0gdGhpcy5jcmVhdGVTZXJ2aWNlQWNjb3VudChjbHVzdGVySW5mbyk7XG4gICAgICAgIHNhLm5vZGUuYWRkRGVwZW5kZW5jeShuYW1lc3BhY2UpO1xuXG4gICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZXM6IHNwaS5WYWx1ZXMgPSB7fTtcbiAgICAgICAgZG90LnNldChcInNlcnZlci5zZXJ2aWNlQWNjb3VudC5jcmVhdGVcIiwgZmFsc2UsIGRlZmF1bHRWYWx1ZXMpO1xuXG4gICAgICAgIGNvbnN0IHNlY3JldHMgPSBbXTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmJvb3RzdHJhcFJlcG8/LmNyZWRlbnRpYWxzU2VjcmV0TmFtZSkge1xuICAgICAgICAgICAgY29uc3QgcmVwbyA9IHRoaXMub3B0aW9ucy5ib290c3RyYXBSZXBvO1xuICAgICAgICAgICAgc2VjcmV0cy5wdXNoKGNyZWF0ZVNlY3JldFJlZihyZXBvLmNyZWRlbnRpYWxzVHlwZSEsIHJlcG8uY3JlZGVudGlhbHNTZWNyZXROYW1lISkpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWRtaW5QYXNzd29yZFNlY3JldE5hbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGFkbWluU2VjcmV0ID0gYXdhaXQgdGhpcy5jcmVhdGVBZG1pblNlY3JldChjbHVzdGVySW5mby5jbHVzdGVyLnN0YWNrLnJlZ2lvbik7XG4gICAgICAgICAgICBkb3Quc2V0KFwiY29uZmlncy5zZWNyZXQuYXJnb2NkU2VydmVyQWRtaW5QYXNzd29yZFwiLCBhZG1pblNlY3JldCwgZGVmYXVsdFZhbHVlcywgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc2VjcmV0UHJvdmlkZXJDbGFzczogU2VjcmV0UHJvdmlkZXJDbGFzcyB8IHVuZGVmaW5lZDtcblxuICAgICAgICBpZiAoc2VjcmV0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBzZWNyZXRQcm92aWRlckNsYXNzID0gbmV3IFNlY3JldFByb3ZpZGVyQ2xhc3MoY2x1c3RlckluZm8sIHNhLCAnYmx1ZXByaW50cy1zZWNyZXQnLCAuLi5zZWNyZXRzKTtcbiAgICAgICAgICAgIGRvdC5zZXQoJ3NlcnZlcicsIHNlY3JldFByb3ZpZGVyQ2xhc3MuZ2V0Vm9sdW1lTW91bnRzKCdibHVlcHJpbnRzLXNlY3JldC1pbmxpbmUnKSwgZGVmYXVsdFZhbHVlcywgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmJvb3RzdHJhcFJlcG8pIHtcbiAgICAgICAgICAgIGNvbnN0IHJlcG8gPSB0aGlzLm9wdGlvbnMuYm9vdHN0cmFwUmVwbyE7XG4gICAgICAgICAgICBkb3Quc2V0KFwiY29uZmlncy5yZXBvc2l0b3JpZXMuYm9vdHN0cmFwXCIsIHsgdXJsOiByZXBvLnJlcG9VcmwgfSwgZGVmYXVsdFZhbHVlcywgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdmFsdWVzID0gbWVyZ2UoZGVmYXVsdFZhbHVlcywgdGhpcy5vcHRpb25zLnZhbHVlcyA/PyB7fSk7XG5cbiAgICAgICAgdGhpcy5jaGFydE5vZGUgPSBjbHVzdGVySW5mby5jbHVzdGVyLmFkZEhlbG1DaGFydChcImFyZ29jZC1hZGRvblwiLCB7XG4gICAgICAgICAgICBjaGFydDogdGhpcy5vcHRpb25zLmNoYXJ0ISxcbiAgICAgICAgICAgIHJlbGVhc2U6IHRoaXMub3B0aW9ucy5yZWxlYXNlLFxuICAgICAgICAgICAgcmVwb3NpdG9yeTogdGhpcy5vcHRpb25zLnJlcG9zaXRvcnksXG4gICAgICAgICAgICB2ZXJzaW9uOiB0aGlzLm9wdGlvbnMudmVyc2lvbixcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5vcHRpb25zLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIHZhbHVlczogdmFsdWVzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY2hhcnROb2RlLm5vZGUuYWRkRGVwZW5kZW5jeShzYSk7XG5cbiAgICAgICAgaWYgKHNlY3JldFByb3ZpZGVyQ2xhc3MpIHtcbiAgICAgICAgICAgIHNlY3JldFByb3ZpZGVyQ2xhc3MuYWRkRGVwZW5kZW50KHRoaXMuY2hhcnROb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmNoYXJ0Tm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3N0IGRlcGxveW1lbnQgc3RlcCBpcyB1c2VkIHRvIGNyZWF0ZSBhIGJvb3RzdHJhcCByZXBvc2l0b3J5IGlmIG9wdGlvbnMgYXJlIHByb3ZpZGVkIGZvciB0aGUgYWRkLW9uLlxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKiBAcGFyYW0gdGVhbXMgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcG9zdERlcGxveShjbHVzdGVySW5mbzogc3BpLkNsdXN0ZXJJbmZvLCB0ZWFtczogc3BpLlRlYW1bXSkge1xuICAgICAgICBhc3NlcnQodGVhbXMgIT0gbnVsbCk7XG4gICAgICAgIGNvbnN0IGFwcFJlcG8gPSB0aGlzLm9wdGlvbnMuYm9vdHN0cmFwUmVwbztcblxuICAgICAgICBpZiAoYXBwUmVwbykge1xuICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZShjbHVzdGVySW5mbywge1xuICAgICAgICAgICAgICAgIG5hbWU6IGFwcFJlcG8ubmFtZSA/PyBcImJvb3RzdHJhcC1hcHBzXCIsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLm9wdGlvbnMubmFtZXNwYWNlISxcbiAgICAgICAgICAgICAgICByZXBvc2l0b3J5OiBhcHBSZXBvLFxuICAgICAgICAgICAgICAgIHZhbHVlczogdGhpcy5vcHRpb25zLmJvb3RzdHJhcFZhbHVlcyA/PyB7fVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFydE5vZGUgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMgYmNyeXB0IGhhc2ggb2YgdGhlIGFkbWluIHNlY3JldCBwcm92aWRlZCBmcm9tIHRoZSBBV1Mgc2VjcmV0IG1hbmFnZXIuXG4gICAgICovXG4gICAgIHByb3RlY3RlZCBhc3luYyBjcmVhdGVBZG1pblNlY3JldChyZWdpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHNlY3JldFZhbHVlID0gYXdhaXQgZ2V0U2VjcmV0VmFsdWUodGhpcy5vcHRpb25zLmFkbWluUGFzc3dvcmRTZWNyZXROYW1lISwgcmVnaW9uKTtcbiAgICAgICAgcmV0dXJuIGJjcnlwdC5oYXNoKHNlY3JldFZhbHVlLCAxMCk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBzZXJ2aWNlIGFjY291bnQgdGhhdCBjYW4gYWNjZXNzIHNlY3JldHNcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm8gXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvOiBzcGkuQ2x1c3RlckluZm8pOiBTZXJ2aWNlQWNjb3VudCB7XG4gICAgICAgIGNvbnN0IHNhID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnYXJnby1jZC1zZXJ2ZXInLCB7XG4gICAgICAgICAgICBuYW1lOiBcImFyZ29jZC1zZXJ2ZXJcIixcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5vcHRpb25zLm5hbWVzcGFjZVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHNhO1xuICAgIH1cbn0iXX0=