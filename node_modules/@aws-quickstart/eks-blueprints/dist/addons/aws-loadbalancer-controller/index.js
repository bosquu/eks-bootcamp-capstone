"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsLoadBalancerControllerAddOn = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const helm_addon_1 = require("../helm-addon");
const iam_policy_1 = require("./iam-policy");
const registry_utils_1 = require("../../utils/registry-utils");
const AWS_LOAD_BALANCER_CONTROLLER = 'aws-load-balancer-controller';
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: AWS_LOAD_BALANCER_CONTROLLER,
    namespace: 'kube-system',
    chart: AWS_LOAD_BALANCER_CONTROLLER,
    repository: 'https://aws.github.io/eks-charts',
    release: AWS_LOAD_BALANCER_CONTROLLER,
    version: '1.4.4',
    enableShield: false,
    enableWaf: false,
    enableWafv2: false,
    createIngressClassResource: true,
    ingressClass: "alb"
};
function lookupImage(registry, region) {
    if (registry == null) {
        console.log("Unable to get ECR repository for AWS Loadbalancer Controller for region " + region) + ". Using default helm image";
        return {};
    }
    return { image: { repository: registry + "amazon/aws-load-balancer-controller" } };
}
class AwsLoadBalancerControllerAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        const cluster = clusterInfo.cluster;
        const serviceAccount = cluster.addServiceAccount('aws-load-balancer-controller', {
            name: AWS_LOAD_BALANCER_CONTROLLER,
            namespace: this.options.namespace,
        });
        (0, iam_policy_1.AwsLoadbalancerControllerIamPolicy)(cluster.stack.partition).Statement.forEach((statement) => {
            serviceAccount.addToPrincipalPolicy(iam.PolicyStatement.fromJson(statement));
        });
        const registry = registry_utils_1.registries.get(cluster.stack.region);
        const image = lookupImage(registry, cluster.stack.region);
        const awsLoadBalancerControllerChart = this.addHelmChart(clusterInfo, {
            clusterName: cluster.clusterName,
            serviceAccount: {
                create: false,
                name: serviceAccount.serviceAccountName,
            },
            // must disable waf features for aws-cn partition
            enableShield: this.options.enableShield,
            enableWaf: this.options.enableWaf,
            enableWafv2: this.options.enableWafv2,
            createIngressClassResource: this.options.createIngressClassResource,
            ingressClass: this.options.ingressClass,
            region: clusterInfo.cluster.stack.region,
            ...image,
            vpcId: clusterInfo.cluster.vpc.vpcId,
        });
        awsLoadBalancerControllerChart.node.addDependency(serviceAccount);
        // return the Promise Construct for any teams that may depend on this
        return Promise.resolve(awsLoadBalancerControllerChart);
    }
}
exports.AwsLoadBalancerControllerAddOn = AwsLoadBalancerControllerAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2F3cy1sb2FkYmFsYW5jZXItY29udHJvbGxlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBMkM7QUFHM0MsOENBQThEO0FBQzlELDZDQUFrRTtBQUNsRSwrREFBd0Q7QUFtQ3hELE1BQU0sNEJBQTRCLEdBQUcsOEJBQThCLENBQUM7QUFFcEU7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBbUM7SUFDakQsSUFBSSxFQUFFLDRCQUE0QjtJQUNsQyxTQUFTLEVBQUUsYUFBYTtJQUN4QixLQUFLLEVBQUUsNEJBQTRCO0lBQ25DLFVBQVUsRUFBRSxrQ0FBa0M7SUFDOUMsT0FBTyxFQUFFLDRCQUE0QjtJQUNyQyxPQUFPLEVBQUUsT0FBTztJQUNoQixZQUFZLEVBQUUsS0FBSztJQUNuQixTQUFTLEVBQUUsS0FBSztJQUNoQixXQUFXLEVBQUUsS0FBSztJQUNsQiwwQkFBMEIsRUFBRSxJQUFJO0lBQ2hDLFlBQVksRUFBRSxLQUFLO0NBQ3RCLENBQUM7QUFHRixTQUFTLFdBQVcsQ0FBQyxRQUFpQixFQUFFLE1BQWU7SUFDbkQsSUFBRyxRQUFRLElBQUssSUFBSSxFQUFFO1FBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEVBQTBFLEdBQUcsTUFBTSxDQUFDLEdBQUcsNEJBQTRCLENBQUM7UUFDaEksT0FBTyxFQUFFLENBQUM7S0FDYjtJQUVELE9BQU8sRUFBRSxLQUFLLEVBQUcsRUFBRSxVQUFVLEVBQUUsUUFBUSxHQUFHLHFDQUFxQyxFQUFFLEVBQUMsQ0FBQztBQUN2RixDQUFDO0FBRUQsTUFBYSw4QkFBK0IsU0FBUSxzQkFBUztJQUl6RCxZQUFZLEtBQXNDO1FBQzlDLEtBQUssQ0FBQyxFQUFFLEdBQUcsWUFBbUIsRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBdUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQXdCO1FBQzNCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLDhCQUE4QixFQUFFO1lBQzdFLElBQUksRUFBRSw0QkFBNEI7WUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUztTQUNwQyxDQUFDLENBQUM7UUFFSCxJQUFBLCtDQUFrQyxFQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ3hGLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxRQUFRLEdBQUcsMkJBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV0RCxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFMUQsTUFBTSw4QkFBOEIsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRTtZQUNsRSxXQUFXLEVBQUUsT0FBTyxDQUFDLFdBQVc7WUFDaEMsY0FBYyxFQUFFO2dCQUNaLE1BQU0sRUFBRSxLQUFLO2dCQUNiLElBQUksRUFBRSxjQUFjLENBQUMsa0JBQWtCO2FBQzFDO1lBQ0QsaURBQWlEO1lBQ2pELFlBQVksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVk7WUFDdkMsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUztZQUNqQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1lBQ3JDLDBCQUEwQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsMEJBQTBCO1lBQ25FLFlBQVksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVk7WUFDdkMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU07WUFDeEMsR0FBRyxLQUFLO1lBQ1IsS0FBSyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUs7U0FDdkMsQ0FBQyxDQUFDO1FBRUgsOEJBQThCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNsRSxxRUFBcUU7UUFDckUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDM0QsQ0FBQztDQUNKO0FBN0NELHdFQTZDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblVzZXJQcm9wcyB9IGZyb20gXCIuLi9oZWxtLWFkZG9uXCI7XG5pbXBvcnQgeyBBd3NMb2FkYmFsYW5jZXJDb250cm9sbGVySWFtUG9saWN5IH0gZnJvbSBcIi4vaWFtLXBvbGljeVwiO1xuaW1wb3J0IHsgcmVnaXN0cmllcyB9IGZyb20gXCIuLi8uLi91dGlscy9yZWdpc3RyeS11dGlsc1wiO1xuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFkZC1vbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBd3NMb2FkQmFsYW5jZXJDb250cm9sbGVyUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xuXG4gICAgLyoqXG4gICAgICogRW5hYmxlIFNoaWVsZCAobXVzdCBiZSBmYWxzZSBmb3IgQ04gcGFydGl0aW9uKVxuICAgICAqL1xuICAgIGVuYWJsZVNoaWVsZD86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBFbmFibGUgV0FGIChtdXN0IGJlIGZhbHNlIGZvciBDTiBwYXJ0aXRpb24pXG4gICAgICovXG4gICAgZW5hYmxlV2FmOiBib29sZWFuLFxuXG4gICAgLyoqXG4gICAgICogRW5hYmxlIFdBRlYyIChtdXN0IGJlIGZhbHNlIGZvciBDTiBwYXJ0aXRpb24pXG4gICAgICovXG4gICAgZW5hYmxlV2FmdjI/OiBib29sZWFuLFxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIHRoZSBpbmdyZXNzQ2xhc3MgdG8gYmUgdXNlZCBieSB0aGUgQUxCIGNvbnRyb2xsZXJcbiAgICAgKi9cbiAgICBjcmVhdGVJbmdyZXNzQ2xhc3NSZXNvdXJjZT86IGJvb2xlYW5cblxuICAgIC8qKlxuICAgICAqIE5hbWUgb2YgaW5ncmVzc0NsYXNzIHRvIHRoZSBBTEIgY29udHJvbGxlciB3aWxsIHNhdGlzZnkuIElmIG5vdCBwcm92aWRlZFxuICAgICAqIHRoZSB2YWx1ZSB3aWxsIGJlIGRlZmF1bHRlZCB0byBcImFsYlwiXG4gICAgICovXG4gICAgaW5ncmVzc0NsYXNzPzogc3RyaW5nXG59XG5cblxuY29uc3QgQVdTX0xPQURfQkFMQU5DRVJfQ09OVFJPTExFUiA9ICdhd3MtbG9hZC1iYWxhbmNlci1jb250cm9sbGVyJztcblxuLyoqXG4gKiBEZWZhdWx0cyBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wczogQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlclByb3BzID0ge1xuICAgIG5hbWU6IEFXU19MT0FEX0JBTEFOQ0VSX0NPTlRST0xMRVIsXG4gICAgbmFtZXNwYWNlOiAna3ViZS1zeXN0ZW0nLFxuICAgIGNoYXJ0OiBBV1NfTE9BRF9CQUxBTkNFUl9DT05UUk9MTEVSLFxuICAgIHJlcG9zaXRvcnk6ICdodHRwczovL2F3cy5naXRodWIuaW8vZWtzLWNoYXJ0cycsXG4gICAgcmVsZWFzZTogQVdTX0xPQURfQkFMQU5DRVJfQ09OVFJPTExFUixcbiAgICB2ZXJzaW9uOiAnMS40LjQnLFxuICAgIGVuYWJsZVNoaWVsZDogZmFsc2UsXG4gICAgZW5hYmxlV2FmOiBmYWxzZSxcbiAgICBlbmFibGVXYWZ2MjogZmFsc2UsXG4gICAgY3JlYXRlSW5ncmVzc0NsYXNzUmVzb3VyY2U6IHRydWUsXG4gICAgaW5ncmVzc0NsYXNzOiBcImFsYlwiXG59O1xuXG5cbmZ1bmN0aW9uIGxvb2t1cEltYWdlKHJlZ2lzdHJ5Pzogc3RyaW5nLCByZWdpb24/OiBzdHJpbmcpOiBWYWx1ZXMge1xuICAgIGlmKHJlZ2lzdHJ5ID09ICBudWxsKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiVW5hYmxlIHRvIGdldCBFQ1IgcmVwb3NpdG9yeSBmb3IgQVdTIExvYWRiYWxhbmNlciBDb250cm9sbGVyIGZvciByZWdpb24gXCIgKyByZWdpb24pICsgXCIuIFVzaW5nIGRlZmF1bHQgaGVsbSBpbWFnZVwiO1xuICAgICAgICByZXR1cm4ge307XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7IGltYWdlIDogeyByZXBvc2l0b3J5OiByZWdpc3RyeSArIFwiYW1hem9uL2F3cy1sb2FkLWJhbGFuY2VyLWNvbnRyb2xsZXJcIiB9fTtcbn1cblxuZXhwb3J0IGNsYXNzIEF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJBZGRPbiBleHRlbmRzIEhlbG1BZGRPbiB7XG5cbiAgICByZWFkb25seSBvcHRpb25zOiBBd3NMb2FkQmFsYW5jZXJDb250cm9sbGVyUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IEF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJQcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcyBhcyBhbnksIC4uLnByb3BzIH0pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzIGFzIEF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJQcm9wcztcbiAgICB9XG5cbiAgICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IHNlcnZpY2VBY2NvdW50ID0gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnYXdzLWxvYWQtYmFsYW5jZXItY29udHJvbGxlcicsIHtcbiAgICAgICAgICAgIG5hbWU6IEFXU19MT0FEX0JBTEFOQ0VSX0NPTlRST0xMRVIsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMub3B0aW9ucy5uYW1lc3BhY2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEF3c0xvYWRiYWxhbmNlckNvbnRyb2xsZXJJYW1Qb2xpY3koY2x1c3Rlci5zdGFjay5wYXJ0aXRpb24pLlN0YXRlbWVudC5mb3JFYWNoKChzdGF0ZW1lbnQpID0+IHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50LmFkZFRvUHJpbmNpcGFsUG9saWN5KGlhbS5Qb2xpY3lTdGF0ZW1lbnQuZnJvbUpzb24oc3RhdGVtZW50KSk7XG4gICAgICAgIH0pO1xuICAgIFxuICAgICAgICBjb25zdCByZWdpc3RyeSA9IHJlZ2lzdHJpZXMuZ2V0KGNsdXN0ZXIuc3RhY2sucmVnaW9uKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGltYWdlID0gbG9va3VwSW1hZ2UocmVnaXN0cnksIGNsdXN0ZXIuc3RhY2sucmVnaW9uKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJDaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB7XG4gICAgICAgICAgICBjbHVzdGVyTmFtZTogY2x1c3Rlci5jbHVzdGVyTmFtZSxcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBzZXJ2aWNlQWNjb3VudC5zZXJ2aWNlQWNjb3VudE5hbWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbXVzdCBkaXNhYmxlIHdhZiBmZWF0dXJlcyBmb3IgYXdzLWNuIHBhcnRpdGlvblxuICAgICAgICAgICAgZW5hYmxlU2hpZWxkOiB0aGlzLm9wdGlvbnMuZW5hYmxlU2hpZWxkLFxuICAgICAgICAgICAgZW5hYmxlV2FmOiB0aGlzLm9wdGlvbnMuZW5hYmxlV2FmLFxuICAgICAgICAgICAgZW5hYmxlV2FmdjI6IHRoaXMub3B0aW9ucy5lbmFibGVXYWZ2MixcbiAgICAgICAgICAgIGNyZWF0ZUluZ3Jlc3NDbGFzc1Jlc291cmNlOiB0aGlzLm9wdGlvbnMuY3JlYXRlSW5ncmVzc0NsYXNzUmVzb3VyY2UsXG4gICAgICAgICAgICBpbmdyZXNzQ2xhc3M6IHRoaXMub3B0aW9ucy5pbmdyZXNzQ2xhc3MsXG4gICAgICAgICAgICByZWdpb246IGNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgLi4uaW1hZ2UsXG4gICAgICAgICAgICB2cGNJZDogY2x1c3RlckluZm8uY2x1c3Rlci52cGMudnBjSWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJDaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2VydmljZUFjY291bnQpO1xuICAgICAgICAvLyByZXR1cm4gdGhlIFByb21pc2UgQ29uc3RydWN0IGZvciBhbnkgdGVhbXMgdGhhdCBtYXkgZGVwZW5kIG9uIHRoaXNcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhd3NMb2FkQmFsYW5jZXJDb250cm9sbGVyQ2hhcnQpO1xuICAgIH1cbn0iXX0=