"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KedaAddOn = void 0;
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const ts_deepmerge_1 = require("ts-deepmerge");
const helm_addon_1 = require("../helm-addon");
const utils_1 = require("../../utils");
/**
 * Default props to be used when creating the Helm chart
 */
const defaultProps = {
    name: "blueprints-keda-addon",
    chart: "keda",
    namespace: "keda",
    version: "2.8.0",
    release: "keda",
    repository: "https://kedacore.github.io/charts",
    values: {},
    kedaOperatorName: "keda-operator",
    kedaServiceAccountName: "keda-operator",
    irsaRoles: []
};
/**
 * Main class to instantiate the Helm chart
 */
class KedaAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let values = populateValues(this.options);
        values = (0, ts_deepmerge_1.default)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        if (this.options.irsaRoles.length > 0) {
            //Create Service Account with IRSA
            const opts = { name: this.options.kedaOperatorName, namespace: this.options.namespace };
            const sa = cluster.addServiceAccount(this.options.kedaServiceAccountName, opts);
            setRoles(sa, this.options.irsaRoles);
            const namespace = (0, utils_1.createNamespace)(this.options.namespace, cluster);
            sa.node.addDependency(namespace);
            const chart = this.addHelmChart(clusterInfo, values);
            chart.node.addDependency(sa);
            return Promise.resolve(chart);
        }
        else {
            //Let Keda Create Service account for you. This is controlled by flag helmOptions.createServiceAccount (refer line no:118)
            const chart = this.addHelmChart(clusterInfo, values);
            return Promise.resolve(chart);
        }
    }
}
exports.KedaAddOn = KedaAddOn;
/**
 * populateValues populates the appropriate values used to customize the Helm chart
 * @param helmOptions User provided values to customize the chart
 */
function populateValues(helmOptions) {
    var _a;
    const values = (_a = helmOptions.values) !== null && _a !== void 0 ? _a : {};
    // Check the workaround for SQS Scalar https://github.com/kedacore/keda/issues/837
    (0, utils_1.setPath)(values, "operator.name", helmOptions.kedaOperatorName);
    (0, utils_1.setPath)(values, "podSecurityContext.fsGroup", helmOptions.podSecurityContextFsGroup);
    (0, utils_1.setPath)(values, "securityContext.runAsGroup", helmOptions.securityContextRunAsGroup);
    (0, utils_1.setPath)(values, "securityContext.runAsUser", helmOptions.securityContextRunAsUser);
    //In Case irsaRoles array is non empty, code should not allow Keda to create Service Account, CDK will create Service Account with IRSA enabled
    (0, utils_1.setPath)(values, "serviceAccount.create", helmOptions.irsaRoles.length > 0 ? false : true);
    (0, utils_1.setPath)(values, "serviceAccount.name", helmOptions.kedaServiceAccountName);
    return values;
}
/**
 * This function will set the roles to Service Account
 * @param sa - Service Account Object
 * @param irsaRoles - Array  of Managed IAM Policies
 */
function setRoles(sa, irsaRoles) {
    irsaRoles.forEach((policyName) => {
        const policy = aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName(policyName);
        sa.role.addManagedPolicy(policy);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2tlZGEvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaURBQW9EO0FBRXBELCtDQUFpQztBQUNqQyw4Q0FBOEU7QUFFOUUsdUNBQXVEO0FBeUN2RDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFvQztJQUNwRCxJQUFJLEVBQUUsdUJBQXVCO0lBQzdCLEtBQUssRUFBRSxNQUFNO0lBQ2IsU0FBUyxFQUFDLE1BQU07SUFDaEIsT0FBTyxFQUFFLE9BQU87SUFDaEIsT0FBTyxFQUFFLE1BQU07SUFDZixVQUFVLEVBQUcsbUNBQW1DO0lBQ2hELE1BQU0sRUFBRSxFQUFFO0lBQ1YsZ0JBQWdCLEVBQUUsZUFBZTtJQUNqQyxzQkFBc0IsRUFBRSxlQUFlO0lBQ3ZDLFNBQVMsRUFBRSxFQUFFO0NBQ2QsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBYSxTQUFVLFNBQVEsc0JBQVM7SUFHdEMsWUFBWSxLQUFzQjtRQUNoQyxLQUFLLENBQUMsRUFBQyxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBdUIsQ0FBQztJQUM5QyxDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQXdCOztRQUU3QixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQUksTUFBTSxHQUFXLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEQsTUFBTSxHQUFHLElBQUEsc0JBQUssRUFBQyxNQUFNLEVBQUUsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDLENBQUM7UUFFaEQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3RDLGtDQUFrQztZQUNsQyxNQUFNLElBQUksR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3hGLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLHNCQUF1QixFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2pGLFFBQVEsQ0FBQyxFQUFFLEVBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFVLENBQUMsQ0FBQztZQUNyQyxNQUFNLFNBQVMsR0FBRyxJQUFBLHVCQUFlLEVBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFVLEVBQUcsT0FBTyxDQUFDLENBQUM7WUFDckUsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFakMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDckQsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0IsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBRS9CO2FBQU07WUFDTCwwSEFBMEg7WUFDMUgsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDckQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQy9CO0lBR0gsQ0FBQztDQUNGO0FBbENELDhCQWtDQztBQUVEOzs7R0FHRztBQUNILFNBQVMsY0FBYyxDQUFDLFdBQTJCOztJQUNqRCxNQUFNLE1BQU0sR0FBRyxNQUFBLFdBQVcsQ0FBQyxNQUFNLG1DQUFJLEVBQUUsQ0FBQztJQUV4QyxrRkFBa0Y7SUFDbEYsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLGVBQWUsRUFBRyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUNoRSxJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUsNEJBQTRCLEVBQUcsV0FBVyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDdEYsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLDRCQUE0QixFQUFHLFdBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQ3RGLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBRyxXQUFXLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUNwRiwrSUFBK0k7SUFDL0ksSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLHVCQUF1QixFQUFHLFdBQVcsQ0FBQyxTQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1RixJQUFBLGVBQU8sRUFBQyxNQUFNLEVBQUUscUJBQXFCLEVBQUcsV0FBVyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFFNUUsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDRixTQUFTLFFBQVEsQ0FBQyxFQUFpQixFQUFFLFNBQW1CO0lBQ3JELFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtRQUM3QixNQUFNLE1BQU0sR0FBRyx1QkFBYSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XHJcbmltcG9ydCB7IE1hbmFnZWRQb2xpY3kgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xyXG5pbXBvcnQgeyBTZXJ2aWNlQWNjb3VudCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xyXG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblVzZXJQcm9wcywgSGVsbUFkZE9uUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xyXG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xyXG5pbXBvcnQgeyBzZXRQYXRoLCBjcmVhdGVOYW1lc3BhY2UgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcclxuXHJcbi8qKlxyXG4gKiBVc2VyIHByb3ZpZGVkIG9wdGlvbnMgZm9yIHRoZSBIZWxtIENoYXJ0XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEtlZGFBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcclxuICAgIC8qKlxyXG4gICAgICogVmVyc2lvbiBvZiB0aGUgaGVsbSBjaGFydCB0byBkZXBsb3lcclxuICAgICAqLyAgICBcclxuICAgIHZlcnNpb24/OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIE5hbWUgb2YgdGhlIEtFREEgb3BlcmF0b3JcclxuICAgICAqL1xyXG4gICAga2VkYU9wZXJhdG9yTmFtZT86IHN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgYWNjb3VudCB0byB1c2UuIElmIG5vdCBzZXQgYW5kIGNyZWF0ZSBpcyB0cnVlLCBhIG5hbWUgaXMgZ2VuZXJhdGVkLlxyXG4gICAgICovXHJcbiAgICBrZWRhU2VydmljZUFjY291bnROYW1lPzogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiBzZWN1cml0eUNvbnRleHQ6IGZzR3JvdXBcclxuICAgICAqIENoZWNrIHRoZSB3b3JrYXJvdW5kIGZvciBTUVMgU2NhbGFyIHdpdGggSVJTQSBodHRwczovL2dpdGh1Yi5jb20va2VkYWNvcmUva2VkYS9pc3N1ZXMvODM3I2lzc3VlY29tbWVudC03ODkwMzczMjZcclxuICAgICAqLyAgIFxyXG4gICAgcG9kU2VjdXJpdHlDb250ZXh0RnNHcm91cD86IG51bWJlcjtcclxuICAgIC8qKlxyXG4gICAgICogc2VjdXJpdHlDb250ZXh0OnJ1bkFzR3JvdXBcclxuICAgICAqIENoZWNrIHRoZSB3b3JrYXJvdW5kIGZvciBTUVMgU2NhbGFyIHdpdGggSVJTQSBodHRwczovL2dpdGh1Yi5jb20va2VkYWNvcmUva2VkYS9pc3N1ZXMvODM3I2lzc3VlY29tbWVudC03ODkwMzczMjZcclxuICAgICAqLyAgIFxyXG4gICAgc2VjdXJpdHlDb250ZXh0UnVuQXNHcm91cD86IG51bWJlcjtcclxuICAgIC8qKlxyXG4gICAgICogc2VjdXJpdHlDb250ZXh0OnJ1bkFzVXNlclxyXG4gICAgICogQ2hlY2sgdGhlIHdvcmthcm91bmQgZm9yIFNRUyBTY2FsYXIgd2l0aCBJUlNBIGh0dHBzOi8vZ2l0aHViLmNvbS9rZWRhY29yZS9rZWRhL2lzc3Vlcy84MzcjaXNzdWVjb21tZW50LTc4OTAzNzMyNlxyXG4gICAgICovXHJcbiAgICBzZWN1cml0eUNvbnRleHRSdW5Bc1VzZXI/OiBudW1iZXI7XHJcbiAgICAvKipcclxuICAgICAqIEFuIGFycmF5IG9mIE1hbmFnZWQgSUFNIFBvbGljaWVzIHdoaWNoIFNlcnZpY2UgQWNjb3VudCBuZWVkcyBmb3IgSVJTQSBFZzogaXJzYVJvbGVzOltcIkNsb3VkV2F0Y2hGdWxsQWNjZXNzXCIsXCJBbWF6b25TUVNGdWxsQWNjZXNzXCJdLiBJZiBub3QgZW1wdHlcclxuICAgICAqIFNlcnZpY2UgQWNjb3VudCB3aWxsIGJlIENyZWF0ZWQgYnkgQ0RLIHdpdGggSUFNIFJvbGVzIE1hcHBlZCAoSVJTQSkuIEluIGNhc2UgaWYgaXRzIGVtcHR5LCBLZWRhIHdpbGwgY3JlYXRlIHRoZSBTZXJ2aWNlIEFjY291bnQgd2l0aCBvdXQgSUFNIFJvbGVzXHJcbiAgICAgKi8gICBcclxuICAgIGlyc2FSb2xlcz86IHN0cmluZ1tdO1xyXG5cclxufVxyXG5cclxuLyoqXHJcbiAqIERlZmF1bHQgcHJvcHMgdG8gYmUgdXNlZCB3aGVuIGNyZWF0aW5nIHRoZSBIZWxtIGNoYXJ0XHJcbiAqL1xyXG5jb25zdCBkZWZhdWx0UHJvcHM6IEhlbG1BZGRPblByb3BzICYgS2VkYUFkZE9uUHJvcHMgPSB7XHJcbiAgbmFtZTogXCJibHVlcHJpbnRzLWtlZGEtYWRkb25cIixcclxuICBjaGFydDogXCJrZWRhXCIsXHJcbiAgbmFtZXNwYWNlOlwia2VkYVwiLFxyXG4gIHZlcnNpb246IFwiMi44LjBcIixcclxuICByZWxlYXNlOiBcImtlZGFcIixcclxuICByZXBvc2l0b3J5OiAgXCJodHRwczovL2tlZGFjb3JlLmdpdGh1Yi5pby9jaGFydHNcIixcclxuICB2YWx1ZXM6IHt9LFxyXG4gIGtlZGFPcGVyYXRvck5hbWU6IFwia2VkYS1vcGVyYXRvclwiLFxyXG4gIGtlZGFTZXJ2aWNlQWNjb3VudE5hbWU6IFwia2VkYS1vcGVyYXRvclwiLFxyXG4gIGlyc2FSb2xlczogW11cclxufTtcclxuXHJcbi8qKlxyXG4gKiBNYWluIGNsYXNzIHRvIGluc3RhbnRpYXRlIHRoZSBIZWxtIGNoYXJ0XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgS2VkYUFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcclxuXHJcbiAgcmVhZG9ubHkgb3B0aW9uczogS2VkYUFkZE9uUHJvcHM7XHJcbiAgY29uc3RydWN0b3IocHJvcHM/OiBLZWRhQWRkT25Qcm9wcykge1xyXG4gICAgc3VwZXIoey4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHN9KTtcclxuICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgS2VkYUFkZE9uUHJvcHM7XHJcbiAgfVxyXG5cclxuICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcclxuICAgIFxyXG4gICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XHJcbiAgICBsZXQgdmFsdWVzOiBWYWx1ZXMgPSBwb3B1bGF0ZVZhbHVlcyh0aGlzLm9wdGlvbnMpO1xyXG4gICAgdmFsdWVzID0gbWVyZ2UodmFsdWVzLCB0aGlzLnByb3BzLnZhbHVlcyA/PyB7fSk7XHJcbiAgICBcclxuICAgIGlmICh0aGlzLm9wdGlvbnMuaXJzYVJvbGVzIS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vQ3JlYXRlIFNlcnZpY2UgQWNjb3VudCB3aXRoIElSU0FcclxuICAgICAgY29uc3Qgb3B0cyA9IHsgbmFtZTogdGhpcy5vcHRpb25zLmtlZGFPcGVyYXRvck5hbWUsIG5hbWVzcGFjZTogdGhpcy5vcHRpb25zLm5hbWVzcGFjZSB9O1xyXG4gICAgICBjb25zdCBzYSA9IGNsdXN0ZXIuYWRkU2VydmljZUFjY291bnQodGhpcy5vcHRpb25zLmtlZGFTZXJ2aWNlQWNjb3VudE5hbWUhLCBvcHRzKTtcclxuICAgICAgc2V0Um9sZXMoc2EsdGhpcy5vcHRpb25zLmlyc2FSb2xlcyEpO1xyXG4gICAgICBjb25zdCBuYW1lc3BhY2UgPSBjcmVhdGVOYW1lc3BhY2UodGhpcy5vcHRpb25zLm5hbWVzcGFjZSEgLCBjbHVzdGVyKTtcclxuICAgICAgc2Eubm9kZS5hZGREZXBlbmRlbmN5KG5hbWVzcGFjZSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBjaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMpO1xyXG4gICAgICBjaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2EpO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoYXJ0KTtcclxuXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvL0xldCBLZWRhIENyZWF0ZSBTZXJ2aWNlIGFjY291bnQgZm9yIHlvdS4gVGhpcyBpcyBjb250cm9sbGVkIGJ5IGZsYWcgaGVsbU9wdGlvbnMuY3JlYXRlU2VydmljZUFjY291bnQgKHJlZmVyIGxpbmUgbm86MTE4KVxyXG4gICAgICBjb25zdCBjaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMpO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoYXJ0KTtcclxuICAgIH1cclxuICAgXHJcbiAgICBcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBwb3B1bGF0ZVZhbHVlcyBwb3B1bGF0ZXMgdGhlIGFwcHJvcHJpYXRlIHZhbHVlcyB1c2VkIHRvIGN1c3RvbWl6ZSB0aGUgSGVsbSBjaGFydFxyXG4gKiBAcGFyYW0gaGVsbU9wdGlvbnMgVXNlciBwcm92aWRlZCB2YWx1ZXMgdG8gY3VzdG9taXplIHRoZSBjaGFydFxyXG4gKi9cclxuZnVuY3Rpb24gcG9wdWxhdGVWYWx1ZXMoaGVsbU9wdGlvbnM6IEtlZGFBZGRPblByb3BzKTogVmFsdWVzIHtcclxuICBjb25zdCB2YWx1ZXMgPSBoZWxtT3B0aW9ucy52YWx1ZXMgPz8ge307XHJcblxyXG4gIC8vIENoZWNrIHRoZSB3b3JrYXJvdW5kIGZvciBTUVMgU2NhbGFyIGh0dHBzOi8vZ2l0aHViLmNvbS9rZWRhY29yZS9rZWRhL2lzc3Vlcy84MzdcclxuICBzZXRQYXRoKHZhbHVlcywgXCJvcGVyYXRvci5uYW1lXCIsICBoZWxtT3B0aW9ucy5rZWRhT3BlcmF0b3JOYW1lKTtcclxuICBzZXRQYXRoKHZhbHVlcywgXCJwb2RTZWN1cml0eUNvbnRleHQuZnNHcm91cFwiLCAgaGVsbU9wdGlvbnMucG9kU2VjdXJpdHlDb250ZXh0RnNHcm91cCk7XHJcbiAgc2V0UGF0aCh2YWx1ZXMsIFwic2VjdXJpdHlDb250ZXh0LnJ1bkFzR3JvdXBcIiwgIGhlbG1PcHRpb25zLnNlY3VyaXR5Q29udGV4dFJ1bkFzR3JvdXApO1xyXG4gIHNldFBhdGgodmFsdWVzLCBcInNlY3VyaXR5Q29udGV4dC5ydW5Bc1VzZXJcIiwgIGhlbG1PcHRpb25zLnNlY3VyaXR5Q29udGV4dFJ1bkFzVXNlcik7XHJcbiAgLy9JbiBDYXNlIGlyc2FSb2xlcyBhcnJheSBpcyBub24gZW1wdHksIGNvZGUgc2hvdWxkIG5vdCBhbGxvdyBLZWRhIHRvIGNyZWF0ZSBTZXJ2aWNlIEFjY291bnQsIENESyB3aWxsIGNyZWF0ZSBTZXJ2aWNlIEFjY291bnQgd2l0aCBJUlNBIGVuYWJsZWRcclxuICBzZXRQYXRoKHZhbHVlcywgXCJzZXJ2aWNlQWNjb3VudC5jcmVhdGVcIiwgIGhlbG1PcHRpb25zLmlyc2FSb2xlcyEubGVuZ3RoID4gMCA/IGZhbHNlIDogdHJ1ZSk7IFxyXG4gIHNldFBhdGgodmFsdWVzLCBcInNlcnZpY2VBY2NvdW50Lm5hbWVcIiwgIGhlbG1PcHRpb25zLmtlZGFTZXJ2aWNlQWNjb3VudE5hbWUpOyBcclxuXHJcbiAgcmV0dXJuIHZhbHVlcztcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBzZXQgdGhlIHJvbGVzIHRvIFNlcnZpY2UgQWNjb3VudFxyXG4gKiBAcGFyYW0gc2EgLSBTZXJ2aWNlIEFjY291bnQgT2JqZWN0XHJcbiAqIEBwYXJhbSBpcnNhUm9sZXMgLSBBcnJheSAgb2YgTWFuYWdlZCBJQU0gUG9saWNpZXNcclxuICovXHJcbiBmdW5jdGlvbiBzZXRSb2xlcyhzYTpTZXJ2aWNlQWNjb3VudCwgaXJzYVJvbGVzOiBzdHJpbmdbXSl7XHJcbiAgICBpcnNhUm9sZXMuZm9yRWFjaCgocG9saWN5TmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBvbGljeSA9IE1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKHBvbGljeU5hbWUpO1xyXG4gICAgICAgIHNhLnJvbGUuYWRkTWFuYWdlZFBvbGljeShwb2xpY3kpO1xyXG4gICAgICB9KTtcclxuICB9XHJcbiAgIl19