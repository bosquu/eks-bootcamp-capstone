"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KubectlProvider = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
/**
 * Kubectl provider for the add-ons and teams that is capable of helm and generic manifest deployments.
 * It exposes extension mechanism and central points for logging, stack output, extension of functionality.
 */
class KubectlProvider {
    constructor(clusterInfo) {
        this.clusterInfo = clusterInfo;
    }
    addHelmChart(props) {
        return KubectlProvider.applyHelmDeployment(this.clusterInfo, props);
    }
    addManifest(props) {
        return KubectlProvider.applyManifestDeployment(this.clusterInfo, props);
    }
}
exports.KubectlProvider = KubectlProvider;
KubectlProvider.applyHelmDeployment = function (clusterInfo, props) {
    return clusterInfo.cluster.addHelmChart(props.name, {
        repository: props.repository,
        namespace: props.namespace,
        createNamespace: props.createNamespace,
        chart: props.chart,
        version: props.version,
        release: props.release,
        timeout: props.timeout,
        wait: props.wait,
        values: props.values
    });
};
/**
 * Simple template provider for manifest based add-ons.
 * Replaces values in format {{key}} with the values passed in as values.
 * @param document where templated parameters must be replaced
 * @param values values to replace (e.g. region will be passed as "region: us-west-1" and any occurrence of {{region}} will be replaced)
 * @returns
 */
KubectlProvider.applyManifestTemplate = function (document, values) {
    const valueMap = new Map(Object.entries(values));
    let data = JSON.stringify(document);
    valueMap.forEach((value, key) => {
        data = data.replace(new RegExp(`{{${key}}}`, 'g'), value);
    });
    return JSON.parse(data);
};
KubectlProvider.applyManifestDeployment = function (clusterInfo, props) {
    const manifestDoc = KubectlProvider.applyManifestTemplate(props.manifest, props.values);
    return new aws_eks_1.KubernetesManifest(clusterInfo.cluster, props.name, {
        cluster: clusterInfo.cluster,
        manifest: manifestDoc,
        overwrite: true
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3ViZWN0bC1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGRvbnMvaGVsbS1hZGRvbi9rdWJlY3RsLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlEQUF5RDtBQTRGekQ7OztHQUdHO0FBQ0gsTUFBYSxlQUFlO0lBRXhCLFlBQTZCLFdBQXlCO1FBQXpCLGdCQUFXLEdBQVgsV0FBVyxDQUFjO0lBQUcsQ0FBQztJQXlDbkQsWUFBWSxDQUFDLEtBQTBCO1FBQzFDLE9BQU8sZUFBZSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVNLFdBQVcsQ0FBQyxLQUF5QjtRQUN4QyxPQUFPLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVFLENBQUM7O0FBakRMLDBDQWtEQztBQTlDaUIsbUNBQW1CLEdBQUcsVUFBUyxXQUF3QixFQUFFLEtBQTBCO0lBQzdGLE9BQU8sV0FBVyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUUsS0FBSyxDQUFDLElBQUksRUFBRTtRQUNqRCxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7UUFDNUIsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO1FBQzFCLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtRQUN0QyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7UUFDbEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ3RCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztRQUN0QixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87UUFDdEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1FBQ2hCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtLQUN2QixDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDVyxxQ0FBcUIsR0FBRyxVQUFTLFFBQWEsRUFBRSxNQUFjO0lBQ3hFLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNqRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFhLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDNUMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxHQUFHLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM1QixDQUFDLENBQUM7QUFFWSx1Q0FBdUIsR0FBRyxVQUFTLFdBQXdCLEVBQUUsS0FBeUI7SUFDaEcsTUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hGLE9BQVEsSUFBSSw0QkFBa0IsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDOUQsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPO1FBQzVCLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLFNBQVMsRUFBRSxJQUFJO0tBQ2hCLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi5cIjtcblxuLyoqXG4gKiBTdHJ1Y3R1cmUgdGhhdCBkZWZpbmVzIHByb3BlcnRpZXMgZm9yIGEgZ2VuZXJpYyBIZWxtIGNoYXJ0LiBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWxtQ2hhcnRDb25maWd1cmF0aW9uIHtcbiAgICBcbiAgICAvKipcbiAgICAgKiBOYW1lIG9mIHRoZSBoZWxtIGNoYXJ0IChhZGQtb24pXG4gICAgICovXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIFxuICAgIC8qKlxuICAgICAqIE5hbWVzcGFjZSB3aGVyZSBoZWxtIHJlbGVhc2Ugd2lsbCBiZSBpbnN0YWxsZWRcbiAgICAgKi9cbiAgICBuYW1lc3BhY2U6IHN0cmluZyB8IHVuZGVmaW5lZCxcblxuICAgIC8qKlxuICAgICAqIENoYXJ0IG5hbWVcbiAgICAgKi9cbiAgICBjaGFydDogc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogSGVsbSBjaGFydCB2ZXJzaW9uLlxuICAgICAqL1xuICAgIHZlcnNpb246IHN0cmluZywgXG5cbiAgICAvKipcbiAgICAgKiBIZWxtIHJlbGVhc2VcbiAgICAgKi9cbiAgICByZWxlYXNlOiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBIZWxtIHJlcG9zaXRvcnlcbiAgICAgKi9cbiAgICByZXBvc2l0b3J5OiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIGdsb2JhbCBoZWxtIHZlcnNpb24gdmFsaWRhdGlvbiBpcyBlbmFibGVkIHdpdGggSGVsbUFkZE9uLnZhbGlkYXRlSGVsbVZlcnNpb25zID0gdHJ1ZVxuICAgICAqIGFsbG93cyB0byBza2lwIHZhbGlkYXRpb24gZm9yIGEgcGFydGljdWxhciBoZWxtIGFkZC1vbi4gXG4gICAgICovXG4gICAgc2tpcFZlcnNpb25WYWxpZGF0aW9uPzogYm9vbGVhbixcblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsIHZhbHVlcyBmb3IgdGhlIGhlbG0gY2hhcnQuIFxuICAgICAqL1xuICAgIHZhbHVlcz86IFZhbHVlc1xufVxuXG4vKipcbiAqIEV4dGVuZHMgaGVsbSBjaGFydCBjb25maWd1cmF0aW9uIChyZXBvL2NoYXJ0KSB3aXRoIGRlcGxveW1lbnQgcGFyYW1ldGVyczogdmFsdWVzLCB0aW1lb3V0IGFuZCB3YWl0LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhlbG1DaGFydERlcGxveW1lbnQgZXh0ZW5kcyBSZXF1aXJlZDxPbWl0PEhlbG1DaGFydENvbmZpZ3VyYXRpb24sIFwic2tpcFZlcnNpb25WYWxpZGF0aW9uXCI+PiB7XG4gICAgLyoqXG4gICAgICogRGVwbG95bWVudCB3aWxsIHdhaXQgZm9yIGFsbCBwb2RzIHRvIGNvbWUgdXAuXG4gICAgICovXG4gICAgd2FpdD86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBUaW1lIHRvIHdhaXQuIFxuICAgICAqL1xuICAgIHRpbWVvdXQ/OiBEdXJhdGlvbjtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgbmFtZXNwYWNlIGlmIGRvZXMgbm90IGV4aXN0XG4gICAgICovXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBEYXRhIHN0cnVjdHVyZSBkZWZpbmVzIHByb3BlcnRpZXMgZm9yIGt1YmVybmV0ZXMgbWFuaWZlc3QgZGVwbG95bWVudCAobm9uLWhlbG0pLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1hbmlmZXN0Q29uZmlndXJhdGlvbiB7XG4gICAgbmFtZTogc3RyaW5nLCBcbiAgICBuYW1lc3BhY2U6IHN0cmluZywgXG4gICAgbWFuaWZlc3RVcmw6IHN0cmluZ1xufVxuXG4vKipcbiAqIERhdGEgc3RydWN0dXJlIGV4dGVuZHMgS3ViZXJuZXRlcyBtYW5pZmVzdCBjb25maWd1cmF0aW9uIGFuZCBhbGxvd3MgcGFzc2luZyBkZXBsb3ltZW50IHBhcmFtZXRlcnMuXG4gKiBTdWNoIHBhcmFtZXRlcnMgYXJlIGV4cGVjdGVkIHRvIGJlIHRlbXBsYXRlZCB3aXRoaW4gdmFsdWVzIGluc2lkZSB0aGUgbWFuaWZlc3QgYXMge3twYXJhbWV0ZXIta2V5fX0uXG4gKiBGb3IgZXhhbXBsZSwgaWYgdmFsdWVzIGNvbnRhaW5zIHtyZWdpb246ICd1cy1lYXN0LTInfSB0aGVuIHRoZSBtYW5pZmVzdCBpcyBleHBlY3RlZCB0byBjb250YWluIFxuICogeyAnc29tZS1hdHRyaWJ1dGUnIDoge3tyZWdpb259fS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBNYW5pZmVzdERlcGxveW1lbnQgZXh0ZW5kcyBPbWl0PE1hbmlmZXN0Q29uZmlndXJhdGlvbiwgXCJtYW5pZmVzdFVybFwiPiB7XG4gICAgbWFuaWZlc3Q6IGFueSxcbiAgICB2YWx1ZXM6IFZhbHVlc1xufVxuXG4vKipcbiAqIEt1YmVjdGwgcHJvdmlkZXIgZm9yIHRoZSBhZGQtb25zIGFuZCB0ZWFtcyB0aGF0IGlzIGNhcGFibGUgb2YgaGVsbSBhbmQgZ2VuZXJpYyBtYW5pZmVzdCBkZXBsb3ltZW50cy5cbiAqIEl0IGV4cG9zZXMgZXh0ZW5zaW9uIG1lY2hhbmlzbSBhbmQgY2VudHJhbCBwb2ludHMgZm9yIGxvZ2dpbmcsIHN0YWNrIG91dHB1dCwgZXh0ZW5zaW9uIG9mIGZ1bmN0aW9uYWxpdHkuXG4gKi9cbmV4cG9ydCBjbGFzcyBLdWJlY3RsUHJvdmlkZXIge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjbHVzdGVySW5mbyA6IENsdXN0ZXJJbmZvKSB7fVxuXG4gICAgcHVibGljIHN0YXRpYyBhcHBseUhlbG1EZXBsb3ltZW50ID0gZnVuY3Rpb24oY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBwcm9wczogSGVsbUNoYXJ0RGVwbG95bWVudCkgOiBDb25zdHJ1Y3Qge1xuICAgICAgICByZXR1cm4gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRIZWxtQ2hhcnQoIHByb3BzLm5hbWUsIHtcbiAgICAgICAgICAgIHJlcG9zaXRvcnk6IHByb3BzLnJlcG9zaXRvcnksXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHByb3BzLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIGNyZWF0ZU5hbWVzcGFjZTogcHJvcHMuY3JlYXRlTmFtZXNwYWNlLFxuICAgICAgICAgICAgY2hhcnQ6IHByb3BzLmNoYXJ0LFxuICAgICAgICAgICAgdmVyc2lvbjogcHJvcHMudmVyc2lvbixcbiAgICAgICAgICAgIHJlbGVhc2U6IHByb3BzLnJlbGVhc2UsXG4gICAgICAgICAgICB0aW1lb3V0OiBwcm9wcy50aW1lb3V0LFxuICAgICAgICAgICAgd2FpdDogcHJvcHMud2FpdCxcbiAgICAgICAgICAgIHZhbHVlczogcHJvcHMudmFsdWVzXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBTaW1wbGUgdGVtcGxhdGUgcHJvdmlkZXIgZm9yIG1hbmlmZXN0IGJhc2VkIGFkZC1vbnMuIFxuICAgICAqIFJlcGxhY2VzIHZhbHVlcyBpbiBmb3JtYXQge3trZXl9fSB3aXRoIHRoZSB2YWx1ZXMgcGFzc2VkIGluIGFzIHZhbHVlcy5cbiAgICAgKiBAcGFyYW0gZG9jdW1lbnQgd2hlcmUgdGVtcGxhdGVkIHBhcmFtZXRlcnMgbXVzdCBiZSByZXBsYWNlZFxuICAgICAqIEBwYXJhbSB2YWx1ZXMgdmFsdWVzIHRvIHJlcGxhY2UgKGUuZy4gcmVnaW9uIHdpbGwgYmUgcGFzc2VkIGFzIFwicmVnaW9uOiB1cy13ZXN0LTFcIiBhbmQgYW55IG9jY3VycmVuY2Ugb2Yge3tyZWdpb259fSB3aWxsIGJlIHJlcGxhY2VkKVxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXBwbHlNYW5pZmVzdFRlbXBsYXRlID0gZnVuY3Rpb24oZG9jdW1lbnQ6IGFueSwgdmFsdWVzOiBWYWx1ZXMpIDogYW55IHtcbiAgICAgICAgY29uc3QgdmFsdWVNYXAgPSBuZXcgTWFwKE9iamVjdC5lbnRyaWVzKHZhbHVlcykpO1xuICAgICAgICBsZXQgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRvY3VtZW50KTtcbiAgICAgICAgdmFsdWVNYXAuZm9yRWFjaCgodmFsdWU6IHN0cmluZywga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UobmV3IFJlZ0V4cChge3ske2tleX19fWAsICdnJyksIHZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgc3RhdGljIGFwcGx5TWFuaWZlc3REZXBsb3ltZW50ID0gZnVuY3Rpb24oY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBwcm9wczogTWFuaWZlc3REZXBsb3ltZW50KSB7XG4gICAgICAgIGNvbnN0IG1hbmlmZXN0RG9jID0gS3ViZWN0bFByb3ZpZGVyLmFwcGx5TWFuaWZlc3RUZW1wbGF0ZShwcm9wcy5tYW5pZmVzdCwgcHJvcHMudmFsdWVzKTtcbiAgICAgICAgcmV0dXJuICBuZXcgS3ViZXJuZXRlc01hbmlmZXN0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIHByb3BzLm5hbWUsIHtcbiAgICAgICAgICBjbHVzdGVyOiBjbHVzdGVySW5mby5jbHVzdGVyLFxuICAgICAgICAgIG1hbmlmZXN0OiBtYW5pZmVzdERvYyxcbiAgICAgICAgICBvdmVyd3JpdGU6IHRydWUgIFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHVibGljIGFkZEhlbG1DaGFydChwcm9wczogSGVsbUNoYXJ0RGVwbG95bWVudCkgOiBDb25zdHJ1Y3Qge1xuICAgICAgICByZXR1cm4gS3ViZWN0bFByb3ZpZGVyLmFwcGx5SGVsbURlcGxveW1lbnQodGhpcy5jbHVzdGVySW5mbywgcHJvcHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRNYW5pZmVzdChwcm9wczogTWFuaWZlc3REZXBsb3ltZW50KSA6IENvbnN0cnVjdCB7XG4gICAgICAgIHJldHVybiBLdWJlY3RsUHJvdmlkZXIuYXBwbHlNYW5pZmVzdERlcGxveW1lbnQodGhpcy5jbHVzdGVySW5mbywgcHJvcHMpO1xuICAgIH1cbn1cblxuXG4iXX0=