"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkHelmChartVersion = exports.listChartVersions = void 0;
const utils_1 = require("../../utils");
/**
 * Semver comparator, simplistic implementation. Might require additional
 * logic for correct semver comparison.
 *
 * @param a
 * @param b
 * @returns
 */
const semverComparator = (a, b) => {
    a = trimVersion(a);
    b = trimVersion(b);
    const a1 = a.split('.');
    const b1 = b.split('.');
    const len = Math.min(a1.length, b1.length);
    for (let i = 0; i < len; i++) {
        const a2 = +a1[i] || 0;
        const b2 = +b1[i] || 0;
        if (a2 !== b2) {
            return a2 > b2 ? -1 : 1;
        }
    }
    return b1.length - a1.length;
};
/**
 * Remove leading "v". Placeholder to extend (e.g. remove -rc, -beta, etc.);
 * @param v semver format version
 * @returns
 */
function trimVersion(v) {
    return v.charAt(0) == 'v' ? v.substring(1) : v;
}
/**
 * Lists chart versions for a given helm chart.
 * @param chart
 * @returns
 */
function listChartVersions(chart) {
    // TODO make function async and use async HTTP client to get results
    const helmRepository = (0, utils_1.loadExternalYaml)(chart.repository + "/index.yaml");
    const versions = Object.values(helmRepository[0]['entries'][chart.chart])
        .map((e) => { return e['version']; });
    return versions.filter(e => e.includes(".") && !e.includes("beta") && !e.includes("rc"));
}
exports.listChartVersions = listChartVersions;
/**
 * Checks the provided helm chart version against the repository.
 * Validation is successful if there is no higher version registered in the repository.
 * @param chart
 * @returns
 */
function checkHelmChartVersion(chart) {
    let versions = listChartVersions(chart);
    if (versions === null || versions.length == 0) {
        console.error("No versions are found for " + chart.chart + " in repository " + chart.repository);
        return {
            allVersions: versions,
            highestVersion: undefined,
            latestVersion: false
        };
    }
    versions = versions.sort(semverComparator);
    const latestVersion = (trimVersion(versions[0]) === trimVersion(chart.version));
    if (latestVersion) {
        utils_1.userLog.info(`Chart ${chart.chart}-${chart.version} is at the latest version.`);
    }
    else {
        utils_1.userLog.warn(`Upgrade is needed for chart ${chart.chart}-${chart.version}: latest version is ${versions[0]}.`);
    }
    return {
        allVersions: versions,
        highestVersion: versions[0],
        latestVersion: latestVersion
    };
}
exports.checkHelmChartVersion = checkHelmChartVersion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVsbS12ZXJzaW9uLWNoZWNrZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2hlbG0tYWRkb24vaGVsbS12ZXJzaW9uLWNoZWNrZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXdEO0FBS3hEOzs7Ozs7O0dBT0c7QUFDSCxNQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBUyxFQUFFLENBQVMsRUFBRSxFQUFFO0lBQzlDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkIsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVuQixNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFeEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMzQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQzFCLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFFLENBQUMsQ0FBRSxJQUFJLENBQUMsQ0FBQztRQUN6QixNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBRSxDQUFDLENBQUUsSUFBSSxDQUFDLENBQUM7UUFFekIsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNCO0tBQ0o7SUFFRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQztBQUNqQyxDQUFDLENBQUM7QUFFRjs7OztHQUlHO0FBQ0gsU0FBUyxXQUFXLENBQUMsQ0FBUztJQUMxQixPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQXNCRDs7OztHQUlHO0FBQ0gsU0FBZ0IsaUJBQWlCLENBQUMsS0FBdUI7SUFDckQsb0VBQW9FO0lBQ3BFLE1BQU0sY0FBYyxHQUFHLElBQUEsd0JBQWdCLEVBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxhQUFhLENBQUMsQ0FBQztJQUMxRSxNQUFNLFFBQVEsR0FBYSxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDOUUsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9DLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQzdGLENBQUM7QUFORCw4Q0FNQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBZ0IscUJBQXFCLENBQUMsS0FBdUI7SUFDekQsSUFBSSxRQUFRLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsSUFBRyxRQUFRLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1FBQzFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEdBQUcsS0FBSyxDQUFDLEtBQUssR0FBRyxpQkFBaUIsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFFLENBQUM7UUFDbEcsT0FBTztZQUNILFdBQVcsRUFBRSxRQUFRO1lBQ3JCLGNBQWMsRUFBRSxTQUFTO1lBQ3pCLGFBQWEsRUFBRSxLQUFLO1NBQ3ZCLENBQUM7S0FDTDtJQUNELFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDM0MsTUFBTSxhQUFhLEdBQUcsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssV0FBVyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLElBQUcsYUFBYSxFQUFFO1FBQ2QsZUFBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLE9BQU8sNEJBQTRCLENBQUUsQ0FBQztLQUNwRjtTQUNJO1FBQ0QsZUFBTyxDQUFDLElBQUksQ0FBQywrQkFBK0IsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyx1QkFBdUIsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsSDtJQUNELE9BQU87UUFDSCxXQUFXLEVBQUUsUUFBUTtRQUNyQixjQUFjLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMzQixhQUFhLEVBQUUsYUFBYTtLQUMvQixDQUFDO0FBQ04sQ0FBQztBQXZCRCxzREF1QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2FkRXh0ZXJuYWxZYW1sLCB1c2VyTG9nIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBIZWxtQ2hhcnRDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4va3ViZWN0bC1wcm92aWRlclwiO1xuXG5leHBvcnQgdHlwZSBIZWxtQ2hhcnRWZXJzaW9uID0gT21pdDxIZWxtQ2hhcnRDb25maWd1cmF0aW9uLCBcIm5hbWVcIiB8IFwibmFtZXNwYWNlXCIgfCAgXCJyZWxlYXNlXCIgfCBcInZhbHVlc1wiPjtcblxuLyoqXG4gKiBTZW12ZXIgY29tcGFyYXRvciwgc2ltcGxpc3RpYyBpbXBsZW1lbnRhdGlvbi4gTWlnaHQgcmVxdWlyZSBhZGRpdGlvbmFsIFxuICogbG9naWMgZm9yIGNvcnJlY3Qgc2VtdmVyIGNvbXBhcmlzb24uXG4gKiBcbiAqIEBwYXJhbSBhIFxuICogQHBhcmFtIGIgXG4gKiBAcmV0dXJucyBcbiAqL1xuY29uc3Qgc2VtdmVyQ29tcGFyYXRvciA9IChhOiBzdHJpbmcsIGI6IHN0cmluZykgPT4geyBcbiAgICBhID0gdHJpbVZlcnNpb24oYSk7XG4gICAgYiA9IHRyaW1WZXJzaW9uKGIpO1xuXG4gICAgY29uc3QgYTEgPSBhLnNwbGl0KCcuJyk7XG4gICAgY29uc3QgYjEgPSBiLnNwbGl0KCcuJyk7XG5cbiAgICBjb25zdCBsZW4gPSBNYXRoLm1pbihhMS5sZW5ndGgsIGIxLmxlbmd0aCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBjb25zdCBhMiA9ICthMVsgaSBdIHx8IDA7XG4gICAgICAgIGNvbnN0IGIyID0gK2IxWyBpIF0gfHwgMDtcbiAgICAgICAgXG4gICAgICAgIGlmIChhMiAhPT0gYjIpIHtcbiAgICAgICAgICAgIHJldHVybiBhMiA+IGIyID8gLTEgOiAxO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGIxLmxlbmd0aCAtIGExLmxlbmd0aDtcbn07XG5cbi8qKlxuICogUmVtb3ZlIGxlYWRpbmcgXCJ2XCIuIFBsYWNlaG9sZGVyIHRvIGV4dGVuZCAoZS5nLiByZW1vdmUgLXJjLCAtYmV0YSwgZXRjLik7XG4gKiBAcGFyYW0gdiBzZW12ZXIgZm9ybWF0IHZlcnNpb25cbiAqIEByZXR1cm5zIFxuICovXG5mdW5jdGlvbiB0cmltVmVyc2lvbih2OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdi5jaGFyQXQoMCkgPT0gICd2JyA/IHYuc3Vic3RyaW5nKDEpIDogdjtcbn1cbi8qKlxuICogUmVwcmVzZW50IHJlc3VsdCBvZiBoZWxtIGNoYXJ0IHZlcnNpb24gdmFsaWRhdGlvbiBhZ2FpbnN0IG5ld2VyIHZlcnNpb25zXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2hlY2tWZXJzaW9uUmVzdWx0IHtcblxuICAgIC8qKlxuICAgICAqIENvbnRhaW5zIHRoZSBoaWdoZXN0IHZlcnNpb24gb2YgdGhlIGhlbG0gY2hhcnQgZGlzY292ZXJlZCBpbiB0aGUgaGVsbSBjaGFydCByZXBvc2l0b3J5LlxuICAgICAqL1xuICAgIGhpZ2hlc3RWZXJzaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgXG4gICAgLyoqXG4gICAgICogVHJ1ZSBpZiB0aGUgcHJvdmlkZWQgdmVyc2lvbiBpcyB0aGUgbGF0ZXN0IHZlcnNpb24gaW4gdGhlIGhlbG0gY2hhcnQgcmVwb3NpdG9yeS4gT3RoZXJ3aXNlLCBmYWxzZS5cbiAgICAgKi9cbiAgICBsYXRlc3RWZXJzaW9uOiBib29sZWFuLFxuXG4gICAgLyoqXG4gICAgICogQWxsIGRpc2NvdmVyZWQgdmVyc2lvbnMgb2YgdGhlIGNoYXJ0LCBkaXNjb3ZlcmVkIGluIHRoZSBwcm92aWRlZCBoZWxtIGNoYXJ0IHJlcG9zaXRvcnkuXG4gICAgICovXG4gICAgYWxsVmVyc2lvbnM6IHN0cmluZ1tdO1xufVxuXG4vKipcbiAqIExpc3RzIGNoYXJ0IHZlcnNpb25zIGZvciBhIGdpdmVuIGhlbG0gY2hhcnQuXG4gKiBAcGFyYW0gY2hhcnQgXG4gKiBAcmV0dXJucyBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxpc3RDaGFydFZlcnNpb25zKGNoYXJ0OiBIZWxtQ2hhcnRWZXJzaW9uKTogc3RyaW5nW10ge1xuICAgIC8vIFRPRE8gbWFrZSBmdW5jdGlvbiBhc3luYyBhbmQgdXNlIGFzeW5jIEhUVFAgY2xpZW50IHRvIGdldCByZXN1bHRzXG4gICAgY29uc3QgaGVsbVJlcG9zaXRvcnkgPSBsb2FkRXh0ZXJuYWxZYW1sKGNoYXJ0LnJlcG9zaXRvcnkgKyBcIi9pbmRleC55YW1sXCIpO1xuICAgIGNvbnN0IHZlcnNpb25zOiBzdHJpbmdbXSA9IE9iamVjdC52YWx1ZXMoaGVsbVJlcG9zaXRvcnlbMF1bJ2VudHJpZXMnXVtjaGFydC5jaGFydF0pXG4gICAgICAgIC5tYXAoKGU6IGFueSkgPT4geyByZXR1cm4gZVsndmVyc2lvbiddOyB9KTtcbiAgICByZXR1cm4gdmVyc2lvbnMuZmlsdGVyKGUgPT4gZS5pbmNsdWRlcyhcIi5cIikgJiYgIWUuaW5jbHVkZXMoXCJiZXRhXCIpICYmICFlLmluY2x1ZGVzKFwicmNcIikpO1xufVxuXG4vKipcbiAqIENoZWNrcyB0aGUgcHJvdmlkZWQgaGVsbSBjaGFydCB2ZXJzaW9uIGFnYWluc3QgdGhlIHJlcG9zaXRvcnkuXG4gKiBWYWxpZGF0aW9uIGlzIHN1Y2Nlc3NmdWwgaWYgdGhlcmUgaXMgbm8gaGlnaGVyIHZlcnNpb24gcmVnaXN0ZXJlZCBpbiB0aGUgcmVwb3NpdG9yeS4gXG4gKiBAcGFyYW0gY2hhcnQgXG4gKiBAcmV0dXJucyBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrSGVsbUNoYXJ0VmVyc2lvbihjaGFydDogSGVsbUNoYXJ0VmVyc2lvbikgOiBDaGVja1ZlcnNpb25SZXN1bHQge1xuICAgIGxldCB2ZXJzaW9ucyA9IGxpc3RDaGFydFZlcnNpb25zKGNoYXJ0KTtcbiAgICBpZih2ZXJzaW9ucyA9PT0gbnVsbCB8fCB2ZXJzaW9ucy5sZW5ndGggPT0gMCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiTm8gdmVyc2lvbnMgYXJlIGZvdW5kIGZvciBcIiArIGNoYXJ0LmNoYXJ0ICsgXCIgaW4gcmVwb3NpdG9yeSBcIiArIGNoYXJ0LnJlcG9zaXRvcnkgKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGFsbFZlcnNpb25zOiB2ZXJzaW9ucyxcbiAgICAgICAgICAgIGhpZ2hlc3RWZXJzaW9uOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBsYXRlc3RWZXJzaW9uOiBmYWxzZVxuICAgICAgICB9O1xuICAgIH1cbiAgICB2ZXJzaW9ucyA9IHZlcnNpb25zLnNvcnQoc2VtdmVyQ29tcGFyYXRvcik7XG4gICAgY29uc3QgbGF0ZXN0VmVyc2lvbiA9ICh0cmltVmVyc2lvbih2ZXJzaW9uc1swXSkgPT09IHRyaW1WZXJzaW9uKGNoYXJ0LnZlcnNpb24pKTtcbiAgICBpZihsYXRlc3RWZXJzaW9uKSB7XG4gICAgICAgIHVzZXJMb2cuaW5mbyhgQ2hhcnQgJHtjaGFydC5jaGFydH0tJHtjaGFydC52ZXJzaW9ufSBpcyBhdCB0aGUgbGF0ZXN0IHZlcnNpb24uYCApO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdXNlckxvZy53YXJuKGBVcGdyYWRlIGlzIG5lZWRlZCBmb3IgY2hhcnQgJHtjaGFydC5jaGFydH0tJHtjaGFydC52ZXJzaW9ufTogbGF0ZXN0IHZlcnNpb24gaXMgJHt2ZXJzaW9uc1swXX0uYCk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIGFsbFZlcnNpb25zOiB2ZXJzaW9ucyxcbiAgICAgICAgaGlnaGVzdFZlcnNpb246IHZlcnNpb25zWzBdLFxuICAgICAgICBsYXRlc3RWZXJzaW9uOiBsYXRlc3RWZXJzaW9uXG4gICAgfTtcbn0iXX0=