"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HelmAddOn = exports.HelmAddonPropsConstraints = void 0;
const helm_version_checker_1 = require("./helm-version-checker");
const kubectl_provider_1 = require("./kubectl-provider");
const utils = require("../../utils");
class HelmAddonPropsConstraints {
    constructor() {
        /**
        * chart can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://helm.sh/docs/chart_template_guide/getting_started/#:~:text=TIP%3A%20The%20name%3A%20field%20is,are%20limited%20to%2053%20characters
        */
        this.chart = new utils.StringConstraint(1, 63);
        /**
        * name can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://helm.sh/docs/chart_template_guide/getting_started/#:~:text=TIP%3A%20The%20name%3A%20field%20is,are%20limited%20to%2053%20characters
        */
        this.name = new utils.StringConstraint(1, 63);
        /**
        * namespace can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://helm.sh/docs/chart_template_guide/getting_started/#:~:text=TIP%3A%20The%20name%3A%20field%20is,are%20limited%20to%2053%20characters
        */
        this.namespace = new utils.StringConstraint(1, 63);
        /**
        * release can be no less than 1 character long, and no greater than 53 characters long.
        * https://helm.sh/docs/chart_template_guide/getting_started/#:~:text=TIP%3A%20The%20name%3A%20field%20is,are%20limited%20to%2053%20characters
        */
        this.release = new utils.StringConstraint(1, 53);
        /**
        * repository can be no less than 0 characters long, and no greater than 4096 characters long. It also must follow a URL format.
        * https://docs.aws.amazon.com/connect/latest/APIReference/API_UrlReference.html
        */
        this.repository = new utils.UrlStringConstraint(0, 4096);
        /**
        * version can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://helm.sh/docs/chart_template_guide/getting_started/#:~:text=TIP%3A%20The%20name%3A%20field%20is,are%20limited%20to%2053%20characters
        */
        this.version = new utils.StringConstraint(1, 63);
    }
}
exports.HelmAddonPropsConstraints = HelmAddonPropsConstraints;
class HelmAddOn {
    constructor(props) {
        this.props = utils.cloneDeep(props); // avoids polution when reusing the same props across stacks, such as values
        utils.validateConstraints(new HelmAddonPropsConstraints, HelmAddOn.name, props);
        HelmAddOn.validateVersion(props);
    }
    static validateVersion(helmChart) {
        if (HelmAddOn.validateHelmVersions && !helmChart.skipVersionValidation) {
            const result = (0, helm_version_checker_1.checkHelmChartVersion)(helmChart);
            if (this.failOnVersionValidation && !result.latestVersion) {
                throw new Error(`Helm version validation failed for ${helmChart.chart}. 
                    Used version ${helmChart.version}, latest version: ${result.highestVersion}`);
            }
        }
    }
    /**
     * Deploys the helm chart in the cluster.
     * @param clusterInfo
     * @param values
     * @param createNamespace
     * @param wait
     * @param timeout
     * @returns
     */
    addHelmChart(clusterInfo, values, createNamespace, wait, timeout) {
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        values = values !== null && values !== void 0 ? values : {};
        const chart = { ...this.props, ...{ values, wait, timeout, createNamespace } };
        return kubectlProvider.addHelmChart(chart);
    }
}
exports.HelmAddOn = HelmAddOn;
HelmAddOn.validateHelmVersions = false;
HelmAddOn.failOnVersionValidation = false;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2hlbG0tYWRkb24vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsaUVBQWlGO0FBQ2pGLHlEQUE2RTtBQUU3RSxxQ0FBcUM7QUFLckMsTUFBYSx5QkFBeUI7SUFBdEM7UUFDSTs7O1VBR0U7UUFDRixVQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTFDOzs7VUFHRTtRQUNGLFNBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFekM7OztVQUdFO1FBQ0YsY0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUU5Qzs7O1VBR0U7UUFDRixZQUFPLEdBQUcsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTVDOzs7VUFHRTtRQUNGLGVBQVUsR0FBRyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFcEQ7OztVQUdFO1FBQ0YsWUFBTyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBQUE7QUFwQ0QsOERBb0NDO0FBRUQsTUFBc0IsU0FBUztJQU8zQixZQUFZLEtBQXFCO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLDRFQUE0RTtRQUNqSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSx5QkFBeUIsRUFBRSxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hGLFNBQVMsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxlQUFlLENBQUMsU0FBMkI7UUFDckQsSUFBRyxTQUFTLENBQUMsb0JBQW9CLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLEVBQUU7WUFDbkUsTUFBTSxNQUFNLEdBQUcsSUFBQSw0Q0FBcUIsRUFBQyxTQUFTLENBQUMsQ0FBQztZQUNoRCxJQUFHLElBQUksQ0FBQyx1QkFBdUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RELE1BQU0sSUFBSSxLQUFLLENBQUMsc0NBQXNDLFNBQVMsQ0FBQyxLQUFLO21DQUNsRCxTQUFTLENBQUMsT0FBTyxxQkFBcUIsTUFBTSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7YUFDckY7U0FDSjtJQUNMLENBQUM7SUFTRDs7Ozs7Ozs7T0FRRztJQUNPLFlBQVksQ0FBQyxXQUE0QixFQUFFLE1BQW1CLEVBQUUsZUFBeUIsRUFBRSxJQUFjLEVBQUUsT0FBa0I7UUFDcEksTUFBTSxlQUFlLEdBQUcsSUFBSSxrQ0FBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3hELE1BQU0sR0FBRyxNQUFNLGFBQU4sTUFBTSxjQUFOLE1BQU0sR0FBSSxFQUFFLENBQUM7UUFDdEIsTUFBTSxLQUFLLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLENBQUM7UUFDL0UsT0FBTyxlQUFlLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9DLENBQUM7O0FBNUNMLDhCQTZDQztBQXpDaUIsOEJBQW9CLEdBQUcsS0FBSyxDQUFDO0FBQzdCLGlDQUF1QixHQUFHLEtBQUssQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgSGVsbUNoYXJ0VmVyc2lvbiwgY2hlY2tIZWxtQ2hhcnRWZXJzaW9uIH0gZnJvbSBcIi4vaGVsbS12ZXJzaW9uLWNoZWNrZXJcIjtcbmltcG9ydCB7IEhlbG1DaGFydENvbmZpZ3VyYXRpb24sIEt1YmVjdGxQcm92aWRlciB9IGZyb20gXCIuL2t1YmVjdGwtcHJvdmlkZXJcIjtcbmltcG9ydCAqIGFzIHNwaSBmcm9tIFwiLi4vLi5cIjtcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCIuLi8uLi91dGlsc1wiO1xuXG5leHBvcnQgdHlwZSBIZWxtQWRkT25Qcm9wcyA9IEhlbG1DaGFydENvbmZpZ3VyYXRpb247XG5leHBvcnQgdHlwZSBIZWxtQWRkT25Vc2VyUHJvcHMgPSBQYXJ0aWFsPEhlbG1DaGFydENvbmZpZ3VyYXRpb24+O1xuXG5leHBvcnQgY2xhc3MgSGVsbUFkZG9uUHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxIZWxtQWRkT25Qcm9wcz4ge1xuICAgIC8qKlxuICAgICogY2hhcnQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAqIGh0dHBzOi8vaGVsbS5zaC9kb2NzL2NoYXJ0X3RlbXBsYXRlX2d1aWRlL2dldHRpbmdfc3RhcnRlZC8jOn46dGV4dD1USVAlM0ElMjBUaGUlMjBuYW1lJTNBJTIwZmllbGQlMjBpcyxhcmUlMjBsaW1pdGVkJTIwdG8lMjA1MyUyMGNoYXJhY3RlcnNcbiAgICAqL1xuICAgIGNoYXJ0ID0gbmV3IHV0aWxzLlN0cmluZ0NvbnN0cmFpbnQoMSwgNjMpO1xuXG4gICAgLyoqXG4gICAgKiBuYW1lIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcgZHVlIHRvIEROUyBzeXN0ZW0gbGltaXRhdGlvbnMuXG4gICAgKiBodHRwczovL2hlbG0uc2gvZG9jcy9jaGFydF90ZW1wbGF0ZV9ndWlkZS9nZXR0aW5nX3N0YXJ0ZWQvIzp+OnRleHQ9VElQJTNBJTIwVGhlJTIwbmFtZSUzQSUyMGZpZWxkJTIwaXMsYXJlJTIwbGltaXRlZCUyMHRvJTIwNTMlMjBjaGFyYWN0ZXJzXG4gICAgKi9cbiAgICBuYW1lID0gbmV3IHV0aWxzLlN0cmluZ0NvbnN0cmFpbnQoMSwgNjMpO1xuXG4gICAgLyoqXG4gICAgKiBuYW1lc3BhY2UgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAqIGh0dHBzOi8vaGVsbS5zaC9kb2NzL2NoYXJ0X3RlbXBsYXRlX2d1aWRlL2dldHRpbmdfc3RhcnRlZC8jOn46dGV4dD1USVAlM0ElMjBUaGUlMjBuYW1lJTNBJTIwZmllbGQlMjBpcyxhcmUlMjBsaW1pdGVkJTIwdG8lMjA1MyUyMGNoYXJhY3RlcnNcbiAgICAqL1xuICAgIG5hbWVzcGFjZSA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcblxuICAgIC8qKlxuICAgICogcmVsZWFzZSBjYW4gYmUgbm8gbGVzcyB0aGFuIDEgY2hhcmFjdGVyIGxvbmcsIGFuZCBubyBncmVhdGVyIHRoYW4gNTMgY2hhcmFjdGVycyBsb25nLlxuICAgICogaHR0cHM6Ly9oZWxtLnNoL2RvY3MvY2hhcnRfdGVtcGxhdGVfZ3VpZGUvZ2V0dGluZ19zdGFydGVkLyM6fjp0ZXh0PVRJUCUzQSUyMFRoZSUyMG5hbWUlM0ElMjBmaWVsZCUyMGlzLGFyZSUyMGxpbWl0ZWQlMjB0byUyMDUzJTIwY2hhcmFjdGVyc1xuICAgICovXG4gICAgcmVsZWFzZSA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDUzKTtcblxuICAgIC8qKlxuICAgICogcmVwb3NpdG9yeSBjYW4gYmUgbm8gbGVzcyB0aGFuIDAgY2hhcmFjdGVycyBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDQwOTYgY2hhcmFjdGVycyBsb25nLiBJdCBhbHNvIG11c3QgZm9sbG93IGEgVVJMIGZvcm1hdC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9jb25uZWN0L2xhdGVzdC9BUElSZWZlcmVuY2UvQVBJX1VybFJlZmVyZW5jZS5odG1sXG4gICAgKi9cbiAgICByZXBvc2l0b3J5ID0gbmV3IHV0aWxzLlVybFN0cmluZ0NvbnN0cmFpbnQoMCwgNDA5Nik7XG5cbiAgICAvKipcbiAgICAqIHZlcnNpb24gY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAqIGh0dHBzOi8vaGVsbS5zaC9kb2NzL2NoYXJ0X3RlbXBsYXRlX2d1aWRlL2dldHRpbmdfc3RhcnRlZC8jOn46dGV4dD1USVAlM0ElMjBUaGUlMjBuYW1lJTNBJTIwZmllbGQlMjBpcyxhcmUlMjBsaW1pdGVkJTIwdG8lMjA1MyUyMGNoYXJhY3RlcnNcbiAgICAqL1xuICAgIHZlcnNpb24gPSBuZXcgdXRpbHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBIZWxtQWRkT24gaW1wbGVtZW50cyBzcGkuQ2x1c3RlckFkZE9uIHtcblxuICAgIHByb3BzOiBIZWxtQWRkT25Qcm9wcztcblxuICAgIHB1YmxpYyBzdGF0aWMgdmFsaWRhdGVIZWxtVmVyc2lvbnMgPSBmYWxzZTtcbiAgICBwdWJsaWMgc3RhdGljIGZhaWxPblZlcnNpb25WYWxpZGF0aW9uID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSGVsbUFkZE9uUHJvcHMpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHV0aWxzLmNsb25lRGVlcChwcm9wcyk7IC8vIGF2b2lkcyBwb2x1dGlvbiB3aGVuIHJldXNpbmcgdGhlIHNhbWUgcHJvcHMgYWNyb3NzIHN0YWNrcywgc3VjaCBhcyB2YWx1ZXNcbiAgICAgICAgdXRpbHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgSGVsbUFkZG9uUHJvcHNDb25zdHJhaW50cywgSGVsbUFkZE9uLm5hbWUsIHByb3BzKTtcbiAgICAgICAgSGVsbUFkZE9uLnZhbGlkYXRlVmVyc2lvbihwcm9wcyk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB2YWxpZGF0ZVZlcnNpb24oaGVsbUNoYXJ0OiBIZWxtQ2hhcnRWZXJzaW9uKSB7XG4gICAgICAgIGlmKEhlbG1BZGRPbi52YWxpZGF0ZUhlbG1WZXJzaW9ucyAmJiAhaGVsbUNoYXJ0LnNraXBWZXJzaW9uVmFsaWRhdGlvbikge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2hlY2tIZWxtQ2hhcnRWZXJzaW9uKGhlbG1DaGFydCk7XG4gICAgICAgICAgICBpZih0aGlzLmZhaWxPblZlcnNpb25WYWxpZGF0aW9uICYmICFyZXN1bHQubGF0ZXN0VmVyc2lvbikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSGVsbSB2ZXJzaW9uIHZhbGlkYXRpb24gZmFpbGVkIGZvciAke2hlbG1DaGFydC5jaGFydH0uIFxuICAgICAgICAgICAgICAgICAgICBVc2VkIHZlcnNpb24gJHtoZWxtQ2hhcnQudmVyc2lvbn0sIGxhdGVzdCB2ZXJzaW9uOiAke3Jlc3VsdC5oaWdoZXN0VmVyc2lvbn1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEV4cGVjdGVkIHRvIGJlIGltcGxlbWVudGVkIGluIGNvbmNyZXRlIHN1YmNsYXNzZXMuXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvIFxuICAgICAqL1xuICAgIGFic3RyYWN0IGRlcGxveShjbHVzdGVySW5mbzogc3BpLkNsdXN0ZXJJbmZvKTogdm9pZCB8IFByb21pc2U8Q29uc3RydWN0PjtcblxuIFxuICAgIC8qKlxuICAgICAqIERlcGxveXMgdGhlIGhlbG0gY2hhcnQgaW4gdGhlIGNsdXN0ZXIuIFxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKiBAcGFyYW0gdmFsdWVzIFxuICAgICAqIEBwYXJhbSBjcmVhdGVOYW1lc3BhY2UgXG4gICAgICogQHBhcmFtIHdhaXQgXG4gICAgICogQHBhcmFtIHRpbWVvdXQgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGFkZEhlbG1DaGFydChjbHVzdGVySW5mbzogc3BpLkNsdXN0ZXJJbmZvLCB2YWx1ZXM/OiBzcGkuVmFsdWVzLCBjcmVhdGVOYW1lc3BhY2U/OiBib29sZWFuLCB3YWl0PzogYm9vbGVhbiwgdGltZW91dD86IER1cmF0aW9uKTogQ29uc3RydWN0IHtcbiAgICAgICBjb25zdCBrdWJlY3RsUHJvdmlkZXIgPSBuZXcgS3ViZWN0bFByb3ZpZGVyKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgdmFsdWVzID0gdmFsdWVzID8/IHt9O1xuICAgICAgICBjb25zdCBjaGFydCA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyB2YWx1ZXMsIHdhaXQsIHRpbWVvdXQsIGNyZWF0ZU5hbWVzcGFjZSB9IH07XG4gICAgICAgIHJldHVybiBrdWJlY3RsUHJvdmlkZXIuYWRkSGVsbUNoYXJ0KGNoYXJ0KTtcbiAgICB9XG59Il19