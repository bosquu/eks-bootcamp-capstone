"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClusterAutoScalerAddOn = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const iam = require("aws-cdk-lib/aws-iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const console_1 = require("console");
const cluster_providers_1 = require("../../cluster-providers");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const RELEASE = 'blueprints-addon-cluster-autoscaler';
const NAME = 'cluster-autoscaler';
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    chart: NAME,
    name: NAME,
    namespace: 'kube-system',
    release: RELEASE,
    repository: 'https://kubernetes.github.io/autoscaler',
    version: 'auto'
};
/**
 * Version of the autoscaler, controls the image tag
 */
const versionMap = new Map([
    //[KubernetesVersion.V1_22, "9.11.0"],
    [aws_eks_1.KubernetesVersion.V1_21, "9.10.8"],
    [aws_eks_1.KubernetesVersion.V1_20, "9.9.2"],
    [aws_eks_1.KubernetesVersion.V1_19, "9.4.0"],
    [aws_eks_1.KubernetesVersion.V1_18, "9.4.0"],
]);
class ClusterAutoScalerAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b, _c;
        if (((_a = this.options.version) === null || _a === void 0 ? void 0 : _a.trim()) === 'auto') {
            this.options.version = versionMap.get(clusterInfo.version);
            (0, console_1.assert)(this.options.version, (_c = "Unable to auto-detect cluster autoscaler version. Applying latest. Provided EKS cluster version: "
                + ((_b = clusterInfo.version) === null || _b === void 0 ? void 0 : _b.version)) !== null && _c !== void 0 ? _c : clusterInfo.version);
        }
        const cluster = clusterInfo.cluster;
        const nodeGroups = (0, cluster_providers_1.assertEC2NodeGroup)(clusterInfo, "Cluster Autoscaler");
        const values = this.options.values || {};
        const namespace = this.options.namespace;
        // Create IAM Policy
        const autoscalerStmt = new iam.PolicyStatement();
        autoscalerStmt.addResources("*");
        autoscalerStmt.addActions("autoscaling:DescribeAutoScalingGroups", "autoscaling:DescribeAutoScalingInstances", "autoscaling:DescribeLaunchConfigurations", "autoscaling:DescribeTags", "autoscaling:SetDesiredCapacity", "autoscaling:TerminateInstanceInAutoScalingGroup", "ec2:DescribeLaunchTemplateVersions");
        const autoscalerPolicyDocument = new iam.PolicyDocument({
            statements: [autoscalerStmt]
        });
        // Tag node groups
        const clusterName = new aws_cdk_lib_1.CfnJson(cluster.stack, "clusterName", {
            value: cluster.clusterName,
        });
        for (let ng of nodeGroups) {
            aws_cdk_lib_1.Tags.of(ng).add(`k8s.io/cluster-autoscaler/${clusterName}`, "owned", { applyToLaunchedInstances: true });
            aws_cdk_lib_1.Tags.of(ng).add("k8s.io/cluster-autoscaler/enabled", "true", { applyToLaunchedInstances: true });
        }
        // Create namespace
        if (this.options.createNamespace) {
            (0, utils_1.createNamespace)(namespace, cluster, true);
        }
        // Create IRSA
        const sa = (0, utils_1.createServiceAccount)(cluster, RELEASE, namespace, autoscalerPolicyDocument);
        // Create Helm Chart
        (0, utils_1.setPath)(values, "cloudProvider", "aws");
        (0, utils_1.setPath)(values, "autoDiscovery.clusterName", cluster.clusterName);
        (0, utils_1.setPath)(values, "awsRegion", cluster.stack.region);
        (0, utils_1.setPath)(values, "rbac.serviceAccount.create", false);
        (0, utils_1.setPath)(values, "rbac.serviceAccount.name", RELEASE);
        const clusterAutoscalerChart = this.addHelmChart(clusterInfo, values, false);
        clusterAutoscalerChart.node.addDependency(sa);
        return Promise.resolve(clusterAutoscalerChart);
    }
}
__decorate([
    (0, utils_1.conflictsWith)('KarpenterAddOn')
], ClusterAutoScalerAddOn.prototype, "deploy", null);
exports.ClusterAutoScalerAddOn = ClusterAutoScalerAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2NsdXN0ZXItYXV0b3NjYWxlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxpREFBd0Q7QUFDeEQsMkNBQTJDO0FBQzNDLDZDQUE0QztBQUU1QyxxQ0FBaUM7QUFDakMsK0RBQTZEO0FBRTdELHVDQUE0RjtBQUM1Riw4Q0FBOEQ7QUFrQjlELE1BQU0sT0FBTyxHQUFHLHFDQUFxQyxDQUFDO0FBQ3RELE1BQU0sSUFBSSxHQUFHLG9CQUFvQixDQUFDO0FBQ2xDOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQWdDO0lBQzlDLEtBQUssRUFBRSxJQUFJO0lBQ1gsSUFBSSxFQUFFLElBQUk7SUFDVixTQUFTLEVBQUUsYUFBYTtJQUN4QixPQUFPLEVBQUUsT0FBTztJQUNoQixVQUFVLEVBQUUseUNBQXlDO0lBQ3JELE9BQU8sRUFBRSxNQUFNO0NBQ2xCLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxDQUFDO0lBQ3ZCLHNDQUFzQztJQUN0QyxDQUFDLDJCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLENBQUM7SUFDbkMsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO0lBQ2xDLENBQUMsMkJBQWlCLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQztJQUNsQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssRUFBRSxPQUFPLENBQUM7Q0FDckMsQ0FBQyxDQUFDO0FBRUgsTUFBYSxzQkFBdUIsU0FBUSxzQkFBUztJQUlqRCxZQUFZLEtBQW1DO1FBQzNDLEtBQUssQ0FBQyxFQUFFLEdBQUcsWUFBbUIsRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7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QUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdFLHNCQUFzQixDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFOUMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDbkQsQ0FBQztDQUNKO0FBM0RHO0lBREMsSUFBQSxxQkFBYSxFQUFDLGdCQUFnQixDQUFDO29EQTJEL0I7QUFwRUwsd0RBcUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgS3ViZXJuZXRlc1ZlcnNpb24gfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgeyBDZm5Kc29uLCBUYWdzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSBcImNvbnNvbGVcIjtcbmltcG9ydCB7IGFzc2VydEVDMk5vZGVHcm91cCB9IGZyb20gXCIuLi8uLi9jbHVzdGVyLXByb3ZpZGVyc1wiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBjb25mbGljdHNXaXRoLCBjcmVhdGVOYW1lc3BhY2UsIGNyZWF0ZVNlcnZpY2VBY2NvdW50LCBzZXRQYXRoIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblVzZXJQcm9wcyB9IGZyb20gXCIuLi9oZWxtLWFkZG9uXCI7XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENsdXN0ZXJBdXRvU2NhbGVyQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVmVyc2lvbiBvZiB0aGUgQ2x1c3RlciBBdXRvc2NhbGVyXG4gICAgICogQGRlZmF1bHQgYXV0byBkaXNjb3ZlcmVkIGJhc2VkIG9uIEVLUyB2ZXJzaW9uLlxuICAgICAqL1xuICAgIHZlcnNpb24/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgbmFtZXNwYWNlXG4gICAgICovXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcbn1cblxuY29uc3QgUkVMRUFTRSA9ICdibHVlcHJpbnRzLWFkZG9uLWNsdXN0ZXItYXV0b3NjYWxlcic7XG5jb25zdCBOQU1FID0gJ2NsdXN0ZXItYXV0b3NjYWxlcic7XG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBDbHVzdGVyQXV0b1NjYWxlckFkZE9uUHJvcHMgPSB7XG4gICAgY2hhcnQ6IE5BTUUsXG4gICAgbmFtZTogTkFNRSxcbiAgICBuYW1lc3BhY2U6ICdrdWJlLXN5c3RlbScsXG4gICAgcmVsZWFzZTogUkVMRUFTRSxcbiAgICByZXBvc2l0b3J5OiAnaHR0cHM6Ly9rdWJlcm5ldGVzLmdpdGh1Yi5pby9hdXRvc2NhbGVyJyxcbiAgICB2ZXJzaW9uOiAnYXV0bydcbn07XG5cbi8qKlxuICogVmVyc2lvbiBvZiB0aGUgYXV0b3NjYWxlciwgY29udHJvbHMgdGhlIGltYWdlIHRhZ1xuICovXG5jb25zdCB2ZXJzaW9uTWFwID0gbmV3IE1hcChbXG4gICAgLy9bS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjIsIFwiOS4xMS4wXCJdLFxuICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yMSwgXCI5LjEwLjhcIl0sXG4gICAgW0t1YmVybmV0ZXNWZXJzaW9uLlYxXzIwLCBcIjkuOS4yXCJdLFxuICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8xOSwgXCI5LjQuMFwiXSxcbiAgICBbS3ViZXJuZXRlc1ZlcnNpb24uVjFfMTgsIFwiOS40LjBcIl0sXG5dKTtcblxuZXhwb3J0IGNsYXNzIENsdXN0ZXJBdXRvU2NhbGVyQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBDbHVzdGVyQXV0b1NjYWxlckFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IENsdXN0ZXJBdXRvU2NhbGVyQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcyBhcyBhbnksIC4uLnByb3BzIH0pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzO1xuICAgIH1cbiAgICBcbiAgICBAY29uZmxpY3RzV2l0aCgnS2FycGVudGVyQWRkT24nKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuXG4gICAgICAgIGlmKHRoaXMub3B0aW9ucy52ZXJzaW9uPy50cmltKCkgPT09ICdhdXRvJykge1xuICAgICAgICAgICAgdGhpcy5vcHRpb25zLnZlcnNpb24gPSB2ZXJzaW9uTWFwLmdldChjbHVzdGVySW5mby52ZXJzaW9uKTtcbiAgICAgICAgICAgIGFzc2VydCh0aGlzLm9wdGlvbnMudmVyc2lvbiwgXCJVbmFibGUgdG8gYXV0by1kZXRlY3QgY2x1c3RlciBhdXRvc2NhbGVyIHZlcnNpb24uIEFwcGx5aW5nIGxhdGVzdC4gUHJvdmlkZWQgRUtTIGNsdXN0ZXIgdmVyc2lvbjogXCIgXG4gICAgICAgICAgICAgICAgKyBjbHVzdGVySW5mby52ZXJzaW9uPy52ZXJzaW9uID8/IGNsdXN0ZXJJbmZvLnZlcnNpb24pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBub2RlR3JvdXBzID0gYXNzZXJ0RUMyTm9kZUdyb3VwKGNsdXN0ZXJJbmZvLCBcIkNsdXN0ZXIgQXV0b3NjYWxlclwiKTtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gdGhpcy5vcHRpb25zLnZhbHVlcyB8fCB7fTtcbiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5vcHRpb25zLm5hbWVzcGFjZSE7XG4gICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgSUFNIFBvbGljeVxuICAgICAgICBjb25zdCBhdXRvc2NhbGVyU3RtdCA9IG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KCk7XG4gICAgICAgIGF1dG9zY2FsZXJTdG10LmFkZFJlc291cmNlcyhcIipcIik7XG4gICAgICAgIGF1dG9zY2FsZXJTdG10LmFkZEFjdGlvbnMoXG4gICAgICAgICAgICBcImF1dG9zY2FsaW5nOkRlc2NyaWJlQXV0b1NjYWxpbmdHcm91cHNcIixcbiAgICAgICAgICAgIFwiYXV0b3NjYWxpbmc6RGVzY3JpYmVBdXRvU2NhbGluZ0luc3RhbmNlc1wiLFxuICAgICAgICAgICAgXCJhdXRvc2NhbGluZzpEZXNjcmliZUxhdW5jaENvbmZpZ3VyYXRpb25zXCIsXG4gICAgICAgICAgICBcImF1dG9zY2FsaW5nOkRlc2NyaWJlVGFnc1wiLFxuICAgICAgICAgICAgXCJhdXRvc2NhbGluZzpTZXREZXNpcmVkQ2FwYWNpdHlcIixcbiAgICAgICAgICAgIFwiYXV0b3NjYWxpbmc6VGVybWluYXRlSW5zdGFuY2VJbkF1dG9TY2FsaW5nR3JvdXBcIixcbiAgICAgICAgICAgIFwiZWMyOkRlc2NyaWJlTGF1bmNoVGVtcGxhdGVWZXJzaW9uc1wiXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgYXV0b3NjYWxlclBvbGljeURvY3VtZW50ID0gbmV3IGlhbS5Qb2xpY3lEb2N1bWVudCh7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbYXV0b3NjYWxlclN0bXRdXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFRhZyBub2RlIGdyb3Vwc1xuICAgICAgICBjb25zdCBjbHVzdGVyTmFtZSA9IG5ldyBDZm5Kc29uKGNsdXN0ZXIuc3RhY2ssIFwiY2x1c3Rlck5hbWVcIiwge1xuICAgICAgICAgICAgdmFsdWU6IGNsdXN0ZXIuY2x1c3Rlck5hbWUsXG4gICAgICAgIH0pO1xuICAgICAgICBmb3IobGV0IG5nIG9mIG5vZGVHcm91cHMpIHtcbiAgICAgICAgICAgIFRhZ3Mub2YobmcpLmFkZChgazhzLmlvL2NsdXN0ZXItYXV0b3NjYWxlci8ke2NsdXN0ZXJOYW1lfWAsIFwib3duZWRcIiwgeyBhcHBseVRvTGF1bmNoZWRJbnN0YW5jZXM6IHRydWUgfSk7XG4gICAgICAgICAgICBUYWdzLm9mKG5nKS5hZGQoXCJrOHMuaW8vY2x1c3Rlci1hdXRvc2NhbGVyL2VuYWJsZWRcIiwgXCJ0cnVlXCIsIHsgYXBwbHlUb0xhdW5jaGVkSW5zdGFuY2VzOiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgbmFtZXNwYWNlXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY3JlYXRlTmFtZXNwYWNlKSB7XG4gICAgICAgICAgICBjcmVhdGVOYW1lc3BhY2UobmFtZXNwYWNlLCBjbHVzdGVyLCB0cnVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBJUlNBXG4gICAgICAgIGNvbnN0IHNhID0gY3JlYXRlU2VydmljZUFjY291bnQoY2x1c3RlciwgUkVMRUFTRSwgbmFtZXNwYWNlLCBhdXRvc2NhbGVyUG9saWN5RG9jdW1lbnQpO1xuXG4gICAgICAgIC8vIENyZWF0ZSBIZWxtIENoYXJ0XG4gICAgICAgIHNldFBhdGgodmFsdWVzLCBcImNsb3VkUHJvdmlkZXJcIiwgXCJhd3NcIik7XG4gICAgICAgIHNldFBhdGgodmFsdWVzLCBcImF1dG9EaXNjb3ZlcnkuY2x1c3Rlck5hbWVcIiwgY2x1c3Rlci5jbHVzdGVyTmFtZSk7XG4gICAgICAgIHNldFBhdGgodmFsdWVzLCBcImF3c1JlZ2lvblwiLCBjbHVzdGVyLnN0YWNrLnJlZ2lvbik7XG4gICAgICAgIHNldFBhdGgodmFsdWVzLCBcInJiYWMuc2VydmljZUFjY291bnQuY3JlYXRlXCIsIGZhbHNlKTtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwicmJhYy5zZXJ2aWNlQWNjb3VudC5uYW1lXCIsIFJFTEVBU0UpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgY2x1c3RlckF1dG9zY2FsZXJDaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMsIGZhbHNlKTtcbiAgICAgICAgY2x1c3RlckF1dG9zY2FsZXJDaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2EpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2x1c3RlckF1dG9zY2FsZXJDaGFydCk7XG4gICAgfVxufSJdfQ==