"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationStage = exports.CodePipelineStack = exports.CodePipelineBuilder = exports.isCodeCommitRepo = exports.cdkpipelines = void 0;
const assert = require("assert");
const cdk = require("aws-cdk-lib");
const codecommit = require("aws-cdk-lib/aws-codecommit");
const cdkpipelines = require("aws-cdk-lib/pipelines");
exports.cdkpipelines = cdkpipelines;
const usage_utils_1 = require("../utils/usage-utils");
function isCodeCommitRepo(repo) {
    if (Object.prototype.hasOwnProperty.call(repo, "codeCommitRepoName")) {
        return true;
    }
    else {
        return false;
    }
}
exports.isCodeCommitRepo = isCodeCommitRepo;
/**
 * Builder for CodePipeline.
 */
class CodePipelineBuilder {
    constructor() {
        this.props = { crossAccountKeys: false, stages: [], waves: [] };
    }
    name(name) {
        this.props.name = name;
        return this;
    }
    owner(owner) {
        this.props.owner = owner;
        return this;
    }
    enableCrossAccountKeys() {
        this.props.crossAccountKeys = true;
        return this;
    }
    repository(repo) {
        this.props.repository = repo;
        if (isCodeCommitRepo(repo)) {
            this.props.repository = repo;
        }
        return this;
    }
    /**
     * Adds standalone pipeline stages (in the order of invocation and elements in the input array)
     * @param stackStages
     * @returns
     */
    stage(...stackStages) {
        stackStages.forEach(stage => this.props.stages.push(stage));
        return this;
    }
    /**
     * Adds wave(s) in the order specified. All stages in the wave can be executed in parallel, while standalone stages are executed sequentially.
     * @param waves
     * @returns
     */
    wave(...waves) {
        waves.forEach(wave => {
            this.props.waves.push(wave);
            wave.stages.forEach(stage => { var _a; return (_a = this.props.stages) === null || _a === void 0 ? void 0 : _a.push({ ...stage, ...{ waveId: wave.id } }); });
        });
        return this;
    }
    build(scope, id, stackProps) {
        assert(this.props.name, "name field is required for the pipeline stack. Please provide value.");
        assert(this.props.stages, "Stage field is required for the pipeline stack. Please provide value.");
        if (this.props.repository) {
            let gitHubRepo = this.props.repository;
            if (!(isCodeCommitRepo(this.props.repository))) {
                assert((this.props.owner || gitHubRepo.owner), "repository.owner field is required for the GitHub pipeline stack. Please provide value.");
            }
        }
        const fullProps = this.props;
        return new CodePipelineStack(scope, fullProps, id, stackProps);
    }
}
exports.CodePipelineBuilder = CodePipelineBuilder;
/**
 * Pipeline stack is generating a self-mutating pipeline to faciliate full CI/CD experience with the platform
 * for infrastructure changes.
 */
class CodePipelineStack extends cdk.Stack {
    constructor(scope, pipelineProps, id, props) {
        if (pipelineProps.crossAccountKeys) {
            super(scope, id, (0, usage_utils_1.withUsageTracking)(CodePipelineStack.USAGE_ID_MULTI_ACCOUNT, props));
        }
        else {
            super(scope, id, (0, usage_utils_1.withUsageTracking)(CodePipelineStack.USAGE_ID, props));
        }
        const pipeline = CodePipeline.build(this, pipelineProps);
        let promises = [];
        for (let stage of pipelineProps.stages) {
            const appStage = new ApplicationStage(this, stage.id, stage.stackBuilder);
            promises.push(appStage.waitForAsyncTasks());
        }
        Promise.all(promises).then(stages => {
            let currentWave;
            for (let i in stages) {
                const stage = pipelineProps.stages[i];
                if (stage.waveId) {
                    if (currentWave == null || currentWave.id != stage.waveId) {
                        const waveProps = pipelineProps.waves.find(wave => wave.id === stage.waveId);
                        assert(waveProps, `Specified wave ${stage.waveId} is not found in the pipeline definition ${id}`);
                        currentWave = pipeline.addWave(stage.waveId, { ...waveProps.props });
                    }
                    currentWave.addStage(stages[i], stage.stageProps);
                }
                else {
                    pipeline.addStage(stages[i], stage.stageProps);
                }
            }
        });
    }
    static builder() {
        return new CodePipelineBuilder();
    }
}
exports.CodePipelineStack = CodePipelineStack;
CodePipelineStack.USAGE_ID = "qs-1s1r465k6";
CodePipelineStack.USAGE_ID_MULTI_ACCOUNT = "qs-1s1r465f2";
class ApplicationStage extends cdk.Stage {
    constructor(scope, id, builder, props) {
        super(scope, id, props);
        if (builder.buildAsync !== undefined) {
            this.asyncTask = builder.buildAsync(this, `${id}-blueprint`, props);
        }
        else {
            builder.build(this, `${id}-blueprint`, props);
        }
    }
    async waitForAsyncTasks() {
        if (this.asyncTask) {
            return this.asyncTask.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
}
exports.ApplicationStage = ApplicationStage;
/**
 * CodePipeline deploys a new CodePipeline resource that is integrated with a GitHub repository.
 */
class CodePipeline {
    static build(scope, props) {
        var _a, _b, _c;
        let codePipelineSource = undefined;
        if (isCodeCommitRepo(props.repository)) {
            let codeCommitRepo = props.repository;
            codePipelineSource = cdkpipelines.CodePipelineSource.codeCommit(codecommit.Repository.fromRepositoryName(scope, 'cdk-eks-blueprints', codeCommitRepo.codeCommitRepoName), (_a = codeCommitRepo.targetRevision) !== null && _a !== void 0 ? _a : 'master', codeCommitRepo.codeCommitOptions);
        }
        else {
            let gitHubRepo = props.repository;
            let githubProps = undefined;
            const gitHubOwner = (_b = gitHubRepo.owner) !== null && _b !== void 0 ? _b : props.owner;
            if (gitHubRepo.credentialsSecretName) {
                githubProps = {
                    authentication: cdk.SecretValue.secretsManager(gitHubRepo.credentialsSecretName)
                };
            }
            codePipelineSource = cdkpipelines.CodePipelineSource.gitHub(`${gitHubOwner}/${gitHubRepo.repoUrl}`, (_c = gitHubRepo.targetRevision) !== null && _c !== void 0 ? _c : 'main', githubProps);
        }
        return new cdkpipelines.CodePipeline(scope, props.name, {
            pipelineName: props.name,
            synth: new cdkpipelines.ShellStep(`${props.name}-synth`, {
                input: codePipelineSource,
                installCommands: [
                    'npm install --global npm',
                    'npm install -g aws-cdk@2.37.1',
                    'npm install',
                ],
                commands: ['npm run build', 'npx cdk synth']
            }),
            crossAccountKeys: props.crossAccountKeys,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1waXBlbGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9waXBlbGluZXMvY29kZS1waXBlbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBaUM7QUFDakMsbUNBQW1DO0FBRW5DLHlEQUF5RDtBQUN6RCxzREFBc0Q7QUFNbEQsb0NBQVk7QUFIaEIsc0RBQXlEO0FBNkN6RCxTQUFnQixnQkFBZ0IsQ0FBQyxJQUF5RDtJQUN0RixJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLENBQUMsRUFBRTtRQUNsRSxPQUFPLElBQUksQ0FBQztLQUNmO1NBQU07UUFDSCxPQUFPLEtBQUssQ0FBQztLQUNoQjtBQUNMLENBQUM7QUFORCw0Q0FNQztBQWdGRDs7R0FFRztBQUNILE1BQWEsbUJBQW1CO0lBSzVCO1FBQ0ksSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU0sSUFBSSxDQUFDLElBQVk7UUFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxLQUFLLENBQUMsS0FBYTtRQUN0QixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLHNCQUFzQjtRQUN6QixJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztRQUNuQyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sVUFBVSxDQUFDLElBQXlEO1FBQ3ZFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQThCLENBQUM7UUFDdkQs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QkFDRCxRQUFRLEVBQUUsQ0FBQyxlQUFlLEVBQUUsZUFBZSxDQUFDO2FBQzdDLENBQUM7WUFDRixnQkFBZ0IsRUFBRSxLQUFLLENBQUMsZ0JBQWdCO1NBQ3pDLENBQUMsQ0FBQztJQUNULENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgU3RhY2tQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGNvZGVjb21taXQgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZGVjb21taXQnO1xuaW1wb3J0ICogYXMgY2RrcGlwZWxpbmVzIGZyb20gJ2F3cy1jZGstbGliL3BpcGVsaW5lcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZXBvc2l0b3J5LCBBc3luY1N0YWNrQnVpbGRlciwgU3RhY2tCdWlsZGVyIH0gZnJvbSAnLi4vc3BpJztcbmltcG9ydCB7IHdpdGhVc2FnZVRyYWNraW5nIH0gZnJvbSAnLi4vdXRpbHMvdXNhZ2UtdXRpbHMnO1xuXG5leHBvcnQge1xuICAgIGNka3BpcGVsaW5lc1xufTtcblxuLyoqXG4gKiBjcmVkZW50aWFsc1R5cGUgaXMgZXhjbHVkZWQgYW5kIHRoZSBvbmx5IHN1cHBvcnRlZCBjcmVkZW50aWFsc1NlY3JldCBpcyBhIHBsYWludGV4dCBHaXRIdWIgT0F1dGggdG9rZW4uXG4gKiByZXBvVXJsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR2l0SHViU291cmNlUmVwb3NpdG9yeSBleHRlbmRzIE9taXQ8QXBwbGljYXRpb25SZXBvc2l0b3J5LCBcImNyZWRlbnRpYWxzVHlwZVwiPiB7XG4gICAgLyoqXG4gICAgICogQSBHaXRIdWIgT0F1dGggdG9rZW4gdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvbiBzdG9yZWQgd2l0aCBBV1MgU2VjcmV0IE1hbmFnZXIuXG4gICAgICogVGhlIHByb3ZpZGVkIG5hbWUgd2lsbCBiZSBsb29rZWQgdXAgdXNpbmcgdGhlIGZvbGxvd2luZzpcbiAgICAgKiBgYGB0c1xuICAgICAqIGNvbnN0IGNyZWRlbnRpYWxzID0gY2RrLlNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKCdteS1naXRodWItdG9rZW4nKTtcbiAgICAgKiBgYGBcbiAgICAgKlxuICAgICAqIFRoZSBHaXRIdWIgUGVyc29uYWwgQWNjZXNzIFRva2VuIHNob3VsZCBoYXZlIHRoZXNlIHNjb3BlczpcbiAgICAgKlxuICAgICAqICogKipyZXBvKiogLSB0byByZWFkIHRoZSByZXBvc2l0b3J5XG4gICAgICogKiAqKmFkbWluOnJlcG9faG9vayoqIC0gaWYgeW91IHBsYW4gdG8gdXNlIHdlYmhvb2tzICh0cnVlIGJ5IGRlZmF1bHQpXG4gICAgICpcbiAgICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9jb2RlcGlwZWxpbmUvbGF0ZXN0L3VzZXJndWlkZS9HaXRIdWItY3JlYXRlLXBlcnNvbmFsLXRva2VuLUNMSS5odG1sXG4gICAgICovXG4gICAgY3JlZGVudGlhbHNTZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIG93bmVyIG9mIHRoZSByZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmUgKEdpdEh1YiBoYW5kbGUpLlxuICAgICovXG4gICAgb3duZXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29kZUNvbW1pdFNvdXJjZVJlcG9zaXRvcnlcbiAgICBleHRlbmRzIE9taXQ8QXBwbGljYXRpb25SZXBvc2l0b3J5LCBcImNyZWRlbnRpYWxzVHlwZVwiIHwgXCJjcmVkZW50aWFsc1NlY3JldE5hbWUgXCIgfCBcInJlcG9VcmxcIj4ge1xuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIG9mIHRoZSBDb2RlQ29tbWl0IHJlcG9zaXRvcnkuXG4gICAgICovXG4gICAgY29kZUNvbW1pdFJlcG9OYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCBDb2RlQ29tbWl0U291cmNlT3B0aW9ucy5cbiAgICAgKi9cbiAgICBjb2RlQ29tbWl0T3B0aW9ucz86IGNka3BpcGVsaW5lcy5Db2RlQ29tbWl0U291cmNlT3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29kZUNvbW1pdFJlcG8ocmVwbzogR2l0SHViU291cmNlUmVwb3NpdG9yeSB8IENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5KTogYm9vbGVhbntcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlcG8sIFwiY29kZUNvbW1pdFJlcG9OYW1lXCIpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG5cbi8qKlxuICogUHJvcHMgZm9yIHRoZSBQaXBlbGluZS5cbiAqL1xuZXhwb3J0IHR5cGUgUGlwZWxpbmVQcm9wcyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIGZvciB0aGUgcGlwZWxpbmUuXG4gICAgICovXG4gICAgbmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG93bmVyIG9mIHRoZSByZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmUgKEdpdEh1YiBoYW5kbGUpLlxuICAgICAqL1xuICAgIG93bmVyPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogRW5hYmxlL0Rpc2FibGUgYWxsb3dpbmcgY3Jvc3MtYWNjb3VudCBkZXBsb3ltZW50cy5cbiAgICAgKi9cbiAgICBjcm9zc0FjY291bnRLZXlzOiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogUmVwb3NpdG9yeSBmb3IgdGhlIHBpcGVsaW5lIChHaXRIdWIgb3IgQ29kZUNvbW1pdFJlcG9zaXRvcnkpLlxuICAgICAqL1xuICAgIHJlcG9zaXRvcnk6IEdpdEh1YlNvdXJjZVJlcG9zaXRvcnkgfCBDb2RlQ29tbWl0U291cmNlUmVwb3NpdG9yeTtcblxuICAgIC8qKlxuICAgICAqIFBpcGVsaW5lIHN0YWdlcyBhbmQgb3B0aW9ucy5cbiAgICAgKi9cbiAgICBzdGFnZXM6IFdhdmVTdGFnZVtdO1xuXG4gICAgLyoqXG4gICAgICogV2F2ZXMgZm9yIHRoZSBwaXBlbGluZS4gU3RhZ2VzIGluc2lkZSB0aGUgd2F2ZSBhcmUgZXhlY3V0ZWQgaW4gcGFyYWxsZWwuXG4gICAgICovXG4gICAgd2F2ZXM6IFBpcGVsaW5lV2F2ZVtdO1xufVxuXG4vKipcbiAqIFN0YWNrIHN0YWdlIGlzIGEgYnVpbGRlciBjb25zdHJ1Y3QgdG8gYWxsb3cgYWRkaW5nIHN0YWdlcyB0byBhIHBpcGVsaW5lLiBFYWNoIHN0YWdlIGlzIGV4cGVjdGVkIHRvIHByb2R1Y2UgYSBzdGFjay5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFja1N0YWdlIHtcbiAgICAvKipcbiAgICAgKiBpZCBvZiB0aGUgc3RhZ2VcbiAgICAgKi9cbiAgICBpZDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQnVpbGRlciB0aGF0IGNhbiBwcm9kdWNlIGEgc3RhY2sgd2hpY2ggd2lsbCBiZSBkZXBsb3llZCBhcyBwYXJ0IG9mIHRoZSBzdGFnZVxuICAgICAqL1xuICAgIHN0YWNrQnVpbGRlcjogU3RhY2tCdWlsZGVyO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgc3RhZ2UgcHJvcGVydGllcywgc3VjaCBhcyB7bWFudWFsQXBwcm92YWxzOiB0cnVlfSB3aGljaCBjYW4gY29udHJvbCBzdGFnZSB0cmFuc2l0aW9ucy5cbiAgICAgKi9cbiAgICBzdGFnZVByb3BzPzogY2RrcGlwZWxpbmVzLkFkZFN0YWdlT3B0cztcbn1cblxuLyoqXG4gKiBJbnRlcm5hbCBpbnRlcmZhY2UgZm9yIHdhdmUgc3RhZ2VzXG4gKi9cbmludGVyZmFjZSBXYXZlU3RhZ2UgZXh0ZW5kcyBTdGFja1N0YWdlIHtcbiAgICAvKipcbiAgICAgKiBXYXZlIGlkIGlmIHRoaXMgc3RhZ2UgaXMgcGFydCBvZiBhIHdhdmUuIE5vdCByZXF1aXJlZCBpZiBzdGFnZSBpcyBzdXBwbGllZFxuICAgICAqL1xuICAgIHdhdmVJZD86IHN0cmluZyxcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIHdhdmUgY29uZmlndXJhdGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIFBpcGVsaW5lV2F2ZSB7XG5cbiAgICBpZDogc3RyaW5nLFxuXG4gICAgc3RhZ2VzOiBTdGFja1N0YWdlW10sXG5cbiAgICBwcm9wcz86IGNka3BpcGVsaW5lcy5XYXZlUHJvcHNcbn1cblxuLyoqXG4gKiBCdWlsZGVyIGZvciBDb2RlUGlwZWxpbmUuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb2RlUGlwZWxpbmVCdWlsZGVyIGltcGxlbWVudHMgU3RhY2tCdWlsZGVyIHtcblxuICAgIHByaXZhdGUgcHJvcHM6IFBhcnRpYWw8UGlwZWxpbmVQcm9wcz47XG5cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnByb3BzID0geyBjcm9zc0FjY291bnRLZXlzOiBmYWxzZSwgc3RhZ2VzOiBbXSwgd2F2ZXM6IFtdfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmFtZShuYW1lOiBzdHJpbmcpOiBDb2RlUGlwZWxpbmVCdWlsZGVyIHtcbiAgICAgICAgdGhpcy5wcm9wcy5uYW1lID0gbmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIG93bmVyKG93bmVyOiBzdHJpbmcpIDogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgICAgIHRoaXMucHJvcHMub3duZXIgPSBvd25lcjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGVuYWJsZUNyb3NzQWNjb3VudEtleXMoKSA6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB0aGlzLnByb3BzLmNyb3NzQWNjb3VudEtleXMgPSB0cnVlO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVwb3NpdG9yeShyZXBvOiBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5IHwgQ29kZUNvbW1pdFNvdXJjZVJlcG9zaXRvcnkpOiBDb2RlUGlwZWxpbmVCdWlsZGVyIHtcbiAgICAgICAgdGhpcy5wcm9wcy5yZXBvc2l0b3J5ID0gcmVwbyBhcyBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuICAgICAgICBpZiAoaXNDb2RlQ29tbWl0UmVwbyhyZXBvKSkge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZXBvc2l0b3J5ID0gcmVwbyBhcyBDb2RlQ29tbWl0U291cmNlUmVwb3NpdG9yeTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIHN0YW5kYWxvbmUgcGlwZWxpbmUgc3RhZ2VzIChpbiB0aGUgb3JkZXIgb2YgaW52b2NhdGlvbiBhbmQgZWxlbWVudHMgaW4gdGhlIGlucHV0IGFycmF5KVxuICAgICAqIEBwYXJhbSBzdGFja1N0YWdlc1xuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHVibGljIHN0YWdlKC4uLnN0YWNrU3RhZ2VzOiBTdGFja1N0YWdlW10pIDogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgICAgIHN0YWNrU3RhZ2VzLmZvckVhY2goc3RhZ2UgPT4gdGhpcy5wcm9wcy5zdGFnZXMhLnB1c2goc3RhZ2UpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyB3YXZlKHMpIGluIHRoZSBvcmRlciBzcGVjaWZpZWQuIEFsbCBzdGFnZXMgaW4gdGhlIHdhdmUgY2FuIGJlIGV4ZWN1dGVkIGluIHBhcmFsbGVsLCB3aGlsZSBzdGFuZGFsb25lIHN0YWdlcyBhcmUgZXhlY3V0ZWQgc2VxdWVudGlhbGx5LlxuICAgICAqIEBwYXJhbSB3YXZlc1xuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHVibGljIHdhdmUoLi4ud2F2ZXM6IFBpcGVsaW5lV2F2ZVtdKSA6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB3YXZlcy5mb3JFYWNoKHdhdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy53YXZlcyEucHVzaCh3YXZlKTtcbiAgICAgICAgICAgIHdhdmUuc3RhZ2VzLmZvckVhY2goc3RhZ2UgPT4gdGhpcy5wcm9wcy5zdGFnZXM/LnB1c2goey4uLnN0YWdlLCAuLi57IHdhdmVJZDogd2F2ZS5pZH19KSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBzdGFja1Byb3BzPzogY2RrLlN0YWNrUHJvcHMpOiBjZGsuU3RhY2sge1xuICAgICAgICBhc3NlcnQodGhpcy5wcm9wcy5uYW1lLCBcIm5hbWUgZmllbGQgaXMgcmVxdWlyZWQgZm9yIHRoZSBwaXBlbGluZSBzdGFjay4gUGxlYXNlIHByb3ZpZGUgdmFsdWUuXCIpO1xuICAgICAgICBhc3NlcnQodGhpcy5wcm9wcy5zdGFnZXMsIFwiU3RhZ2UgZmllbGQgaXMgcmVxdWlyZWQgZm9yIHRoZSBwaXBlbGluZSBzdGFjay4gUGxlYXNlIHByb3ZpZGUgdmFsdWUuXCIpO1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5yZXBvc2l0b3J5KSB7XG4gICAgICAgICAgICBsZXQgZ2l0SHViUmVwbyA9IHRoaXMucHJvcHMucmVwb3NpdG9yeSBhcyBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuICAgICAgICAgICAgaWYgKCEoaXNDb2RlQ29tbWl0UmVwbyh0aGlzLnByb3BzLnJlcG9zaXRvcnkpKSkge1xuICAgICAgICAgICAgICAgIGFzc2VydCgodGhpcy5wcm9wcy5vd25lciB8fCBnaXRIdWJSZXBvLm93bmVyKSxcbiAgICAgICAgICAgICAgICAgICAgXCJyZXBvc2l0b3J5Lm93bmVyIGZpZWxkIGlzIHJlcXVpcmVkIGZvciB0aGUgR2l0SHViIHBpcGVsaW5lIHN0YWNrLiBQbGVhc2UgcHJvdmlkZSB2YWx1ZS5cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZnVsbFByb3BzID0gdGhpcy5wcm9wcyBhcyBQaXBlbGluZVByb3BzO1xuICAgICAgICByZXR1cm4gbmV3IENvZGVQaXBlbGluZVN0YWNrKHNjb3BlLCBmdWxsUHJvcHMsIGlkLCBzdGFja1Byb3BzKTtcbiAgICB9XG59XG5cblxuLyoqXG4gKiBQaXBlbGluZSBzdGFjayBpcyBnZW5lcmF0aW5nIGEgc2VsZi1tdXRhdGluZyBwaXBlbGluZSB0byBmYWNpbGlhdGUgZnVsbCBDSS9DRCBleHBlcmllbmNlIHdpdGggdGhlIHBsYXRmb3JtXG4gKiBmb3IgaW5mcmFzdHJ1Y3R1cmUgY2hhbmdlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIENvZGVQaXBlbGluZVN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICAgIHN0YXRpYyByZWFkb25seSBVU0FHRV9JRCA9IFwicXMtMXMxcjQ2NWs2XCI7XG4gICAgc3RhdGljIHJlYWRvbmx5IFVTQUdFX0lEX01VTFRJX0FDQ09VTlQgPSBcInFzLTFzMXI0NjVmMlwiO1xuXG4gICAgc3RhdGljIGJ1aWxkZXIoKSB7XG4gICAgICAgIHJldHVybiBuZXcgQ29kZVBpcGVsaW5lQnVpbGRlcigpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIHBpcGVsaW5lUHJvcHM6IFBpcGVsaW5lUHJvcHMsIGlkOiBzdHJpbmcsICBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICAgICAgaWYgKHBpcGVsaW5lUHJvcHMuY3Jvc3NBY2NvdW50S2V5cyl7XG4gICAgICAgICAgICBzdXBlcihzY29wZSwgaWQsIHdpdGhVc2FnZVRyYWNraW5nKENvZGVQaXBlbGluZVN0YWNrLlVTQUdFX0lEX01VTFRJX0FDQ09VTlQsIHByb3BzKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlcihzY29wZSwgaWQsIHdpdGhVc2FnZVRyYWNraW5nKENvZGVQaXBlbGluZVN0YWNrLlVTQUdFX0lELCBwcm9wcykpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBpcGVsaW5lICA9IENvZGVQaXBlbGluZS5idWlsZCh0aGlzLCBwaXBlbGluZVByb3BzKTtcblxuICAgICAgICBsZXQgcHJvbWlzZXMgOiBQcm9taXNlPEFwcGxpY2F0aW9uU3RhZ2U+W10gPSBbXTtcblxuICAgICAgICBmb3IobGV0IHN0YWdlIG9mIHBpcGVsaW5lUHJvcHMuc3RhZ2VzKSB7XG4gICAgICAgICAgICBjb25zdCBhcHBTdGFnZSA9IG5ldyBBcHBsaWNhdGlvblN0YWdlKHRoaXMsIHN0YWdlLmlkLCBzdGFnZS5zdGFja0J1aWxkZXIpO1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChhcHBTdGFnZS53YWl0Rm9yQXN5bmNUYXNrcygpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKHN0YWdlcyA9PiB7XG4gICAgICAgICAgICBsZXQgY3VycmVudFdhdmUgOiBjZGtwaXBlbGluZXMuV2F2ZSB8IHVuZGVmaW5lZDtcblxuICAgICAgICAgICAgZm9yKGxldCBpIGluIHN0YWdlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YWdlID0gcGlwZWxpbmVQcm9wcy5zdGFnZXNbaV07XG4gICAgICAgICAgICAgICAgaWYoc3RhZ2Uud2F2ZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRXYXZlID09IG51bGwgfHwgY3VycmVudFdhdmUuaWQgIT0gc3RhZ2Uud2F2ZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXZlUHJvcHMgPSBwaXBlbGluZVByb3BzLndhdmVzLmZpbmQod2F2ZSA9PiB3YXZlLmlkID09PSBzdGFnZS53YXZlSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KHdhdmVQcm9wcywgYFNwZWNpZmllZCB3YXZlICR7c3RhZ2Uud2F2ZUlkfSBpcyBub3QgZm91bmQgaW4gdGhlIHBpcGVsaW5lIGRlZmluaXRpb24gJHtpZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRXYXZlID0gcGlwZWxpbmUuYWRkV2F2ZShzdGFnZS53YXZlSWQsIHsgLi4ud2F2ZVByb3BzLnByb3BzIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRXYXZlLmFkZFN0YWdlKHN0YWdlc1tpXSwgc3RhZ2Uuc3RhZ2VQcm9wcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwaXBlbGluZS5hZGRTdGFnZShzdGFnZXNbaV0sIHN0YWdlLnN0YWdlUHJvcHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5cbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblN0YWdlIGV4dGVuZHMgY2RrLlN0YWdlIHtcblxuICAgIHByaXZhdGUgYXN5bmNUYXNrOiBQcm9taXNlPGFueT47XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLlN0YWNrLCBpZDogc3RyaW5nLCBidWlsZGVyOiBTdGFja0J1aWxkZXIgfCBBc3luY1N0YWNrQnVpbGRlciwgcHJvcHM/OiBjZGsuU3RhZ2VQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICAgICAgaWYoKDxBc3luY1N0YWNrQnVpbGRlcj5idWlsZGVyKS5idWlsZEFzeW5jICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuYXN5bmNUYXNrID0gKDxBc3luY1N0YWNrQnVpbGRlcj5idWlsZGVyKS5idWlsZEFzeW5jKHRoaXMsIGAke2lkfS1ibHVlcHJpbnRgLCBwcm9wcyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBidWlsZGVyLmJ1aWxkKHRoaXMsIGAke2lkfS1ibHVlcHJpbnRgLCBwcm9wcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgd2FpdEZvckFzeW5jVGFza3MoKSA6IFByb21pc2U8QXBwbGljYXRpb25TdGFnZT4ge1xuICAgICAgICBpZih0aGlzLmFzeW5jVGFzaykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXN5bmNUYXNrLnRoZW4oKCk9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBDb2RlUGlwZWxpbmUgZGVwbG95cyBhIG5ldyBDb2RlUGlwZWxpbmUgcmVzb3VyY2UgdGhhdCBpcyBpbnRlZ3JhdGVkIHdpdGggYSBHaXRIdWIgcmVwb3NpdG9yeS5cbiAqL1xuY2xhc3MgQ29kZVBpcGVsaW5lIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGQoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFBpcGVsaW5lUHJvcHMpIDogY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZSB7XG4gICAgICAgIGxldCBjb2RlUGlwZWxpbmVTb3VyY2UgOiBjZGtwaXBlbGluZXMuQ29kZVBpcGVsaW5lU291cmNlIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIGlmIChpc0NvZGVDb21taXRSZXBvKHByb3BzLnJlcG9zaXRvcnkpKSB7XG4gICAgICAgICAgICBsZXQgY29kZUNvbW1pdFJlcG8gPSBwcm9wcy5yZXBvc2l0b3J5IGFzIENvZGVDb21taXRTb3VyY2VSZXBvc2l0b3J5O1xuICAgICAgICAgICAgY29kZVBpcGVsaW5lU291cmNlID0gY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZVNvdXJjZS5jb2RlQ29tbWl0KFxuICAgICAgICAgICAgICAgIGNvZGVjb21taXQuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeU5hbWUoXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLCAnY2RrLWVrcy1ibHVlcHJpbnRzJywgY29kZUNvbW1pdFJlcG8uY29kZUNvbW1pdFJlcG9OYW1lKSxcbiAgICAgICAgICAgICAgICAgICAgY29kZUNvbW1pdFJlcG8udGFyZ2V0UmV2aXNpb24gPz8gJ21hc3RlcicsXG4gICAgICAgICAgICAgICAgICAgIGNvZGVDb21taXRSZXBvLmNvZGVDb21taXRPcHRpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBnaXRIdWJSZXBvID0gcHJvcHMucmVwb3NpdG9yeSBhcyBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuICAgICAgICAgICAgbGV0IGdpdGh1YlByb3BzIDogY2RrcGlwZWxpbmVzLkdpdEh1YlNvdXJjZU9wdGlvbnMgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCBnaXRIdWJPd25lciA9IGdpdEh1YlJlcG8ub3duZXIgPz8gcHJvcHMub3duZXI7XG5cbiAgICAgICAgICAgIGlmIChnaXRIdWJSZXBvLmNyZWRlbnRpYWxzU2VjcmV0TmFtZSkge1xuICAgICAgICAgICAgICAgIGdpdGh1YlByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICBhdXRoZW50aWNhdGlvbjogY2RrLlNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKGdpdEh1YlJlcG8uY3JlZGVudGlhbHNTZWNyZXROYW1lISlcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29kZVBpcGVsaW5lU291cmNlID0gY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoXG4gICAgICAgICAgICAgICAgYCR7Z2l0SHViT3duZXJ9LyR7Z2l0SHViUmVwby5yZXBvVXJsfWAsXG4gICAgICAgICAgICAgICAgZ2l0SHViUmVwby50YXJnZXRSZXZpc2lvbiA/PyAnbWFpbicsXG4gICAgICAgICAgICAgICAgZ2l0aHViUHJvcHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBjZGtwaXBlbGluZXMuQ29kZVBpcGVsaW5lKHNjb3BlLCBwcm9wcy5uYW1lLCB7XG4gICAgICAgICAgICBwaXBlbGluZU5hbWU6IHByb3BzLm5hbWUsXG4gICAgICAgICAgICBzeW50aDogbmV3IGNka3BpcGVsaW5lcy5TaGVsbFN0ZXAoYCR7cHJvcHMubmFtZX0tc3ludGhgLCB7XG4gICAgICAgICAgICAgIGlucHV0OiBjb2RlUGlwZWxpbmVTb3VyY2UsXG4gICAgICAgICAgICAgIGluc3RhbGxDb21tYW5kczogW1xuICAgICAgICAgICAgICAgICducG0gaW5zdGFsbCAtLWdsb2JhbCBucG0nLFxuICAgICAgICAgICAgICAgICducG0gaW5zdGFsbCAtZyBhd3MtY2RrQDIuMzcuMScsXG4gICAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsJyxcbiAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgY29tbWFuZHM6IFsnbnBtIHJ1biBidWlsZCcsICducHggY2RrIHN5bnRoJ11cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY3Jvc3NBY2NvdW50S2V5czogcHJvcHMuY3Jvc3NBY2NvdW50S2V5cyxcbiAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=