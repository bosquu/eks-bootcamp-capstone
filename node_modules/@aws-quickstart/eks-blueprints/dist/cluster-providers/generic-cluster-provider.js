"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GenericClusterProvider = exports.ClusterBuilder = exports.defaultOptions = exports.GenericClusterPropsConstraints = exports.FargateProfileConstraints = exports.AutoscalingNodeGroupConstraints = exports.ManagedNodeGroupConstraints = exports.clusterBuilder = void 0;
const autoscaling = require("aws-cdk-lib/aws-autoscaling");
const ec2 = require("aws-cdk-lib/aws-ec2");
const eks = require("aws-cdk-lib/aws-eks");
const spi_1 = require("../spi");
const utils = require("../utils");
const constants = require("./constants");
const assert = require("assert");
function clusterBuilder() {
    return new ClusterBuilder();
}
exports.clusterBuilder = clusterBuilder;
class ManagedNodeGroupConstraints {
    constructor() {
        /**
         * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
         * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
         */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
        * of situations of a hard limit request being accepted, and as a result the limit would be raised
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.minSize = new utils.NumberConstraint(0, 2250);
        /**
         * nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.maxSize = new utils.NumberConstraint(0, 2250);
        /**
         * Nodes per node group has a soft limit of 450 nodes, and as little as 0. But we multiply that by a factor of 5 to 2250 in case
         * of situations of a hard limit request being accepted, and as a result the limit would be raised
         * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
         */
        this.desiredSize = new utils.NumberConstraint(0, 2250);
        /**
         * amiReleaseVersion can be no less than 1 character long, and no greater than 1024 characters long.
         * https://docs.aws.amazon.com/imagebuilder/latest/APIReference/API_Ami.html
         */
        this.amiReleaseVersion = new utils.StringConstraint(1, 1024);
    }
}
exports.ManagedNodeGroupConstraints = ManagedNodeGroupConstraints;
class AutoscalingNodeGroupConstraints {
    constructor() {
        /**
        * id can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.id = new utils.StringConstraint(1, 63);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.minSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.maxSize = new utils.NumberConstraint(0, 5000);
        /**
        * Allowed range is 0 to 5000 inclusive.
        * https://kubernetes.io/docs/setup/best-practices/cluster-large/
        */
        this.desiredSize = new utils.NumberConstraint(0, 5000);
    }
}
exports.AutoscalingNodeGroupConstraints = AutoscalingNodeGroupConstraints;
class FargateProfileConstraints {
    constructor() {
        /**
        * fargateProfileNames can be no less than 1 character long, and no greater than 63 characters long due to DNS system limitations.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.fargateProfileName = new utils.StringConstraint(1, 63);
    }
}
exports.FargateProfileConstraints = FargateProfileConstraints;
class GenericClusterPropsConstraints {
    constructor() {
        /**
        * managedNodeGroups per cluster have a soft limit of 30 managed node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 150 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.managedNodeGroups = new utils.ArrayConstraint(0, 150);
        /**
        * autoscalingNodeGroups per cluster have a soft limit of 500 autoscaling node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 2500 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/autoscaling/ec2/userguide/ec2-auto-scaling-quotas.html
        */
        this.autoscalingNodeGroups = new utils.ArrayConstraint(0, 5000);
    }
}
exports.GenericClusterPropsConstraints = GenericClusterPropsConstraints;
exports.defaultOptions = {
    version: eks.KubernetesVersion.V1_21
};
class ClusterBuilder {
    constructor() {
        this.props = {};
        this.privateCluster = false;
        this.managedNodeGroups = [];
        this.autoscalingNodeGroups = [];
        this.fargateProfiles = {};
        this.props = { ...this.props, ...{ version: eks.KubernetesVersion.V1_21 } };
    }
    withCommonOptions(options) {
        this.props = { ...this.props, ...options };
        return this;
    }
    managedNodeGroup(...nodeGroups) {
        this.managedNodeGroups = this.managedNodeGroups.concat(nodeGroups);
        return this;
    }
    autoscalingGroup(...nodeGroups) {
        this.autoscalingNodeGroups = this.autoscalingNodeGroups.concat(nodeGroups);
        return this;
    }
    fargateProfile(name, options) {
        this.fargateProfiles[name] = options;
        return this;
    }
    build() {
        return new GenericClusterProvider({
            ...this.props,
            version: this.props.version,
            privateCluster: this.privateCluster,
            managedNodeGroups: this.managedNodeGroups,
            autoscalingNodeGroups: this.autoscalingNodeGroups,
            fargateProfiles: this.fargateProfiles
        });
    }
}
exports.ClusterBuilder = ClusterBuilder;
/**
 * Cluster provider implementation that supports multiple node groups.
 */
class GenericClusterProvider {
    constructor(props) {
        this.props = props;
        this.validateInput(props);
        assert(!(props.managedNodeGroups && props.managedNodeGroups.length > 0
            && props.autoscalingNodeGroups && props.autoscalingNodeGroups.length > 0), "Mixing managed and autoscaling node groups is not supported. Please file a request on GitHub to add this support if needed.");
    }
    /**
     * @override
     */
    createCluster(scope, vpc) {
        var _a, _b, _c, _d, _e, _f;
        const id = scope.node.id;
        // Props for the cluster.
        const clusterName = (_a = this.props.clusterName) !== null && _a !== void 0 ? _a : id;
        const outputClusterName = true;
        const version = this.props.version;
        const privateCluster = (_b = this.props.privateCluster) !== null && _b !== void 0 ? _b : utils.valueFromContext(scope, constants.PRIVATE_CLUSTER, false);
        const endpointAccess = (privateCluster === true) ? eks.EndpointAccess.PRIVATE : eks.EndpointAccess.PUBLIC_AND_PRIVATE;
        const vpcSubnets = (_c = this.props.vpcSubnets) !== null && _c !== void 0 ? _c : (privateCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_WITH_NAT }] : undefined);
        const defaultOptions = {
            vpc,
            clusterName,
            outputClusterName,
            version,
            vpcSubnets,
            endpointAccess,
            defaultCapacity: 0 // we want to manage capacity ourselves
        };
        const clusterOptions = { ...defaultOptions, ...this.props };
        // Create an EKS Cluster
        const cluster = this.internalCreateCluster(scope, id, clusterOptions);
        cluster.node.addDependency(vpc);
        const nodeGroups = [];
        (_d = this.props.managedNodeGroups) === null || _d === void 0 ? void 0 : _d.forEach(n => {
            const nodeGroup = this.addManagedNodeGroup(cluster, n);
            nodeGroups.push(nodeGroup);
        });
        const autoscalingGroups = [];
        (_e = this.props.autoscalingNodeGroups) === null || _e === void 0 ? void 0 : _e.forEach(n => {
            const autoscalingGroup = this.addAutoScalingGroup(cluster, n);
            autoscalingGroups.push(autoscalingGroup);
        });
        const fargateProfiles = Object.entries((_f = this.props.fargateProfiles) !== null && _f !== void 0 ? _f : {});
        fargateProfiles === null || fargateProfiles === void 0 ? void 0 : fargateProfiles.forEach(([key, options]) => this.addFargateProfile(cluster, key, options));
        return new spi_1.ClusterInfo(cluster, version, nodeGroups, autoscalingGroups);
    }
    /**
     * Template method that may be overridden by subclasses to create a specific cluster flavor (e.g. FargateCluster vs eks.Cluster)
     * @param scope
     * @param id
     * @param clusterOptions
     * @returns
     */
    internalCreateCluster(scope, id, clusterOptions) {
        return new eks.Cluster(scope, id, clusterOptions);
    }
    /**
     * Adds an autoscaling group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addAutoScalingGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g;
        const machineImageType = (_a = nodeGroup.machineImageType) !== null && _a !== void 0 ? _a : eks.MachineImageType.AMAZON_LINUX_2;
        const instanceType = (_b = nodeGroup.instanceType) !== null && _b !== void 0 ? _b : utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const minSize = (_c = nodeGroup.minSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_d = nodeGroup.maxSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_e = nodeGroup.desiredSize) !== null && _e !== void 0 ? _e : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        const updatePolicy = (_f = nodeGroup.updatePolicy) !== null && _f !== void 0 ? _f : autoscaling.UpdatePolicy.rollingUpdate();
        // Create an autoscaling group
        return cluster.addAutoScalingGroupCapacity(nodeGroup.id, {
            ...nodeGroup,
            ...{
                autoScalingGroupName: (_g = nodeGroup.autoScalingGroupName) !== null && _g !== void 0 ? _g : nodeGroup.id,
                machineImageType,
                instanceType,
                minCapacity: minSize,
                maxCapacity: maxSize,
                desiredCapacity: desiredSize,
                updatePolicy,
                vpcSubnets: nodeGroup.nodeGroupSubnets,
            }
        });
    }
    /**
     * Adds a fargate profile to the cluster
     */
    addFargateProfile(cluster, name, profileOptions) {
        cluster.addFargateProfile(name, profileOptions);
    }
    /**
     * Adds a managed node group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addManagedNodeGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g;
        const capacityType = nodeGroup.nodeGroupCapacityType;
        const releaseVersion = nodeGroup.amiReleaseVersion;
        const instanceTypes = (_a = nodeGroup.instanceTypes) !== null && _a !== void 0 ? _a : [utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE)];
        const minSize = (_b = nodeGroup.minSize) !== null && _b !== void 0 ? _b : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_c = nodeGroup.maxSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_d = nodeGroup.desiredSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        // Create a managed node group.
        const nodegroupOptions = {
            ...nodeGroup,
            ...{
                nodegroupName: (_e = nodeGroup.nodegroupName) !== null && _e !== void 0 ? _e : nodeGroup.id,
                capacityType,
                instanceTypes,
                minSize,
                maxSize,
                desiredSize,
                releaseVersion,
                subnets: nodeGroup.nodeGroupSubnets
            }
        };
        if (nodeGroup.customAmi) {
            // Create launch template if custom AMI is provided.
            const lt = new ec2.LaunchTemplate(cluster, `${nodeGroup.id}-lt`, {
                machineImage: (_f = nodeGroup.customAmi) === null || _f === void 0 ? void 0 : _f.machineImage,
                userData: (_g = nodeGroup.customAmi) === null || _g === void 0 ? void 0 : _g.userData,
            });
            utils.setPath(nodegroupOptions, "launchTemplateSpec", {
                id: lt.launchTemplateId,
                version: lt.latestVersionNumber,
            });
            delete nodegroupOptions.amiType;
            delete nodegroupOptions.releaseVersion;
        }
        return cluster.addNodegroupCapacity(nodeGroup.id + "-ng", nodegroupOptions);
    }
    validateInput(props) {
        utils.validateConstraints(new GenericClusterPropsConstraints, GenericClusterProvider.name, props);
        if (props.managedNodeGroups != undefined)
            utils.validateConstraints(new ManagedNodeGroupConstraints, "ManagedNodeGroup", ...props.managedNodeGroups);
        if (props.autoscalingNodeGroups != undefined)
            utils.validateConstraints(new AutoscalingNodeGroupConstraints, "AutoscalingNodeGroups", ...props.autoscalingNodeGroups);
        if (props.fargateProfiles != undefined)
            utils.validateConstraints(new FargateProfileConstraints, "FargateProfiles", ...Object.values(props.fargateProfiles));
    }
}
exports.GenericClusterProvider = GenericClusterProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJpYy1jbHVzdGVyLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsdXN0ZXItcHJvdmlkZXJzL2dlbmVyaWMtY2x1c3Rlci1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyREFBMkQ7QUFDM0QsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUUzQyxnQ0FBc0Q7QUFDdEQsa0NBQWtDO0FBQ2xDLHlDQUF5QztBQUV6QyxpQ0FBa0M7QUFFbEMsU0FBZ0IsY0FBYztJQUMxQixPQUFPLElBQUksY0FBYyxFQUFFLENBQUM7QUFDaEMsQ0FBQztBQUZELHdDQUVDO0FBK0JELE1BQWEsMkJBQTJCO0lBQXhDO1FBQ0k7OztXQUdHO1FBQ0gsT0FBRSxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV2Qzs7OztVQUlFO1FBQ0YsWUFBTyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU5Qzs7OztXQUlHO1FBQ0gsWUFBTyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU5Qzs7OztXQUlHO1FBQ0gsZ0JBQVcsR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFbEQ7OztXQUdHO1FBQ0gsc0JBQWlCLEdBQUcsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7Q0FBQTtBQWpDRCxrRUFpQ0M7QUFFRCxNQUFhLCtCQUErQjtJQUE1QztRQUNJOzs7VUFHRTtRQUNGLE9BQUUsR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFdkM7OztVQUdFO1FBQ0Ys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QUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLG9CQUFvQixFQUFFO2dCQUNsRCxFQUFFLEVBQUUsRUFBRSxDQUFDLGdCQUFpQjtnQkFDeEIsT0FBTyxFQUFFLEVBQUUsQ0FBQyxtQkFBbUI7YUFDbEMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUM7WUFDaEMsT0FBTyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUM7U0FDMUM7UUFFRCxPQUFPLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxHQUFHLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7SUFFTyxhQUFhLENBQUMsS0FBa0M7UUFFcEQsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksOEJBQThCLEVBQUUsc0JBQXNCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xHLElBQUksS0FBSyxDQUFDLGlCQUFpQixJQUFJLFNBQVM7WUFDcEMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksMkJBQTJCLEVBQUUsa0JBQWtCLEVBQUUsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMvRyxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsSUFBSSxTQUFTO1lBQ3hDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLCtCQUErQixFQUFFLHVCQUF1QixFQUFFLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDNUgsSUFBSSxLQUFLLENBQUMsZUFBc0IsSUFBSSxTQUFTO1lBQ3pDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLHlCQUF5QixFQUFFLGlCQUFpQixFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBc0IsQ0FBQyxDQUFDLENBQUM7SUFDcEksQ0FBQztDQUNKO0FBbktELHdEQW1LQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGF1dG9zY2FsaW5nIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hdXRvc2NhbGluZyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lYzJcIjtcbmltcG9ydCAqIGFzIGVrcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBDbHVzdGVyUHJvdmlkZXIgfSBmcm9tIFwiLi4vc3BpXCI7XG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tIFwiLi4vdXRpbHNcIjtcbmltcG9ydCAqIGFzIGNvbnN0YW50cyBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBBdXRvc2NhbGluZ05vZGVHcm91cCwgTWFuYWdlZE5vZGVHcm91cCB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgYXNzZXJ0ID0gcmVxdWlyZSgnYXNzZXJ0Jyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjbHVzdGVyQnVpbGRlcigpIHtcbiAgICByZXR1cm4gbmV3IENsdXN0ZXJCdWlsZGVyKCk7XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgdGhlIGdlbmVyaWMgY2x1c3RlciBwcm92aWRlciwgY29udGFpbmluZyBkZWZpbml0aW9ucyBvZiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLCBcbiAqIGF1dG8tc2NhbGluZyBncm91cHMsIGZhcmdhdGUgcHJvZmlsZXMuIFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJQcm9wcyBleHRlbmRzIGVrcy5DbHVzdGVyT3B0aW9ucyB7XG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIEFQSSBzZXJ2ZXIgaXMgcHJpdmF0ZS5cbiAgICAgKi9cbiAgICBwcml2YXRlQ2x1c3Rlcj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBBcnJheSBvZiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLlxuICAgICAqL1xuICAgIG1hbmFnZWROb2RlR3JvdXBzPzogTWFuYWdlZE5vZGVHcm91cFtdO1xuXG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMuXG4gICAgICovXG4gICAgYXV0b3NjYWxpbmdOb2RlR3JvdXBzPzogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXTtcblxuICAgIC8qKlxuICAgICAqIEZhcmdhdGUgcHJvZmlsZXNcbiAgICAgKi9cbiAgICBmYXJnYXRlUHJvZmlsZXM/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnM7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzIGltcGxlbWVudHMgdXRpbHMuQ29uc3RyYWludHNUeXBlPE1hbmFnZWROb2RlR3JvdXA+IHtcbiAgICAvKipcbiAgICAgKiBpZCBjYW4gYmUgbm8gbGVzcyB0aGFuIDEgY2hhcmFjdGVyIGxvbmcsIGFuZCBubyBncmVhdGVyIHRoYW4gNjMgY2hhcmFjdGVycyBsb25nIGR1ZSB0byBETlMgc3lzdGVtIGxpbWl0YXRpb25zLlxuICAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICAqL1xuICAgIGlkID0gbmV3IHV0aWxzLlN0cmluZ0NvbnN0cmFpbnQoMSwgNjMpO1xuXG4gICAgLyoqXG4gICAgKiBub2RlcyBwZXIgbm9kZSBncm91cCBoYXMgYSBzb2Z0IGxpbWl0IG9mIDQ1MCBub2RlcywgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdCBieSBhIGZhY3RvciBvZiA1IHRvIDIyNTAgaW4gY2FzZSBcbiAgICAqIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkXG4gICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vZWtzL2xhdGVzdC91c2VyZ3VpZGUvc2VydmljZS1xdW90YXMuaHRtbFxuICAgICovXG4gICAgbWluU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDIyNTApO1xuXG4gICAgLyoqXG4gICAgICogbm9kZXMgcGVyIG5vZGUgZ3JvdXAgaGFzIGEgc29mdCBsaW1pdCBvZiA0NTAgbm9kZXMsIGFuZCBhcyBsaXR0bGUgYXMgMC4gQnV0IHdlIG11bHRpcGx5IHRoYXQgYnkgYSBmYWN0b3Igb2YgNSB0byAyMjUwIGluIGNhc2UgXG4gICAgICogb2Ygc2l0dWF0aW9ucyBvZiBhIGhhcmQgbGltaXQgcmVxdWVzdCBiZWluZyBhY2NlcHRlZCwgYW5kIGFzIGEgcmVzdWx0IHRoZSBsaW1pdCB3b3VsZCBiZSByYWlzZWRcbiAgICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vZWtzL2xhdGVzdC91c2VyZ3VpZGUvc2VydmljZS1xdW90YXMuaHRtbFxuICAgICAqL1xuICAgIG1heFNpemUgPSBuZXcgdXRpbHMuTnVtYmVyQ29uc3RyYWludCgwLCAyMjUwKTtcblxuICAgIC8qKlxuICAgICAqIE5vZGVzIHBlciBub2RlIGdyb3VwIGhhcyBhIHNvZnQgbGltaXQgb2YgNDUwIG5vZGVzLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0IGJ5IGEgZmFjdG9yIG9mIDUgdG8gMjI1MCBpbiBjYXNlIFxuICAgICAqIG9mIHNpdHVhdGlvbnMgb2YgYSBoYXJkIGxpbWl0IHJlcXVlc3QgYmVpbmcgYWNjZXB0ZWQsIGFuZCBhcyBhIHJlc3VsdCB0aGUgbGltaXQgd291bGQgYmUgcmFpc2VkXG4gICAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3NlcnZpY2UtcXVvdGFzLmh0bWxcbiAgICAgKi9cbiAgICBkZXNpcmVkU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDIyNTApO1xuXG4gICAgLyoqXG4gICAgICogYW1pUmVsZWFzZVZlcnNpb24gY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDEwMjQgY2hhcmFjdGVycyBsb25nLlxuICAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9pbWFnZWJ1aWxkZXIvbGF0ZXN0L0FQSVJlZmVyZW5jZS9BUElfQW1pLmh0bWxcbiAgICAgKi9cbiAgICBhbWlSZWxlYXNlVmVyc2lvbiA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDEwMjQpO1xufVxuXG5leHBvcnQgY2xhc3MgQXV0b3NjYWxpbmdOb2RlR3JvdXBDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxBdXRvc2NhbGluZ05vZGVHcm91cD4ge1xuICAgIC8qKlxuICAgICogaWQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZyBkdWUgdG8gRE5TIHN5c3RlbSBsaW1pdGF0aW9ucy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgaWQgPSBuZXcgdXRpbHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBtaW5TaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgNTAwMCk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBtYXhTaXplID0gbmV3IHV0aWxzLk51bWJlckNvbnN0cmFpbnQoMCwgNTAwMCk7XG5cbiAgICAvKipcbiAgICAqIEFsbG93ZWQgcmFuZ2UgaXMgMCB0byA1MDAwIGluY2x1c2l2ZS5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL3NldHVwL2Jlc3QtcHJhY3RpY2VzL2NsdXN0ZXItbGFyZ2UvXG4gICAgKi9cbiAgICBkZXNpcmVkU2l6ZSA9IG5ldyB1dGlscy5OdW1iZXJDb25zdHJhaW50KDAsIDUwMDApO1xufVxuXG5leHBvcnQgY2xhc3MgRmFyZ2F0ZVByb2ZpbGVDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zPiB7XG4gICAgLyoqXG4gICAgKiBmYXJnYXRlUHJvZmlsZU5hbWVzIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcgZHVlIHRvIEROUyBzeXN0ZW0gbGltaXRhdGlvbnMuXG4gICAgKiBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9jb25jZXB0cy9vdmVydmlldy93b3JraW5nLXdpdGgtb2JqZWN0cy9uYW1lcy9cbiAgICAqL1xuICAgIGZhcmdhdGVQcm9maWxlTmFtZSA9IG5ldyB1dGlscy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcbn1cblxuZXhwb3J0IGNsYXNzIEdlbmVyaWNDbHVzdGVyUHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHM+IHtcbiAgICAvKipcbiAgICAqIG1hbmFnZWROb2RlR3JvdXBzIHBlciBjbHVzdGVyIGhhdmUgYSBzb2Z0IGxpbWl0IG9mIDMwIG1hbmFnZWQgbm9kZSBncm91cHMgcGVyIEVLUyBjbHVzdGVyLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0IFxuICAgICogYnkgYSBmYWN0b3Igb2YgNSB0byAxNTAgaW4gY2FzZSBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgKi9cbiAgICBtYW5hZ2VkTm9kZUdyb3VwcyA9IG5ldyB1dGlscy5BcnJheUNvbnN0cmFpbnQoMCwgMTUwKTtcbiAgICAvKipcbiAgICAqIGF1dG9zY2FsaW5nTm9kZUdyb3VwcyBwZXIgY2x1c3RlciBoYXZlIGEgc29mdCBsaW1pdCBvZiA1MDAgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMgcGVyIEVLUyBjbHVzdGVyLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0IFxuICAgICogYnkgYSBmYWN0b3Igb2YgNSB0byAyNTAwIGluIGNhc2Ugb2Ygc2l0dWF0aW9ucyBvZiBhIGhhcmQgbGltaXQgcmVxdWVzdCBiZWluZyBhY2NlcHRlZCwgYW5kIGFzIGEgcmVzdWx0IHRoZSBsaW1pdCB3b3VsZCBiZSByYWlzZWQuXG4gICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYXV0b3NjYWxpbmcvZWMyL3VzZXJndWlkZS9lYzItYXV0by1zY2FsaW5nLXF1b3Rhcy5odG1sXG4gICAgKi9cbiAgICBhdXRvc2NhbGluZ05vZGVHcm91cHMgPSBuZXcgdXRpbHMuQXJyYXlDb25zdHJhaW50KDAsIDUwMDApO1xufVxuXG5leHBvcnQgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uLlYxXzIxXG59O1xuXG5leHBvcnQgY2xhc3MgQ2x1c3RlckJ1aWxkZXIge1xuXG4gICAgcHJpdmF0ZSBwcm9wczogUGFydGlhbDxHZW5lcmljQ2x1c3RlclByb3ZpZGVyUHJvcHM+ID0ge307XG4gICAgcHJpdmF0ZSBwcml2YXRlQ2x1c3RlciA9IGZhbHNlO1xuICAgIHByaXZhdGUgbWFuYWdlZE5vZGVHcm91cHM6IE1hbmFnZWROb2RlR3JvdXBbXSA9IFtdO1xuICAgIHByaXZhdGUgYXV0b3NjYWxpbmdOb2RlR3JvdXBzOiBBdXRvc2NhbGluZ05vZGVHcm91cFtdID0gW107XG4gICAgcHJpdmF0ZSBmYXJnYXRlUHJvZmlsZXM6IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucztcbiAgICB9ID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyB2ZXJzaW9uOiBla3MuS3ViZXJuZXRlc1ZlcnNpb24uVjFfMjEgfSB9O1xuICAgIH1cblxuICAgIHdpdGhDb21tb25PcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8ZWtzLkNsdXN0ZXJPcHRpb25zPik6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi5vcHRpb25zIH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIG1hbmFnZWROb2RlR3JvdXAoLi4ubm9kZUdyb3VwczogTWFuYWdlZE5vZGVHcm91cFtdKTogdGhpcyB7XG4gICAgICAgIHRoaXMubWFuYWdlZE5vZGVHcm91cHMgPSB0aGlzLm1hbmFnZWROb2RlR3JvdXBzLmNvbmNhdChub2RlR3JvdXBzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYXV0b3NjYWxpbmdHcm91cCguLi5ub2RlR3JvdXBzOiBBdXRvc2NhbGluZ05vZGVHcm91cFtdKTogdGhpcyB7XG4gICAgICAgIHRoaXMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzID0gdGhpcy5hdXRvc2NhbGluZ05vZGVHcm91cHMuY29uY2F0KG5vZGVHcm91cHMpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmYXJnYXRlUHJvZmlsZShuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnMpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5mYXJnYXRlUHJvZmlsZXNbbmFtZV0gPSBvcHRpb25zO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmljQ2x1c3RlclByb3ZpZGVyKHtcbiAgICAgICAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICAgICAgICB2ZXJzaW9uOiB0aGlzLnByb3BzLnZlcnNpb24hLFxuICAgICAgICAgICAgcHJpdmF0ZUNsdXN0ZXI6IHRoaXMucHJpdmF0ZUNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5hZ2VkTm9kZUdyb3VwczogdGhpcy5tYW5hZ2VkTm9kZUdyb3VwcyxcbiAgICAgICAgICAgIGF1dG9zY2FsaW5nTm9kZUdyb3VwczogdGhpcy5hdXRvc2NhbGluZ05vZGVHcm91cHMsXG4gICAgICAgICAgICBmYXJnYXRlUHJvZmlsZXM6IHRoaXMuZmFyZ2F0ZVByb2ZpbGVzXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBDbHVzdGVyIHByb3ZpZGVyIGltcGxlbWVudGF0aW9uIHRoYXQgc3VwcG9ydHMgbXVsdGlwbGUgbm9kZSBncm91cHMuIFxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJpY0NsdXN0ZXJQcm92aWRlciBpbXBsZW1lbnRzIENsdXN0ZXJQcm92aWRlciB7XG5cbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSBwcm9wczogR2VuZXJpY0NsdXN0ZXJQcm92aWRlclByb3BzKSB7XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUlucHV0KHByb3BzKTtcblxuICAgICAgICBhc3NlcnQoIShwcm9wcy5tYW5hZ2VkTm9kZUdyb3VwcyAmJiBwcm9wcy5tYW5hZ2VkTm9kZUdyb3Vwcy5sZW5ndGggPiAwXG4gICAgICAgICAgICAmJiBwcm9wcy5hdXRvc2NhbGluZ05vZGVHcm91cHMgJiYgcHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzLmxlbmd0aCA+IDApLFxuICAgICAgICAgICAgXCJNaXhpbmcgbWFuYWdlZCBhbmQgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIGZpbGUgYSByZXF1ZXN0IG9uIEdpdEh1YiB0byBhZGQgdGhpcyBzdXBwb3J0IGlmIG5lZWRlZC5cIik7XG4gICAgfVxuXG4gICAgLyoqIFxuICAgICAqIEBvdmVycmlkZSBcbiAgICAgKi9cbiAgICBjcmVhdGVDbHVzdGVyKHNjb3BlOiBDb25zdHJ1Y3QsIHZwYzogZWMyLklWcGMpOiBDbHVzdGVySW5mbyB7XG4gICAgICAgIGNvbnN0IGlkID0gc2NvcGUubm9kZS5pZDtcblxuICAgICAgICAvLyBQcm9wcyBmb3IgdGhlIGNsdXN0ZXIuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJOYW1lID0gdGhpcy5wcm9wcy5jbHVzdGVyTmFtZSA/PyBpZDtcbiAgICAgICAgY29uc3Qgb3V0cHV0Q2x1c3Rlck5hbWUgPSB0cnVlO1xuICAgICAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5wcm9wcy52ZXJzaW9uO1xuICAgICAgICBjb25zdCBwcml2YXRlQ2x1c3RlciA9IHRoaXMucHJvcHMucHJpdmF0ZUNsdXN0ZXIgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChzY29wZSwgY29uc3RhbnRzLlBSSVZBVEVfQ0xVU1RFUiwgZmFsc2UpO1xuICAgICAgICBjb25zdCBlbmRwb2ludEFjY2VzcyA9IChwcml2YXRlQ2x1c3RlciA9PT0gdHJ1ZSkgPyBla3MuRW5kcG9pbnRBY2Nlc3MuUFJJVkFURSA6IGVrcy5FbmRwb2ludEFjY2Vzcy5QVUJMSUNfQU5EX1BSSVZBVEU7XG4gICAgICAgIGNvbnN0IHZwY1N1Ym5ldHMgPSB0aGlzLnByb3BzLnZwY1N1Ym5ldHMgPz8gKHByaXZhdGVDbHVzdGVyID09PSB0cnVlID8gW3sgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX05BVCB9XSA6IHVuZGVmaW5lZCk7XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICB2cGMsXG4gICAgICAgICAgICBjbHVzdGVyTmFtZSxcbiAgICAgICAgICAgIG91dHB1dENsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgdmVyc2lvbixcbiAgICAgICAgICAgIHZwY1N1Ym5ldHMsXG4gICAgICAgICAgICBlbmRwb2ludEFjY2VzcyxcbiAgICAgICAgICAgIGRlZmF1bHRDYXBhY2l0eTogMCAvLyB3ZSB3YW50IHRvIG1hbmFnZSBjYXBhY2l0eSBvdXJzZWx2ZXNcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBjbHVzdGVyT3B0aW9ucyA9IHsgLi4uZGVmYXVsdE9wdGlvbnMsIC4uLnRoaXMucHJvcHMgfTtcbiAgICAgICAgLy8gQ3JlYXRlIGFuIEVLUyBDbHVzdGVyXG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSB0aGlzLmludGVybmFsQ3JlYXRlQ2x1c3RlcihzY29wZSwgaWQsIGNsdXN0ZXJPcHRpb25zKTtcbiAgICAgICAgY2x1c3Rlci5ub2RlLmFkZERlcGVuZGVuY3kodnBjKTtcblxuICAgICAgICBjb25zdCBub2RlR3JvdXBzOiBla3MuTm9kZWdyb3VwW10gPSBbXTtcblxuICAgICAgICB0aGlzLnByb3BzLm1hbmFnZWROb2RlR3JvdXBzPy5mb3JFYWNoKG4gPT4ge1xuICAgICAgICAgICAgY29uc3Qgbm9kZUdyb3VwID0gdGhpcy5hZGRNYW5hZ2VkTm9kZUdyb3VwKGNsdXN0ZXIsIG4pO1xuICAgICAgICAgICAgbm9kZUdyb3Vwcy5wdXNoKG5vZGVHcm91cCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGF1dG9zY2FsaW5nR3JvdXBzOiBhdXRvc2NhbGluZy5BdXRvU2NhbGluZ0dyb3VwW10gPSBbXTtcbiAgICAgICAgdGhpcy5wcm9wcy5hdXRvc2NhbGluZ05vZGVHcm91cHM/LmZvckVhY2gobiA9PiB7XG4gICAgICAgICAgICBjb25zdCBhdXRvc2NhbGluZ0dyb3VwID0gdGhpcy5hZGRBdXRvU2NhbGluZ0dyb3VwKGNsdXN0ZXIsIG4pO1xuICAgICAgICAgICAgYXV0b3NjYWxpbmdHcm91cHMucHVzaChhdXRvc2NhbGluZ0dyb3VwKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZmFyZ2F0ZVByb2ZpbGVzID0gT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5mYXJnYXRlUHJvZmlsZXMgPz8ge30pO1xuICAgICAgICBmYXJnYXRlUHJvZmlsZXM/LmZvckVhY2goKFtrZXksIG9wdGlvbnNdKSA9PiB0aGlzLmFkZEZhcmdhdGVQcm9maWxlKGNsdXN0ZXIsIGtleSwgb3B0aW9ucykpO1xuXG4gICAgICAgIHJldHVybiBuZXcgQ2x1c3RlckluZm8oY2x1c3RlciwgdmVyc2lvbiwgbm9kZUdyb3VwcywgYXV0b3NjYWxpbmdHcm91cHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlbXBsYXRlIG1ldGhvZCB0aGF0IG1heSBiZSBvdmVycmlkZGVuIGJ5IHN1YmNsYXNzZXMgdG8gY3JlYXRlIGEgc3BlY2lmaWMgY2x1c3RlciBmbGF2b3IgKGUuZy4gRmFyZ2F0ZUNsdXN0ZXIgdnMgZWtzLkNsdXN0ZXIpXG4gICAgICogQHBhcmFtIHNjb3BlIFxuICAgICAqIEBwYXJhbSBpZCBcbiAgICAgKiBAcGFyYW0gY2x1c3Rlck9wdGlvbnMgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGludGVybmFsQ3JlYXRlQ2x1c3RlcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBjbHVzdGVyT3B0aW9uczogYW55KTogZWtzLkNsdXN0ZXIge1xuICAgICAgICByZXR1cm4gbmV3IGVrcy5DbHVzdGVyKHNjb3BlLCBpZCwgY2x1c3Rlck9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYW4gYXV0b3NjYWxpbmcgZ3JvdXAgdG8gdGhlIGNsdXN0ZXIuXG4gICAgICogQHBhcmFtIGNsdXN0ZXIgXG4gICAgICogQHBhcmFtIG5vZGVHcm91cCBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBhZGRBdXRvU2NhbGluZ0dyb3VwKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBub2RlR3JvdXA6IEF1dG9zY2FsaW5nTm9kZUdyb3VwKTogYXV0b3NjYWxpbmcuQXV0b1NjYWxpbmdHcm91cCB7XG4gICAgICAgIGNvbnN0IG1hY2hpbmVJbWFnZVR5cGUgPSBub2RlR3JvdXAubWFjaGluZUltYWdlVHlwZSA/PyBla3MuTWFjaGluZUltYWdlVHlwZS5BTUFaT05fTElOVVhfMjtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlID0gbm9kZUdyb3VwLmluc3RhbmNlVHlwZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5JTlNUQU5DRV9UWVBFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfSU5TVEFOQ0VfVFlQRSk7XG4gICAgICAgIGNvbnN0IG1pblNpemUgPSBub2RlR3JvdXAubWluU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NSU5fU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01JTlNJWkUpO1xuICAgICAgICBjb25zdCBtYXhTaXplID0gbm9kZUdyb3VwLm1heFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuTUFYX1NJWkVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9OR19NQVhTSVpFKTtcbiAgICAgICAgY29uc3QgZGVzaXJlZFNpemUgPSBub2RlR3JvdXAuZGVzaXJlZFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuREVTSVJFRF9TSVpFX0tFWSwgbWluU2l6ZSk7XG4gICAgICAgIGNvbnN0IHVwZGF0ZVBvbGljeSA9IG5vZGVHcm91cC51cGRhdGVQb2xpY3kgPz8gYXV0b3NjYWxpbmcuVXBkYXRlUG9saWN5LnJvbGxpbmdVcGRhdGUoKTtcblxuICAgICAgICAvLyBDcmVhdGUgYW4gYXV0b3NjYWxpbmcgZ3JvdXBcbiAgICAgICAgcmV0dXJuIGNsdXN0ZXIuYWRkQXV0b1NjYWxpbmdHcm91cENhcGFjaXR5KG5vZGVHcm91cC5pZCwge1xuICAgICAgICAgICAgLi4ubm9kZUdyb3VwLFxuICAgICAgICAgICAgLi4uIHtcbiAgICAgICAgICAgICAgICBhdXRvU2NhbGluZ0dyb3VwTmFtZTogbm9kZUdyb3VwLmF1dG9TY2FsaW5nR3JvdXBOYW1lID8/IG5vZGVHcm91cC5pZCxcbiAgICAgICAgICAgICAgICBtYWNoaW5lSW1hZ2VUeXBlLFxuICAgICAgICAgICAgICAgIGluc3RhbmNlVHlwZSxcbiAgICAgICAgICAgICAgICBtaW5DYXBhY2l0eTogbWluU2l6ZSxcbiAgICAgICAgICAgICAgICBtYXhDYXBhY2l0eTogbWF4U2l6ZSxcbiAgICAgICAgICAgICAgICBkZXNpcmVkQ2FwYWNpdHk6IGRlc2lyZWRTaXplLFxuICAgICAgICAgICAgICAgIHVwZGF0ZVBvbGljeSxcbiAgICAgICAgICAgICAgICB2cGNTdWJuZXRzOiBub2RlR3JvdXAubm9kZUdyb3VwU3VibmV0cyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGZhcmdhdGUgcHJvZmlsZSB0byB0aGUgY2x1c3RlclxuICAgICAqL1xuICAgIGFkZEZhcmdhdGVQcm9maWxlKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBuYW1lOiBzdHJpbmcsIHByb2ZpbGVPcHRpb25zOiBla3MuRmFyZ2F0ZVByb2ZpbGVPcHRpb25zKSB7XG4gICAgICAgIGNsdXN0ZXIuYWRkRmFyZ2F0ZVByb2ZpbGUobmFtZSwgcHJvZmlsZU9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBtYW5hZ2VkIG5vZGUgZ3JvdXAgdG8gdGhlIGNsdXN0ZXIuXG4gICAgICogQHBhcmFtIGNsdXN0ZXIgXG4gICAgICogQHBhcmFtIG5vZGVHcm91cCBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBhZGRNYW5hZ2VkTm9kZUdyb3VwKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBub2RlR3JvdXA6IE1hbmFnZWROb2RlR3JvdXApOiBla3MuTm9kZWdyb3VwIHtcbiAgICAgICAgY29uc3QgY2FwYWNpdHlUeXBlID0gbm9kZUdyb3VwLm5vZGVHcm91cENhcGFjaXR5VHlwZTtcbiAgICAgICAgY29uc3QgcmVsZWFzZVZlcnNpb24gPSBub2RlR3JvdXAuYW1pUmVsZWFzZVZlcnNpb247XG4gICAgICAgIGNvbnN0IGluc3RhbmNlVHlwZXMgPSBub2RlR3JvdXAuaW5zdGFuY2VUeXBlcyA/PyBbdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuSU5TVEFOQ0VfVFlQRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX0lOU1RBTkNFX1RZUEUpXTtcbiAgICAgICAgY29uc3QgbWluU2l6ZSA9IG5vZGVHcm91cC5taW5TaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLk1JTl9TSVpFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfTkdfTUlOU0laRSk7XG4gICAgICAgIGNvbnN0IG1heFNpemUgPSBub2RlR3JvdXAubWF4U2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NQVhfU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01BWFNJWkUpO1xuICAgICAgICBjb25zdCBkZXNpcmVkU2l6ZSA9IG5vZGVHcm91cC5kZXNpcmVkU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5ERVNJUkVEX1NJWkVfS0VZLCBtaW5TaXplKTtcblxuICAgICAgICAvLyBDcmVhdGUgYSBtYW5hZ2VkIG5vZGUgZ3JvdXAuXG4gICAgICAgIGNvbnN0IG5vZGVncm91cE9wdGlvbnM6IHV0aWxzLldyaXRlYWJsZTxla3MuTm9kZWdyb3VwT3B0aW9ucz4gPSB7XG4gICAgICAgICAgICAuLi5ub2RlR3JvdXAsXG4gICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgbm9kZWdyb3VwTmFtZTogbm9kZUdyb3VwLm5vZGVncm91cE5hbWUgPz8gbm9kZUdyb3VwLmlkLFxuICAgICAgICAgICAgICAgIGNhcGFjaXR5VHlwZSxcbiAgICAgICAgICAgICAgICBpbnN0YW5jZVR5cGVzLFxuICAgICAgICAgICAgICAgIG1pblNpemUsXG4gICAgICAgICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICAgICAgICBkZXNpcmVkU2l6ZSxcbiAgICAgICAgICAgICAgICByZWxlYXNlVmVyc2lvbixcbiAgICAgICAgICAgICAgICBzdWJuZXRzOiBub2RlR3JvdXAubm9kZUdyb3VwU3VibmV0c1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChub2RlR3JvdXAuY3VzdG9tQW1pKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgbGF1bmNoIHRlbXBsYXRlIGlmIGN1c3RvbSBBTUkgaXMgcHJvdmlkZWQuXG4gICAgICAgICAgICBjb25zdCBsdCA9IG5ldyBlYzIuTGF1bmNoVGVtcGxhdGUoY2x1c3RlciwgYCR7bm9kZUdyb3VwLmlkfS1sdGAsIHtcbiAgICAgICAgICAgICAgICBtYWNoaW5lSW1hZ2U6IG5vZGVHcm91cC5jdXN0b21BbWk/Lm1hY2hpbmVJbWFnZSxcbiAgICAgICAgICAgICAgICB1c2VyRGF0YTogbm9kZUdyb3VwLmN1c3RvbUFtaT8udXNlckRhdGEsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHV0aWxzLnNldFBhdGgobm9kZWdyb3VwT3B0aW9ucywgXCJsYXVuY2hUZW1wbGF0ZVNwZWNcIiwge1xuICAgICAgICAgICAgICAgIGlkOiBsdC5sYXVuY2hUZW1wbGF0ZUlkISxcbiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBsdC5sYXRlc3RWZXJzaW9uTnVtYmVyLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkZWxldGUgbm9kZWdyb3VwT3B0aW9ucy5hbWlUeXBlO1xuICAgICAgICAgICAgZGVsZXRlIG5vZGVncm91cE9wdGlvbnMucmVsZWFzZVZlcnNpb247XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2x1c3Rlci5hZGROb2RlZ3JvdXBDYXBhY2l0eShub2RlR3JvdXAuaWQgKyBcIi1uZ1wiLCBub2RlZ3JvdXBPcHRpb25zKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHZhbGlkYXRlSW5wdXQocHJvcHM6IEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJQcm9wcykge1xuICAgICAgICBcbiAgICAgICAgdXRpbHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgR2VuZXJpY0NsdXN0ZXJQcm9wc0NvbnN0cmFpbnRzLCBHZW5lcmljQ2x1c3RlclByb3ZpZGVyLm5hbWUsIHByb3BzKTtcbiAgICAgICAgaWYgKHByb3BzLm1hbmFnZWROb2RlR3JvdXBzICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IE1hbmFnZWROb2RlR3JvdXBDb25zdHJhaW50cywgXCJNYW5hZ2VkTm9kZUdyb3VwXCIsIC4uLnByb3BzLm1hbmFnZWROb2RlR3JvdXBzKTtcbiAgICAgICAgaWYgKHByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3VwcyAhPSB1bmRlZmluZWQpXG4gICAgICAgICAgICB1dGlscy52YWxpZGF0ZUNvbnN0cmFpbnRzKG5ldyBBdXRvc2NhbGluZ05vZGVHcm91cENvbnN0cmFpbnRzLCBcIkF1dG9zY2FsaW5nTm9kZUdyb3Vwc1wiLCAuLi5wcm9wcy5hdXRvc2NhbGluZ05vZGVHcm91cHMpO1xuICAgICAgICBpZiAocHJvcHMuZmFyZ2F0ZVByb2ZpbGVzIGFzIGFueSAhPSB1bmRlZmluZWQpXG4gICAgICAgICAgICB1dGlscy52YWxpZGF0ZUNvbnN0cmFpbnRzKG5ldyBGYXJnYXRlUHJvZmlsZUNvbnN0cmFpbnRzLCBcIkZhcmdhdGVQcm9maWxlc1wiLCAuLi5PYmplY3QudmFsdWVzKHByb3BzLmZhcmdhdGVQcm9maWxlcyBhcyBhbnkpKTtcbiAgICB9XG59Il19