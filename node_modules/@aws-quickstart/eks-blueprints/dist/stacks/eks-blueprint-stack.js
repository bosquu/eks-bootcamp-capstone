"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EksBlueprint = exports.BlueprintBuilder = exports.BlueprintPropsConstraints = exports.EksBlueprintProps = void 0;
const cdk = require("aws-cdk-lib");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const utils_1 = require("../utils");
const mng_cluster_provider_1 = require("../cluster-providers/mng-cluster-provider");
const vpc_1 = require("../resource-providers/vpc");
const spi = require("../spi");
const utils_2 = require("../utils");
const utils_3 = require("../utils");
class EksBlueprintProps {
    constructor() {
        /**
         * Add-ons if any.
         */
        this.addOns = [];
        /**
         * Teams if any
         */
        this.teams = [];
        /**
         * EC2 or Fargate are supported in the blueprint but any implementation conforming the interface
         * will work
         */
        this.clusterProvider = new mng_cluster_provider_1.MngClusterProvider();
        /**
         * Kubernetes version (must be initialized for addons to work properly)
         */
        this.version = aws_eks_1.KubernetesVersion.V1_21;
        /**
         * Named resource providers to leverage for cluster resources.
         * The resource can represent Vpc, Hosting Zones or other resources, see {@link spi.ResourceType}.
         * VPC for the cluster can be registered under the name of 'vpc' or as a single provider of type
         */
        this.resourceProviders = new Map();
    }
}
exports.EksBlueprintProps = EksBlueprintProps;
class BlueprintPropsConstraints {
    constructor() {
        /**
        * id can be no less than 1 character long, and no greater than 63 characters long.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.id = new utils_3.StringConstraint(1, 63);
        /**
        * name can be no less than 1 character long, and no greater than 63 characters long.
        * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
        */
        this.name = new utils_3.StringConstraint(1, 63);
    }
}
exports.BlueprintPropsConstraints = BlueprintPropsConstraints;
/**
 * Blueprint builder implements a builder pattern that improves readability (no bloated constructors)
 * and allows creating a blueprint in an abstract state that can be applied to various instantiations
 * in accounts and regions.
 */
class BlueprintBuilder {
    constructor() {
        this.props = { addOns: new Array(), teams: new Array(), resourceProviders: new Map() };
        this.env = {
            account: process.env.CDK_DEFAULT_ACCOUNT,
            region: process.env.CDK_DEFAULT_REGION
        };
    }
    name(name) {
        this.props = { ...this.props, ...{ name } };
        return this;
    }
    account(account) {
        this.env.account = account;
        return this;
    }
    region(region) {
        this.env.region = region;
        return this;
    }
    version(version) {
        this.props = { ...this.props, ...{ version } };
        return this;
    }
    enableControlPlaneLogTypes(...types) {
        this.props = { ...this.props, ...{ enableControlPlaneLogTypes: types } };
        return this;
    }
    withBlueprintProps(props) {
        const resourceProviders = this.props.resourceProviders;
        this.props = { ...this.props, ...(0, utils_1.cloneDeep)(props) };
        if (props.resourceProviders) {
            this.props.resourceProviders = new Map([...resourceProviders.entries(), ...props.resourceProviders.entries()]);
        }
        return this;
    }
    addOns(...addOns) {
        var _a;
        this.props = { ...this.props, ...{ addOns: (_a = this.props.addOns) === null || _a === void 0 ? void 0 : _a.concat(addOns) } };
        return this;
    }
    clusterProvider(clusterProvider) {
        this.props = { ...this.props, ...{ clusterProvider: clusterProvider } };
        return this;
    }
    id(id) {
        this.props = { ...this.props, ...{ id } };
        return this;
    }
    teams(...teams) {
        var _a;
        this.props = { ...this.props, ...{ teams: (_a = this.props.teams) === null || _a === void 0 ? void 0 : _a.concat(teams) } };
        return this;
    }
    resourceProvider(name, provider) {
        var _a;
        (_a = this.props.resourceProviders) === null || _a === void 0 ? void 0 : _a.set(name, provider);
        return this;
    }
    clone(region, account) {
        return new BlueprintBuilder().withBlueprintProps({ ...this.props })
            .account(account !== null && account !== void 0 ? account : this.env.account).region(region !== null && region !== void 0 ? region : this.env.region);
    }
    build(scope, id, stackProps) {
        return new EksBlueprint(scope, { ...this.props, ...{ id } }, { ...{ env: this.env }, ...stackProps });
    }
    async buildAsync(scope, id, stackProps) {
        return this.build(scope, id, stackProps).waitForAsyncTasks();
    }
}
exports.BlueprintBuilder = BlueprintBuilder;
/**
 * Entry point to the platform provisioning. Creates a CFN stack based on the provided configuration
 * and orchestrates provisioning of add-ons, teams and post deployment hooks.
 */
class EksBlueprint extends cdk.Stack {
    constructor(scope, blueprintProps, props) {
        var _a, _b, _c, _d;
        super(scope, blueprintProps.id, (0, utils_2.withUsageTracking)(EksBlueprint.USAGE_ID, props));
        this.validateInput(blueprintProps);
        const resourceContext = this.provideNamedResources(blueprintProps);
        let vpcResource = resourceContext.get(spi.GlobalResources.Vpc);
        if (!vpcResource) {
            vpcResource = resourceContext.add(spi.GlobalResources.Vpc, new vpc_1.VpcProvider());
        }
        const version = (_a = blueprintProps.version) !== null && _a !== void 0 ? _a : aws_eks_1.KubernetesVersion.V1_21;
        const clusterProvider = (_b = blueprintProps.clusterProvider) !== null && _b !== void 0 ? _b : new mng_cluster_provider_1.MngClusterProvider({
            id: `${(_c = blueprintProps.name) !== null && _c !== void 0 ? _c : blueprintProps.id}-ng`,
            version
        });
        this.clusterInfo = clusterProvider.createCluster(this, vpcResource);
        this.clusterInfo.setResourceContext(resourceContext);
        let enableLogTypes = blueprintProps.enableControlPlaneLogTypes;
        if (enableLogTypes) {
            (0, utils_2.setupClusterLogging)(this.clusterInfo.cluster.stack, this.clusterInfo.cluster, enableLogTypes);
        }
        const postDeploymentSteps = Array();
        for (let addOn of ((_d = blueprintProps.addOns) !== null && _d !== void 0 ? _d : [])) { // must iterate in the strict order
            const result = addOn.deploy(this.clusterInfo);
            if (result) {
                const addOnKey = (0, utils_2.getAddOnNameOrId)(addOn);
                this.clusterInfo.addScheduledAddOn(addOnKey, result);
            }
            const postDeploy = addOn;
            if (postDeploy.postDeploy !== undefined) {
                postDeploymentSteps.push(postDeploy);
            }
        }
        const scheduledAddOns = this.clusterInfo.getAllScheduledAddons();
        const addOnKeys = [...scheduledAddOns.keys()];
        const promises = scheduledAddOns.values();
        this.asyncTasks = Promise.all(promises).then((constructs) => {
            var _a;
            constructs.forEach((construct, index) => {
                this.clusterInfo.addProvisionedAddOn(addOnKeys[index], construct);
            });
            if (blueprintProps.teams != null) {
                for (let team of blueprintProps.teams) {
                    team.setup(this.clusterInfo);
                }
            }
            for (let step of postDeploymentSteps) {
                step.postDeploy(this.clusterInfo, (_a = blueprintProps.teams) !== null && _a !== void 0 ? _a : []);
            }
        });
        this.asyncTasks.catch(err => {
            console.error(err);
            throw new Error(err);
        });
    }
    static builder() {
        return new BlueprintBuilder();
    }
    /**
     * Since constructor cannot be marked as async, adding a separate method to wait
     * for async code to finish.
     * @returns Promise that resolves to the blueprint
     */
    async waitForAsyncTasks() {
        if (this.asyncTasks) {
            return this.asyncTasks.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
    /**
     * This method returns all the constructs produced by during the cluster creation (e.g. add-ons).
     * May be used in testing for verification.
     * @returns cluster info object
     */
    getClusterInfo() {
        return this.clusterInfo;
    }
    provideNamedResources(blueprintProps) {
        var _a;
        const result = new spi.ResourceContext(this, blueprintProps);
        for (let [key, value] of (_a = blueprintProps.resourceProviders) !== null && _a !== void 0 ? _a : []) {
            result.add(key, value);
        }
        return result;
    }
    validateInput(blueprintProps) {
        const teamNames = new Set();
        (0, utils_3.validateConstraints)(new BlueprintPropsConstraints, EksBlueprintProps.name, blueprintProps);
        if (blueprintProps.teams) {
            blueprintProps.teams.forEach(e => {
                if (teamNames.has(e.name)) {
                    throw new Error(`Team ${e.name} is registered more than once`);
                }
                teamNames.add(e.name);
            });
        }
    }
}
exports.EksBlueprint = EksBlueprint;
EksBlueprint.USAGE_ID = "qs-1s1r465hk";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWtzLWJsdWVwcmludC1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zdGFja3MvZWtzLWJsdWVwcmludC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFFbkMsaURBQXdEO0FBRXhELG9DQUFzRDtBQUN0RCxvRkFBK0U7QUFDL0UsbURBQXdEO0FBQ3hELDhCQUE4QjtBQUM5QixvQ0FBb0Y7QUFDcEYsb0NBQWlFO0FBRWpFLE1BQWEsaUJBQWlCO0lBQTlCO1FBV0k7O1dBRUc7UUFDTSxXQUFNLEdBQTZCLEVBQUUsQ0FBQztRQUUvQzs7V0FFRztRQUNNLFVBQUssR0FBcUIsRUFBRSxDQUFDO1FBRXRDOzs7V0FHRztRQUNNLG9CQUFlLEdBQXlCLElBQUkseUNBQWtCLEVBQUUsQ0FBQztRQUUxRTs7V0FFRztRQUNNLFlBQU8sR0FBdUIsMkJBQWlCLENBQUMsS0FBSyxDQUFDO1FBRS9EOzs7O1dBSUc7UUFDSCxzQkFBaUIsR0FBdUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQU90RSxDQUFDO0NBQUE7QUE1Q0QsOENBNENDO0FBRUQsTUFBYSx5QkFBeUI7SUFBdEM7UUFDSTs7O1VBR0U7UUFDRixPQUFFLEdBQUcsSUFBSSx3QkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakM7OztVQUdFO1FBQ0YsU0FBSSxHQUFHLElBQUksd0JBQWdCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7Q0FBQTtBQVpELDhEQVlDO0FBV0Q7Ozs7R0FJRztBQUNILE1BQWEsZ0JBQWdCO0lBUXpCO1FBQ0ksSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEtBQUssRUFBb0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLEVBQVksRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDbkgsSUFBSSxDQUFDLEdBQUcsR0FBRztZQUNQLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtZQUN4QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0I7U0FDekMsQ0FBQztJQUNOLENBQUM7SUFFTSxJQUFJLENBQUMsSUFBWTtRQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO1FBQzVDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxPQUFPLENBQUMsT0FBZ0I7UUFDM0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQzNCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxNQUFNLENBQUMsTUFBZTtRQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLE9BQU8sQ0FBQyxPQUEwQjtRQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSwwQkFBMEIsQ0FBQyxHQUFHLEtBQTRCO1FBQzdELElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLDBCQUEwQixFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7UUFDekUsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGtCQUFrQixDQUFDLEtBQWlDO1FBQ3ZELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBa0IsQ0FBQztRQUN4RCxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBQSxpQkFBUyxFQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDcEQsSUFBSSxLQUFLLENBQUMsaUJBQWlCLEVBQUU7WUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsaUJBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ25IO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxHQUFHLE1BQTBCOztRQUN2QyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sMENBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNqRixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sZUFBZSxDQUFDLGVBQW9DO1FBQ3ZELElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsRUFBRSxDQUFDO1FBQ3hFLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxFQUFFLENBQUMsRUFBVTtRQUNoQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxLQUFLLENBQUMsR0FBRyxLQUFpQjs7UUFDN0IsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLDBDQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDOUUsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGdCQUFnQixDQUFDLElBQVksRUFBRSxRQUE4Qjs7UUFDaEUsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQiwwQ0FBRSxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBZSxFQUFFLE9BQWdCO1FBQzFDLE9BQU8sSUFBSSxnQkFBZ0IsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDOUQsT0FBTyxDQUFDLE9BQU8sYUFBUCxPQUFPLGNBQVAsT0FBTyxHQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sYUFBTixNQUFNLGNBQU4sTUFBTSxHQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFnQixFQUFFLEVBQVUsRUFBRSxVQUEyQjtRQUdsRSxPQUFPLElBQUksWUFBWSxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFDdkQsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVNLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsVUFBMkI7UUFDN0UsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUNqRSxDQUFDO0NBQ0o7QUExRkQsNENBMEZDO0FBRUQ7OztHQUdHO0FBQ0gsTUFBYSxZQUFhLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFZdkMsWUFBWSxLQUFnQixFQUFFLGNBQWlDLEVBQUUsS0FBc0I7O1FBQ25GLEtBQUssQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLEVBQUUsRUFBRSxJQUFBLHlCQUFpQixFQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNqRixJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRW5DLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVuRSxJQUFJLFdBQVcsR0FBcUIsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWpGLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDZCxXQUFXLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxJQUFJLGlCQUFXLEVBQUUsQ0FBQyxDQUFDO1NBQ2pGO1FBRUQsTUFBTSxPQUFPLEdBQUcsTUFBQSxjQUFjLENBQUMsT0FBTyxtQ0FBSSwyQkFBaUIsQ0FBQyxLQUFLLENBQUM7UUFDbEUsTUFBTSxlQUFlLEdBQUcsTUFBQSxjQUFjLENBQUMsZUFBZSxtQ0FBSSxJQUFJLHlDQUFrQixDQUFDO1lBQzdFLEVBQUUsRUFBRSxHQUFHLE1BQUEsY0FBYyxDQUFDLElBQUksbUNBQUksY0FBYyxDQUFDLEVBQUUsS0FBSztZQUNwRCxPQUFPO1NBQ1YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFdBQVcsR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxXQUFZLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRXJELElBQUksY0FBYyxHQUF5QixjQUFjLENBQUMsMEJBQTBCLENBQUM7UUFDckYsSUFBSSxjQUFjLEVBQUU7WUFDaEIsSUFBQSwyQkFBbUIsRUFBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLENBQUM7U0FDakc7UUFFRCxNQUFNLG1CQUFtQixHQUFHLEtBQUssRUFBeUIsQ0FBQztRQUUzRCxLQUFLLElBQUksS0FBSyxJQUFJLENBQUMsTUFBQSxjQUFjLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUMsRUFBRSxFQUFFLG1DQUFtQztZQUNsRixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUM5QyxJQUFJLE1BQU0sRUFBRTtnQkFDUixNQUFNLFFBQVEsR0FBRyxJQUFBLHdCQUFnQixFQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUN4RDtZQUNELE1BQU0sVUFBVSxHQUFRLEtBQUssQ0FBQztZQUM5QixJQUFLLFVBQW9DLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRTtnQkFDaEUsbUJBQW1CLENBQUMsSUFBSSxDQUF3QixVQUFVLENBQUMsQ0FBQzthQUMvRDtTQUNKO1FBRUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ2pFLE1BQU0sU0FBUyxHQUFHLENBQUMsR0FBRyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM5QyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFMUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFOztZQUN4RCxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUNwQyxJQUFJLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN0RSxDQUFDLENBQUMsQ0FBQztZQUVILElBQUksY0FBYyxDQUFDLEtBQUssSUFBSSxJQUFJLEVBQUU7Z0JBQzlCLEtBQUssSUFBSSxJQUFJLElBQUksY0FBYyxDQUFDLEtBQUssRUFBRTtvQkFDbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7aUJBQ2hDO2FBQ0o7WUFFRCxLQUFLLElBQUksSUFBSSxJQUFJLG1CQUFtQixFQUFFO2dCQUNsQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsTUFBQSxjQUFjLENBQUMsS0FBSyxtQ0FBSSxFQUFFLENBQUMsQ0FBQzthQUNqRTtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQXBFTSxNQUFNLENBQUMsT0FBTztRQUNqQixPQUFPLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBb0VEOzs7O09BSUc7SUFDSSxLQUFLLENBQUMsaUJBQWlCO1FBQzFCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDN0IsT0FBTyxJQUFJLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUNELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGNBQWM7UUFDVixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVPLHFCQUFxQixDQUFDLGNBQWlDOztRQUMzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBRTdELEtBQUssSUFBSSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFBLGNBQWMsQ0FBQyxpQkFBaUIsbUNBQUksRUFBRSxFQUFFO1lBQzdELE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzFCO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUNPLGFBQWEsQ0FBQyxjQUFpQztRQUNuRCxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ3BDLElBQUEsMkJBQW1CLEVBQUMsSUFBSSx5QkFBeUIsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDM0YsSUFBSSxjQUFjLENBQUMsS0FBSyxFQUFFO1lBQ3RCLGNBQWMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUM3QixJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksK0JBQStCLENBQUMsQ0FBQztpQkFDbEU7Z0JBQ0QsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUIsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7O0FBekhMLG9DQTBIQztBQXhIbUIscUJBQVEsR0FBRyxjQUFjLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgSVZwYyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHsgS3ViZXJuZXRlc1ZlcnNpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgY2xvbmVEZWVwLCBDb25zdHJhaW50c1R5cGUgfSBmcm9tIFwiLi4vdXRpbHNcIjtcbmltcG9ydCB7IE1uZ0NsdXN0ZXJQcm92aWRlciB9IGZyb20gJy4uL2NsdXN0ZXItcHJvdmlkZXJzL21uZy1jbHVzdGVyLXByb3ZpZGVyJztcbmltcG9ydCB7IFZwY1Byb3ZpZGVyIH0gZnJvbSAnLi4vcmVzb3VyY2UtcHJvdmlkZXJzL3ZwYyc7XG5pbXBvcnQgKiBhcyBzcGkgZnJvbSAnLi4vc3BpJztcbmltcG9ydCB7IGdldEFkZE9uTmFtZU9ySWQsIHNldHVwQ2x1c3RlckxvZ2dpbmcsIHdpdGhVc2FnZVRyYWNraW5nIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgU3RyaW5nQ29uc3RyYWludCwgdmFsaWRhdGVDb25zdHJhaW50cyB9IGZyb20gJy4uL3V0aWxzJztcblxuZXhwb3J0IGNsYXNzIEVrc0JsdWVwcmludFByb3BzIHtcbiAgICAvKipcbiAgICAgKiBUaGUgaWQgZm9yIHRoZSBibHVlcHJpbnQuXG4gICAgICovXG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERlZmF1bHRzIHRvIGlkIGlmIG5vdCBwcm92aWRlZFxuICAgICAqL1xuICAgIHJlYWRvbmx5IG5hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBZGQtb25zIGlmIGFueS5cbiAgICAgKi9cbiAgICByZWFkb25seSBhZGRPbnM/OiBBcnJheTxzcGkuQ2x1c3RlckFkZE9uPiA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogVGVhbXMgaWYgYW55XG4gICAgICovXG4gICAgcmVhZG9ubHkgdGVhbXM/OiBBcnJheTxzcGkuVGVhbT4gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIEVDMiBvciBGYXJnYXRlIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGJsdWVwcmludCBidXQgYW55IGltcGxlbWVudGF0aW9uIGNvbmZvcm1pbmcgdGhlIGludGVyZmFjZVxuICAgICAqIHdpbGwgd29ya1xuICAgICAqL1xuICAgIHJlYWRvbmx5IGNsdXN0ZXJQcm92aWRlcj86IHNwaS5DbHVzdGVyUHJvdmlkZXIgPSBuZXcgTW5nQ2x1c3RlclByb3ZpZGVyKCk7XG5cbiAgICAvKipcbiAgICAgKiBLdWJlcm5ldGVzIHZlcnNpb24gKG11c3QgYmUgaW5pdGlhbGl6ZWQgZm9yIGFkZG9ucyB0byB3b3JrIHByb3Blcmx5KVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHZlcnNpb24/OiBLdWJlcm5ldGVzVmVyc2lvbiA9IEt1YmVybmV0ZXNWZXJzaW9uLlYxXzIxO1xuXG4gICAgLyoqXG4gICAgICogTmFtZWQgcmVzb3VyY2UgcHJvdmlkZXJzIHRvIGxldmVyYWdlIGZvciBjbHVzdGVyIHJlc291cmNlcy5cbiAgICAgKiBUaGUgcmVzb3VyY2UgY2FuIHJlcHJlc2VudCBWcGMsIEhvc3RpbmcgWm9uZXMgb3Igb3RoZXIgcmVzb3VyY2VzLCBzZWUge0BsaW5rIHNwaS5SZXNvdXJjZVR5cGV9LlxuICAgICAqIFZQQyBmb3IgdGhlIGNsdXN0ZXIgY2FuIGJlIHJlZ2lzdGVyZWQgdW5kZXIgdGhlIG5hbWUgb2YgJ3ZwYycgb3IgYXMgYSBzaW5nbGUgcHJvdmlkZXIgb2YgdHlwZSBcbiAgICAgKi9cbiAgICByZXNvdXJjZVByb3ZpZGVycz86IE1hcDxzdHJpbmcsIHNwaS5SZXNvdXJjZVByb3ZpZGVyPiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIENvbnRyb2wgUGxhbmUgbG9nIHR5cGVzIHRvIGJlIGVuYWJsZWQgKGlmIG5vdCBwYXNzZWQsIG5vbmUpXG4gICAgICogSWYgd3JvbmcgdHlwZXMgYXJlIGluY2x1ZGVkLCB3aWxsIHRocm93IGFuIGVycm9yLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGVuYWJsZUNvbnRyb2xQbGFuZUxvZ1R5cGVzPzogQ29udHJvbFBsYW5lTG9nVHlwZVtdO1xufVxuXG5leHBvcnQgY2xhc3MgQmx1ZXByaW50UHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIENvbnN0cmFpbnRzVHlwZTxFa3NCbHVlcHJpbnRQcm9wcz4ge1xuICAgIC8qKlxuICAgICogaWQgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgaWQgPSBuZXcgU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG5cbiAgICAvKipcbiAgICAqIG5hbWUgY2FuIGJlIG5vIGxlc3MgdGhhbiAxIGNoYXJhY3RlciBsb25nLCBhbmQgbm8gZ3JlYXRlciB0aGFuIDYzIGNoYXJhY3RlcnMgbG9uZy5cbiAgICAqIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL292ZXJ2aWV3L3dvcmtpbmctd2l0aC1vYmplY3RzL25hbWVzL1xuICAgICovXG4gICAgbmFtZSA9IG5ldyBTdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcbn1cblxuZXhwb3J0IGNvbnN0IGVudW0gQ29udHJvbFBsYW5lTG9nVHlwZSB7XG5cbiAgICBBUEkgPSAnYXBpJyxcbiAgICBBVURJVCA9ICdhdWRpdCcsXG4gICAgQVVUSEVOVElDQVRPUiA9ICdhdXRoZW50aWNhdG9yJyxcbiAgICBDT05UUk9MTEVSX01BTkFHRVIgPSAnY29udHJvbGxlck1hbmFnZXInLFxuICAgIFNDSEVEVUxFUiA9ICdzY2hlZHVsZXInXG59XG5cbi8qKlxuICogQmx1ZXByaW50IGJ1aWxkZXIgaW1wbGVtZW50cyBhIGJ1aWxkZXIgcGF0dGVybiB0aGF0IGltcHJvdmVzIHJlYWRhYmlsaXR5IChubyBibG9hdGVkIGNvbnN0cnVjdG9ycylcbiAqIGFuZCBhbGxvd3MgY3JlYXRpbmcgYSBibHVlcHJpbnQgaW4gYW4gYWJzdHJhY3Qgc3RhdGUgdGhhdCBjYW4gYmUgYXBwbGllZCB0byB2YXJpb3VzIGluc3RhbnRpYXRpb25zIFxuICogaW4gYWNjb3VudHMgYW5kIHJlZ2lvbnMuIFxuICovXG5leHBvcnQgY2xhc3MgQmx1ZXByaW50QnVpbGRlciBpbXBsZW1lbnRzIHNwaS5Bc3luY1N0YWNrQnVpbGRlciB7XG5cbiAgICBwcm9wczogUGFydGlhbDxFa3NCbHVlcHJpbnRQcm9wcz47XG4gICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ/OiBzdHJpbmcsXG4gICAgICAgIHJlZ2lvbj86IHN0cmluZ1xuICAgIH07XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgYWRkT25zOiBuZXcgQXJyYXk8c3BpLkNsdXN0ZXJBZGRPbj4oKSwgdGVhbXM6IG5ldyBBcnJheTxzcGkuVGVhbT4oKSwgcmVzb3VyY2VQcm92aWRlcnM6IG5ldyBNYXAoKSB9O1xuICAgICAgICB0aGlzLmVudiA9IHtcbiAgICAgICAgICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgICAgICAgICByZWdpb246IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX1JFR0lPTlxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBuYW1lKG5hbWU6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IG5hbWUgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYWNjb3VudChhY2NvdW50Pzogc3RyaW5nKTogdGhpcyB7XG4gICAgICAgIHRoaXMuZW52LmFjY291bnQgPSBhY2NvdW50O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVnaW9uKHJlZ2lvbj86IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLmVudi5yZWdpb24gPSByZWdpb247XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB2ZXJzaW9uKHZlcnNpb246IEt1YmVybmV0ZXNWZXJzaW9uKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgdmVyc2lvbiB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBlbmFibGVDb250cm9sUGxhbmVMb2dUeXBlcyguLi50eXBlczogQ29udHJvbFBsYW5lTG9nVHlwZVtdKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgZW5hYmxlQ29udHJvbFBsYW5lTG9nVHlwZXM6IHR5cGVzIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhCbHVlcHJpbnRQcm9wcyhwcm9wczogUGFydGlhbDxFa3NCbHVlcHJpbnRQcm9wcz4pOiB0aGlzIHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2VQcm92aWRlcnMgPSB0aGlzLnByb3BzLnJlc291cmNlUHJvdmlkZXJzITtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4uY2xvbmVEZWVwKHByb3BzKSB9O1xuICAgICAgICBpZiAocHJvcHMucmVzb3VyY2VQcm92aWRlcnMpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVzb3VyY2VQcm92aWRlcnMgPSBuZXcgTWFwKFsuLi5yZXNvdXJjZVByb3ZpZGVycyEuZW50cmllcygpLCAuLi5wcm9wcy5yZXNvdXJjZVByb3ZpZGVycy5lbnRyaWVzKCldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkT25zKC4uLmFkZE9uczogc3BpLkNsdXN0ZXJBZGRPbltdKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgYWRkT25zOiB0aGlzLnByb3BzLmFkZE9ucz8uY29uY2F0KGFkZE9ucykgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgY2x1c3RlclByb3ZpZGVyKGNsdXN0ZXJQcm92aWRlcjogc3BpLkNsdXN0ZXJQcm92aWRlcikge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IGNsdXN0ZXJQcm92aWRlcjogY2x1c3RlclByb3ZpZGVyIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGlkKGlkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBpZCB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB0ZWFtcyguLi50ZWFtczogc3BpLlRlYW1bXSk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IHRlYW1zOiB0aGlzLnByb3BzLnRlYW1zPy5jb25jYXQodGVhbXMpIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc291cmNlUHJvdmlkZXIobmFtZTogc3RyaW5nLCBwcm92aWRlcjogc3BpLlJlc291cmNlUHJvdmlkZXIpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcy5yZXNvdXJjZVByb3ZpZGVycz8uc2V0KG5hbWUsIHByb3ZpZGVyKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGNsb25lKHJlZ2lvbj86IHN0cmluZywgYWNjb3VudD86IHN0cmluZyk6IEJsdWVwcmludEJ1aWxkZXIge1xuICAgICAgICByZXR1cm4gbmV3IEJsdWVwcmludEJ1aWxkZXIoKS53aXRoQmx1ZXByaW50UHJvcHMoeyAuLi50aGlzLnByb3BzIH0pXG4gICAgICAgICAgICAuYWNjb3VudChhY2NvdW50ID8/IHRoaXMuZW52LmFjY291bnQpLnJlZ2lvbihyZWdpb24gPz8gdGhpcy5lbnYucmVnaW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYnVpbGQoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgc3RhY2tQcm9wcz86IGNkay5TdGFja1Byb3BzKTogRWtzQmx1ZXByaW50IHtcblxuXG4gICAgICAgIHJldHVybiBuZXcgRWtzQmx1ZXByaW50KHNjb3BlLCB7IC4uLnRoaXMucHJvcHMsIC4uLnsgaWQgfSB9LFxuICAgICAgICAgICAgeyAuLi57IGVudjogdGhpcy5lbnYgfSwgLi4uc3RhY2tQcm9wcyB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgYnVpbGRBc3luYyhzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBzdGFja1Byb3BzPzogY2RrLlN0YWNrUHJvcHMpOiBQcm9taXNlPEVrc0JsdWVwcmludD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5idWlsZChzY29wZSwgaWQsIHN0YWNrUHJvcHMpLndhaXRGb3JBc3luY1Rhc2tzKCk7XG4gICAgfVxufVxuXG4vKipcbiAqIEVudHJ5IHBvaW50IHRvIHRoZSBwbGF0Zm9ybSBwcm92aXNpb25pbmcuIENyZWF0ZXMgYSBDRk4gc3RhY2sgYmFzZWQgb24gdGhlIHByb3ZpZGVkIGNvbmZpZ3VyYXRpb25cbiAqIGFuZCBvcmNoZXN0cmF0ZXMgcHJvdmlzaW9uaW5nIG9mIGFkZC1vbnMsIHRlYW1zIGFuZCBwb3N0IGRlcGxveW1lbnQgaG9va3MuIFxuICovXG5leHBvcnQgY2xhc3MgRWtzQmx1ZXByaW50IGV4dGVuZHMgY2RrLlN0YWNrIHtcblxuICAgIHN0YXRpYyByZWFkb25seSBVU0FHRV9JRCA9IFwicXMtMXMxcjQ2NWhrXCI7XG5cbiAgICBwcml2YXRlIGFzeW5jVGFza3M6IFByb21pc2U8dm9pZCB8IENvbnN0cnVjdFtdPjtcblxuICAgIHByaXZhdGUgY2x1c3RlckluZm86IHNwaS5DbHVzdGVySW5mbztcblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRlcigpOiBCbHVlcHJpbnRCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCbHVlcHJpbnRCdWlsZGVyKCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgYmx1ZXByaW50UHJvcHM6IEVrc0JsdWVwcmludFByb3BzLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBibHVlcHJpbnRQcm9wcy5pZCwgd2l0aFVzYWdlVHJhY2tpbmcoRWtzQmx1ZXByaW50LlVTQUdFX0lELCBwcm9wcykpO1xuICAgICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoYmx1ZXByaW50UHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHJlc291cmNlQ29udGV4dCA9IHRoaXMucHJvdmlkZU5hbWVkUmVzb3VyY2VzKGJsdWVwcmludFByb3BzKTtcblxuICAgICAgICBsZXQgdnBjUmVzb3VyY2U6IElWcGMgfCB1bmRlZmluZWQgPSByZXNvdXJjZUNvbnRleHQuZ2V0KHNwaS5HbG9iYWxSZXNvdXJjZXMuVnBjKTtcblxuICAgICAgICBpZiAoIXZwY1Jlc291cmNlKSB7XG4gICAgICAgICAgICB2cGNSZXNvdXJjZSA9IHJlc291cmNlQ29udGV4dC5hZGQoc3BpLkdsb2JhbFJlc291cmNlcy5WcGMsIG5ldyBWcGNQcm92aWRlcigpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZlcnNpb24gPSBibHVlcHJpbnRQcm9wcy52ZXJzaW9uID8/IEt1YmVybmV0ZXNWZXJzaW9uLlYxXzIxO1xuICAgICAgICBjb25zdCBjbHVzdGVyUHJvdmlkZXIgPSBibHVlcHJpbnRQcm9wcy5jbHVzdGVyUHJvdmlkZXIgPz8gbmV3IE1uZ0NsdXN0ZXJQcm92aWRlcih7XG4gICAgICAgICAgICBpZDogYCR7Ymx1ZXByaW50UHJvcHMubmFtZSA/PyBibHVlcHJpbnRQcm9wcy5pZH0tbmdgLFxuICAgICAgICAgICAgdmVyc2lvblxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNsdXN0ZXJJbmZvID0gY2x1c3RlclByb3ZpZGVyLmNyZWF0ZUNsdXN0ZXIodGhpcywgdnBjUmVzb3VyY2UhKTtcbiAgICAgICAgdGhpcy5jbHVzdGVySW5mby5zZXRSZXNvdXJjZUNvbnRleHQocmVzb3VyY2VDb250ZXh0KTtcblxuICAgICAgICBsZXQgZW5hYmxlTG9nVHlwZXM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkID0gYmx1ZXByaW50UHJvcHMuZW5hYmxlQ29udHJvbFBsYW5lTG9nVHlwZXM7XG4gICAgICAgIGlmIChlbmFibGVMb2dUeXBlcykge1xuICAgICAgICAgICAgc2V0dXBDbHVzdGVyTG9nZ2luZyh0aGlzLmNsdXN0ZXJJbmZvLmNsdXN0ZXIuc3RhY2ssIHRoaXMuY2x1c3RlckluZm8uY2x1c3RlciwgZW5hYmxlTG9nVHlwZXMpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcG9zdERlcGxveW1lbnRTdGVwcyA9IEFycmF5PHNwaS5DbHVzdGVyUG9zdERlcGxveT4oKTtcblxuICAgICAgICBmb3IgKGxldCBhZGRPbiBvZiAoYmx1ZXByaW50UHJvcHMuYWRkT25zID8/IFtdKSkgeyAvLyBtdXN0IGl0ZXJhdGUgaW4gdGhlIHN0cmljdCBvcmRlclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYWRkT24uZGVwbG95KHRoaXMuY2x1c3RlckluZm8pO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFkZE9uS2V5ID0gZ2V0QWRkT25OYW1lT3JJZChhZGRPbik7XG4gICAgICAgICAgICAgICAgdGhpcy5jbHVzdGVySW5mby5hZGRTY2hlZHVsZWRBZGRPbihhZGRPbktleSwgcmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHBvc3REZXBsb3k6IGFueSA9IGFkZE9uO1xuICAgICAgICAgICAgaWYgKChwb3N0RGVwbG95IGFzIHNwaS5DbHVzdGVyUG9zdERlcGxveSkucG9zdERlcGxveSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcG9zdERlcGxveW1lbnRTdGVwcy5wdXNoKDxzcGkuQ2x1c3RlclBvc3REZXBsb3k+cG9zdERlcGxveSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzY2hlZHVsZWRBZGRPbnMgPSB0aGlzLmNsdXN0ZXJJbmZvLmdldEFsbFNjaGVkdWxlZEFkZG9ucygpO1xuICAgICAgICBjb25zdCBhZGRPbktleXMgPSBbLi4uc2NoZWR1bGVkQWRkT25zLmtleXMoKV07XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gc2NoZWR1bGVkQWRkT25zLnZhbHVlcygpO1xuXG4gICAgICAgIHRoaXMuYXN5bmNUYXNrcyA9IFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKChjb25zdHJ1Y3RzKSA9PiB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RzLmZvckVhY2goKGNvbnN0cnVjdCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsdXN0ZXJJbmZvLmFkZFByb3Zpc2lvbmVkQWRkT24oYWRkT25LZXlzW2luZGV4XSwgY29uc3RydWN0KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoYmx1ZXByaW50UHJvcHMudGVhbXMgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHRlYW0gb2YgYmx1ZXByaW50UHJvcHMudGVhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVhbS5zZXR1cCh0aGlzLmNsdXN0ZXJJbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IHN0ZXAgb2YgcG9zdERlcGxveW1lbnRTdGVwcykge1xuICAgICAgICAgICAgICAgIHN0ZXAucG9zdERlcGxveSh0aGlzLmNsdXN0ZXJJbmZvLCBibHVlcHJpbnRQcm9wcy50ZWFtcyA/PyBbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXN5bmNUYXNrcy5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNpbmNlIGNvbnN0cnVjdG9yIGNhbm5vdCBiZSBtYXJrZWQgYXMgYXN5bmMsIGFkZGluZyBhIHNlcGFyYXRlIG1ldGhvZCB0byB3YWl0XG4gICAgICogZm9yIGFzeW5jIGNvZGUgdG8gZmluaXNoLiBcbiAgICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gdGhlIGJsdWVwcmludFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyB3YWl0Rm9yQXN5bmNUYXNrcygpOiBQcm9taXNlPEVrc0JsdWVwcmludD4ge1xuICAgICAgICBpZiAodGhpcy5hc3luY1Rhc2tzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hc3luY1Rhc2tzLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGFsbCB0aGUgY29uc3RydWN0cyBwcm9kdWNlZCBieSBkdXJpbmcgdGhlIGNsdXN0ZXIgY3JlYXRpb24gKGUuZy4gYWRkLW9ucykuXG4gICAgICogTWF5IGJlIHVzZWQgaW4gdGVzdGluZyBmb3IgdmVyaWZpY2F0aW9uLlxuICAgICAqIEByZXR1cm5zIGNsdXN0ZXIgaW5mbyBvYmplY3RcbiAgICAgKi9cbiAgICBnZXRDbHVzdGVySW5mbygpOiBzcGkuQ2x1c3RlckluZm8ge1xuICAgICAgICByZXR1cm4gdGhpcy5jbHVzdGVySW5mbztcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb3ZpZGVOYW1lZFJlc291cmNlcyhibHVlcHJpbnRQcm9wczogRWtzQmx1ZXByaW50UHJvcHMpOiBzcGkuUmVzb3VyY2VDb250ZXh0IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IHNwaS5SZXNvdXJjZUNvbnRleHQodGhpcywgYmx1ZXByaW50UHJvcHMpO1xuXG4gICAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBibHVlcHJpbnRQcm9wcy5yZXNvdXJjZVByb3ZpZGVycyA/PyBbXSkge1xuICAgICAgICAgICAgcmVzdWx0LmFkZChrZXksIHZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHByaXZhdGUgdmFsaWRhdGVJbnB1dChibHVlcHJpbnRQcm9wczogRWtzQmx1ZXByaW50UHJvcHMpIHtcbiAgICAgICAgY29uc3QgdGVhbU5hbWVzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgICAgIHZhbGlkYXRlQ29uc3RyYWludHMobmV3IEJsdWVwcmludFByb3BzQ29uc3RyYWludHMsIEVrc0JsdWVwcmludFByb3BzLm5hbWUsIGJsdWVwcmludFByb3BzKTtcbiAgICAgICAgaWYgKGJsdWVwcmludFByb3BzLnRlYW1zKSB7XG4gICAgICAgICAgICBibHVlcHJpbnRQcm9wcy50ZWFtcy5mb3JFYWNoKGUgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0ZWFtTmFtZXMuaGFzKGUubmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZWFtICR7ZS5uYW1lfSBpcyByZWdpc3RlcmVkIG1vcmUgdGhhbiBvbmNlYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRlYW1OYW1lcy5hZGQoZS5uYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufSJdfQ==